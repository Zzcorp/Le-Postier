<!-- templates/admin_dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}Tableau de Bord Admin{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                </svg>
            </div>
            <div class="header-text">
                <h1>Tableau de Bord Administrateur</h1>
                <p>Bienvenue, <strong>{{ user.username }}</strong> ‚Ä¢ {{ "now"|date:"l d F Y, H:i" }}</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="refresh-btn" onclick="location.reload()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Actualiser
            </button>
            <a href="/admin/" class="admin-link-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Django Admin
            </a>
        </div>
    </header>

    <!-- Real-Time Section -->
    <section class="realtime-section">
        <div class="realtime-card">
            <div class="realtime-indicator">
                <span class="pulse-dot"></span>
                <span>EN DIRECT</span>
            </div>
            <div class="realtime-stats">
                <div class="realtime-stat">
                    <span class="realtime-number" id="activeVisitorCount">{{ active_visitor_count }}</span>
                    <span class="realtime-label">Visiteurs actifs</span>
                </div>
                <div class="realtime-visitors-list" id="activeVisitorsList">
                    {% for visitor in active_visitors_list %}
                    <div class="active-visitor" onclick="lookupIP('{{ visitor.ip_address }}')">
                        <span class="visitor-flag">{{ visitor.flag|default:"üåç" }}</span>
                        <span class="visitor-country">{{ visitor.country|default:"Inconnu" }}</span>
                        <span class="visitor-city">{{ visitor.city|default:"" }}</span>
                        <span class="visitor-page" title="{{ visitor.current_page }}">{{ visitor.page_title|truncatechars:25 }}</span>
                        <span class="visitor-device">{{ visitor.device_type }}</span>
                        <span class="visitor-browser">{{ visitor.browser }}</span>
                        {% if visitor.user__username %}
                        <span class="visitor-user">üë§ {{ visitor.user__username }}</span>
                        {% endif %}
                        <span class="visitor-ip">{{ visitor.ip_address }}</span>
                    </div>
                    {% empty %}
                    <p class="no-visitors">Aucun visiteur actif en ce moment</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Stats Grid -->
    <section class="quick-stats-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Vue d'ensemble
        </h2>
        <div class="quick-stats-grid">
            <!-- Users Stats -->
            <div class="stat-card stat-users">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ total_users }}</span>
                    <span class="stat-label">Utilisateurs</span>
                    <div class="stat-details">
                        <span class="stat-change {% if user_growth_percent >= 0 %}positive{% else %}negative{% endif %}">
                            {% if user_growth_percent >= 0 %}+{% endif %}{{ user_growth_percent }}% vs hier
                        </span>
                        <span class="stat-sub">+{{ new_users_today }} aujourd'hui ‚Ä¢ +{{ new_users_week }} cette semaine</span>
                    </div>
                </div>
            </div>

            <!-- Page Views Stats -->
            <div class="stat-card stat-views">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ page_views_today }}</span>
                    <span class="stat-label">Vues aujourd'hui</span>
                    <div class="stat-details">
                        <span class="stat-change {% if views_growth_percent >= 0 %}positive{% else %}negative{% endif %}">
                            {% if views_growth_percent >= 0 %}+{% endif %}{{ views_growth_percent }}% vs hier
                        </span>
                        <span class="stat-sub">{{ unique_visitors_today }} visiteurs uniques</span>
                    </div>
                </div>
            </div>

            <!-- Sessions Stats -->
            <div class="stat-card stat-sessions">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ sessions_today }}</span>
                    <span class="stat-label">Sessions aujourd'hui</span>
                    <div class="stat-details">
                        <span class="stat-sub">{{ sessions_week }} cette semaine</span>
                        <span class="stat-sub">{{ week_over_week_change }}% vs semaine dern.</span>
                    </div>
                </div>
            </div>

            <!-- Likes Stats -->
            <div class="stat-card stat-likes">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ total_likes }}</span>
                    <span class="stat-label">Likes Total</span>
                    <div class="stat-details">
                        <span class="stat-change {% if likes_growth_percent >= 0 %}positive{% else %}negative{% endif %}">
                            {% if likes_growth_percent >= 0 %}+{% endif %}{{ likes_growth_percent }}% vs hier
                        </span>
                        <span class="stat-sub">+{{ likes_today }} aujourd'hui ‚Ä¢ +{{ likes_week }} cette semaine</span>
                    </div>
                </div>
            </div>

            <!-- Postcards Stats -->
            <div class="stat-card stat-postcards">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ total_postcards }}</span>
                    <span class="stat-label">Cartes Postales</span>
                    <div class="stat-details">
                        <span class="stat-sub">{{ postcards_with_images }} avec images</span>
                        <span class="stat-sub">{{ animated_postcards }} anim√©es</span>
                    </div>
                </div>
            </div>

            <!-- Searches Stats -->
            <div class="stat-card stat-searches">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ searches_today }}</span>
                    <span class="stat-label">Recherches aujourd'hui</span>
                    <div class="stat-details">
                        <span class="stat-sub">{{ searches_week }} cette semaine</span>
                        <span class="stat-sub">{{ total_searches }} total</span>
                    </div>
                </div>
            </div>

            <!-- Messages Stats -->
            <div class="stat-card stat-messages {% if unread_messages > 0 %}has-alert{% endif %}">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ total_messages }}</span>
                    <span class="stat-label">Messages</span>
                    <div class="stat-details">
                        {% if unread_messages > 0 %}
                        <span class="stat-change alert">{{ unread_messages }} non lus</span>
                        {% endif %}
                        <span class="stat-sub">{{ messages_today }} aujourd'hui</span>
                    </div>
                </div>
            </div>

            <!-- Suggestions Stats -->
            <div class="stat-card stat-suggestions {% if pending_suggestions > 0 %}has-alert{% endif %}">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18h6"/>
                        <path d="M10 22h4"/>
                        <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ total_suggestions }}</span>
                    <span class="stat-label">Suggestions</span>
                    <div class="stat-details">
                        {% if pending_suggestions > 0 %}
                        <span class="stat-change alert">{{ pending_suggestions }} en attente</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Performance Metrics -->
    <section class="performance-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            M√©triques de Performance
        </h2>
        <div class="performance-grid">
            <div class="performance-card">
                <div class="performance-icon bounce-rate">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                        <polyline points="17 6 23 6 23 12"/>
                    </svg>
                </div>
                <div class="performance-info">
                    <span class="performance-value">{{ bounce_rate }}%</span>
                    <span class="performance-label">Taux de rebond</span>
                    <span class="performance-desc">Sessions avec 1 seule page</span>
                </div>
                <div class="performance-bar">
                    <div class="performance-fill" style="width: {{ bounce_rate }}%"></div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-icon session-duration">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </div>
                <div class="performance-info">
                    <span class="performance-value">{{ avg_session_duration_formatted }}</span>
                    <span class="performance-label">Dur√©e moyenne session</span>
                    <span class="performance-desc">{{ avg_session_duration }} secondes</span>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-icon pages-session">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                </div>
                <div class="performance-info">
                    <span class="performance-value">{{ pages_per_session }}</span>
                    <span class="performance-label">Pages par session</span>
                    <span class="performance-desc">Moyenne des vues</span>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-icon week-change {% if week_over_week_change >= 0 %}positive{% else %}negative{% endif %}">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="{% if week_over_week_change >= 0 %}23 6 13.5 15.5 8.5 10.5 1 18{% else %}1 6 10.5 15.5 15.5 10.5 23 18{% endif %}"/>
                    </svg>
                </div>
                <div class="performance-info">
                    <span class="performance-value {% if week_over_week_change >= 0 %}positive{% else %}negative{% endif %}">
                        {% if week_over_week_change >= 0 %}+{% endif %}{{ week_over_week_change }}%
                    </span>
                    <span class="performance-label">Croissance hebdo</span>
                    <span class="performance-desc">vs semaine derni√®re</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="charts-section">
        <div class="charts-grid">
            <!-- Activity Chart -->
            <div class="chart-card chart-large">
                <div class="chart-header">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Activit√© des 30 derniers jours
                    </h3>
                    <div class="chart-legend">
                        <span class="legend-item legend-views">Vues</span>
                        <span class="legend-item legend-sessions">Sessions</span>
                        <span class="legend-item legend-searches">Recherches</span>
                        <span class="legend-item legend-likes">Likes</span>
                        <span class="legend-item legend-users">Nouveaux utilisateurs</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- Users Distribution Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                            <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                        </svg>
                        R√©partition Utilisateurs
                    </h3>
                </div>
                <div class="chart-container chart-small">
                    <canvas id="usersChart"></canvas>
                </div>
                <div class="chart-stats">
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #6c757d;"></span>
                        <span>Non v√©rifi√©s: {{ user_categories.unverified }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #28a745;"></span>
                        <span>V√©rifi√©s: {{ user_categories.verified }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #b5600b;"></span>
                        <span>Facteurs: {{ user_categories.postman }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #d1872c;"></span>
                        <span>Visiteurs: {{ user_categories.viewer }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #ffc168;"></span>
                        <span>Staff: {{ user_categories.staff }}</span>
                    </div>
                </div>
            </div>

            <!-- Device Distribution Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                        Appareils
                    </h3>
                </div>
                <div class="chart-container chart-small">
                    <canvas id="devicesChart"></canvas>
                </div>
                <div class="chart-stats">
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #17a2b8;"></span>
                        <span>üì± Mobile: {{ device_breakdown.mobile }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #28a745;"></span>
                        <span>üíª Desktop: {{ device_breakdown.desktop }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #ffc107;"></span>
                        <span>üì≤ Tablette: {{ device_breakdown.tablet }}</span>
                    </div>
                    <div class="chart-stat">
                        <span class="chart-stat-color" style="background: #6c757d;"></span>
                        <span>‚ùì Autre: {{ device_breakdown.other }}</span>
                    </div>
                </div>
            </div>

            <!-- Hourly Traffic Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Trafic par heure (aujourd'hui)
                    </h3>
                    {% if peak_hours %}
                    <span class="chart-subtitle">Pic: {{ peak_hours.0.hour }} ({{ peak_hours.0.count }} vues)</span>
                    {% endif %}
                </div>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Geographic Section -->
    <section class="geographic-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="2" y1="12" x2="22" y2="12"/>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
            </svg>
            G√©ographie des Visiteurs
        </h2>
        <div class="geographic-grid">
            <!-- Top Countries -->
            <div class="geo-card">
                <h3>üåç Top Pays (Tout temps)</h3>
                <div class="geo-list">
                    {% for country in top_countries %}
                    <div class="geo-item">
                        <span class="geo-flag">{{ country.flag }}</span>
                        <span class="geo-name">{{ country.country }}</span>
                        <span class="geo-count">{{ country.count }}</span>
                        <div class="geo-bar">
                            <div class="geo-bar-fill" style="width: {% widthratio country.count top_countries.0.count 100 %}%"></div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune donn√©e disponible</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Cities -->
            <div class="geo-card">
                <h3>üèôÔ∏è Top Villes</h3>
                <div class="geo-list">
                    {% for city in top_cities %}
                    <div class="geo-item">
                        <span class="geo-name">{{ city.city }}, {{ city.country }}</span>
                        <span class="geo-count">{{ city.count }}</span>
                        <div class="geo-bar">
                            <div class="geo-bar-fill" style="width: {% widthratio city.count top_cities.0.count 100 %}%"></div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune donn√©e disponible</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Likes by Country -->
            <div class="geo-card">
                <h3>‚ù§Ô∏è Likes par Pays</h3>
                <div class="geo-list">
                    {% for item in likes_by_country %}
                    <div class="geo-item">
                        <span class="geo-name">{{ item.country }}</span>
                        <span class="geo-count">{{ item.count }} likes</span>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucun like avec localisation</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Countries Today -->
            <div class="geo-card">
                <h3>üìÖ Pays aujourd'hui</h3>
                <div class="geo-list">
                    {% for country in countries_today %}
                    <div class="geo-item">
                        <span class="geo-flag">{{ country.flag }}</span>
                        <span class="geo-name">{{ country.country }}</span>
                        <span class="geo-count">{{ country.count }}</span>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucun visiteur aujourd'hui</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <!-- Traffic Sources & Browsers Section -->
    <section class="traffic-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            Sources de Trafic & Technologie
        </h2>
        <div class="traffic-grid">
            <!-- Traffic Type -->
            <div class="traffic-card">
                <h3>üìä Type de Trafic</h3>
                <div class="traffic-stats">
                    <div class="traffic-stat">
                        <span class="traffic-label">Direct</span>
                        <span class="traffic-value">{{ direct_traffic }}</span>
                    </div>
                    <div class="traffic-stat">
                        <span class="traffic-label">R√©f√©rent</span>
                        <span class="traffic-value">{{ referral_traffic }}</span>
                    </div>
                </div>
            </div>

            <!-- Top Referrers -->
            <div class="traffic-card traffic-card-large">
                <h3>üîó Top R√©f√©rents</h3>
                <div class="referrers-list">
                    {% for ref in top_referrers %}
                    <div class="referrer-item">
                        <span class="referrer-domain">{{ ref.referrer_domain }}</span>
                        <span class="referrer-count">{{ ref.count }} visites</span>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucun r√©f√©rent externe</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Browsers -->
            <div class="traffic-card">
                <h3>üåê Navigateurs</h3>
                <div class="browsers-list">
                    {% for browser in top_browsers %}
                    <div class="browser-item">
                        <span class="browser-name">{{ browser.browser }}</span>
                        <span class="browser-count">{{ browser.count }}</span>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune donn√©e</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top OS -->
            <div class="traffic-card">
                <h3>üíª Syst√®mes d'exploitation</h3>
                <div class="os-list">
                    {% for os in top_os %}
                    <div class="os-item">
                        <span class="os-name">{{ os.os }}</span>
                        <span class="os-count">{{ os.count }}</span>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune donn√©e</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <!-- Search Analytics Section -->
    <section class="search-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            Analytique des Recherches
        </h2>
        <div class="search-grid">
            <!-- Top Searches All Time -->
            <div class="search-card">
                <h3>üîù Top Recherches (Tout temps)</h3>
                <div class="search-list">
                    {% for search in top_searches_all %}
                    <div class="search-item">
                        <span class="search-keyword">{{ search.keyword }}</span>
                        <div class="search-stats">
                            <span class="search-count">{{ search.count }}x</span>
                            <span class="search-avg">~{{ search.avg_results|floatformat:0 }} r√©sultats</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune recherche enregistr√©e</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Top Searches Today -->
            <div class="search-card">
                <h3>üìÖ Recherches du jour</h3>
                <div class="search-list">
                    {% for search in top_searches_today %}
                    <div class="search-item">
                        <span class="search-keyword">{{ search.keyword }}</span>
                        <div class="search-stats">
                            <span class="search-count">{{ search.count }}x</span>
                            <span class="search-avg">~{{ search.avg_results|floatformat:0 }} r√©s.</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucune recherche aujourd'hui</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Zero Result Searches -->
            <div class="search-card search-card-alert">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Recherches sans r√©sultat
                </h3>
                <div class="search-list">
                    {% for search in zero_result_searches %}
                    <div class="search-item search-item-alert">
                        <span class="search-keyword">{{ search.keyword }}</span>
                        <span class="search-count">{{ search.count }}x</span>
                    </div>
                    {% empty %}
                    <p class="no-data success">Aucune recherche sans r√©sultat! üéâ</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <!-- Content Tabs Section -->
    <section class="tabs-section">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="showTab('likes')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                Likes D√©taill√©s
                <span class="tab-badge">{{ likes_today }}</span>
            </button>
            <button class="tab-btn" onclick="showTab('users')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Utilisateurs
            </button>
            <button class="tab-btn" onclick="showTab('postcards')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                Cartes Postales
            </button>
            <button class="tab-btn" onclick="showTab('suggestions')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18h6"/>
                    <path d="M10 22h4"/>
                    <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>
                </svg>
                Suggestions
                {% if pending_suggestions > 0 %}
                <span class="tab-badge">{{ pending_suggestions }}</span>
                {% endif %}
            </button>
            <button class="tab-btn" onclick="showTab('messages')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Messages
                {% if unread_messages > 0 %}
                <span class="tab-badge alert">{{ unread_messages }}</span>
                {% endif %}
            </button>
            <button class="tab-btn" onclick="showTab('ips')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                Adresses IP
            </button>
        </div>

        <!-- Likes Tab (Default) -->
        <div class="tab-content active" id="likes-tab">
            <div class="tab-header-bar">
                <h3>‚ù§Ô∏è Likes avec d√©tails complets</h3>
                <span class="tab-count">{{ total_likes }} total ‚Ä¢ {{ likes_today }} aujourd'hui</span>
            </div>
            <div class="table-container">
                <table class="admin-table likes-table">
                    <thead>
                        <tr>
                            <th>Carte</th>
                            <th>Type</th>
                            <th>Utilisateur</th>
                            <th>IP</th>
                            <th>Localisation</th>
                            <th>Appareil</th>
                            <th>Navigateur</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for like in recent_likes %}
                        <tr>
                            <td>
                                <a href="#" onclick="showPostcardAnalytics({{ like.postcard_id }}); return false;" class="postcard-link">
                                    N¬∞ {{ like.postcard_number }}
                                </a>
                            </td>
                            <td>
                                <span class="like-type-badge {% if like.is_animated %}animated{% else %}static{% endif %}">
                                    {% if like.is_animated %}üé¨ Anim√©{% else %}üñºÔ∏è Image{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if like.user != 'Anonyme' %}
                                <span class="user-badge">üë§ {{ like.user }}</span>
                                {% else %}
                                <span class="anonymous-badge">üïµÔ∏è Anonyme</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="#" onclick="lookupIP('{{ like.ip_address }}'); return false;" class="ip-link">
                                    {{ like.ip_address }}
                                </a>
                            </td>
                            <td>
                                <span class="location-badge">
                                    {{ like.flag }} {{ like.city }}, {{ like.country }}
                                </span>
                            </td>
                            <td>{{ like.device_type }}</td>
                            <td>{{ like.browser }}</td>
                            <td>{{ like.created_at }}</td>
                            <td>
                                <button class="btn-icon" onclick="lookupIP('{{ like.ip_address }}')" title="D√©tails IP">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="no-data">Aucun like enregistr√©</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button class="btn-primary" onclick="loadMoreLikes()">Charger plus de likes</button>
        </div>

        <!-- Users Tab -->
        <div class="tab-content" id="users-tab">
            <div class="tab-header-bar">
                <h3>üë• Gestion des Utilisateurs</h3>
                <div class="user-category-badges">
                    <span class="badge badge-unverified">Non v√©rifi√©s: {{ user_categories.unverified }}</span>
                    <span class="badge badge-verified">V√©rifi√©s: {{ user_categories.verified }}</span>
                    <span class="badge badge-postman">Facteurs: {{ user_categories.postman }}</span>
                    <span class="badge badge-viewer">Visiteurs: {{ user_categories.viewer }}</span>
                    <span class="badge badge-staff">Staff: {{ user_categories.staff }}</span>
                </div>
            </div>
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>Email</th>
                            <th>Cat√©gorie</th>
                            <th>V√©rifi√©</th>
                            <th>Staff</th>
                            <th>IP Inscription</th>
                            <th>Localisation</th>
                            <th>Inscrit le</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in recent_users %}
                        <tr data-user-id="{{ u.id }}">
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar">{{ u.username|slice:":1"|upper }}</div>
                                    <span>{{ u.username }}</span>
                                </div>
                            </td>
                            <td>{{ u.email }}</td>
                            <td>
                                <select class="category-select" onchange="updateUserCategory({{ u.id }}, this.value)">
                                    {% for value, label in user_categories_choices %}
                                    <option value="{{ value }}" {% if u.category == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <span class="badge {% if u.email_verified %}badge-success{% else %}badge-muted{% endif %}">
                                    {{ u.email_verified|yesno:"‚úì,‚úó" }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if u.is_staff %}badge-success{% else %}badge-muted{% endif %}">
                                    {{ u.is_staff|yesno:"‚úì,‚úó" }}
                                </span>
                            </td>
                            <td>
                                {% if u.registration_ip != 'N/A' %}
                                <a href="#" onclick="lookupIP('{{ u.registration_ip }}'); return false;" class="ip-link">
                                    {{ u.registration_ip }}
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>{{ u.city }}{% if u.city and u.country %}, {% endif %}{{ u.country }}</td>
                            <td>{{ u.date_joined|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if not u.is_superuser %}
                                <button class="btn-icon btn-danger" onclick="deleteUser({{ u.id }}, '{{ u.username }}')" title="Supprimer">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button class="btn-primary" onclick="loadAllUsers()">Charger tous les utilisateurs</button>
        </div>

        <!-- Postcards Tab -->
        <div class="tab-content" id="postcards-tab">
            <div class="tab-header-bar">
                <h3>üñºÔ∏è Gestion des Cartes Postales</h3>
                <div class="postcards-summary">
                    <span>{{ total_postcards }} cartes ‚Ä¢ {{ postcards_with_images }} avec images ‚Ä¢ {{ animated_postcards }} anim√©es</span>
                </div>
            </div>
            
            <!-- Top Postcards Display -->
            <div class="postcards-preview">
                <h4>üèÜ Top 15 - Plus vues</h4>
                <div class="postcards-scroll">
                    {% for p in top_viewed_postcards %}
                    <div class="postcard-mini" onclick="showPostcardAnalytics({{ p.id }})">
                        <span class="postcard-rank">#{{ forloop.counter }}</span>
                        <span class="postcard-number">N¬∞ {{ p.number }}</span>
                        <span class="postcard-views">üëÅÔ∏è {{ p.views_count }}</span>
                        <span class="postcard-likes">‚ù§Ô∏è {{ p.likes_count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="postcards-preview">
                <h4>‚ù§Ô∏è Top 15 - Plus aim√©es</h4>
                <div class="postcards-scroll">
                    {% for p in top_liked_postcards %}
                    <div class="postcard-mini" onclick="showPostcardAnalytics({{ p.id }})">
                        <span class="postcard-rank">#{{ forloop.counter }}</span>
                        <span class="postcard-number">N¬∞ {{ p.number }}</span>
                        <span class="postcard-likes">‚ù§Ô∏è {{ p.likes_count }}</span>
                        <span class="postcard-views">üëÅÔ∏è {{ p.views_count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Rarity Stats -->
            <div class="rarity-stats">
                <h4>üìä Statistiques par raret√©</h4>
                <div class="rarity-grid">
                    <div class="rarity-card rarity-common">
                        <span class="rarity-label">Communes</span>
                        <span class="rarity-count">{{ rarity_stats.common.count }} cartes</span>
                        <span class="rarity-views">üëÅÔ∏è {{ rarity_stats.common.total_views }} vues</span>
                        <span class="rarity-likes">‚ù§Ô∏è {{ rarity_stats.common.total_likes }} likes</span>
                    </div>
                    <div class="rarity-card rarity-rare">
                        <span class="rarity-label">Rares</span>
                        <span class="rarity-count">{{ rarity_stats.rare.count }} cartes</span>
                        <span class="rarity-views">üëÅÔ∏è {{ rarity_stats.rare.total_views }} vues</span>
                        <span class="rarity-likes">‚ù§Ô∏è {{ rarity_stats.rare.total_likes }} likes</span>
                    </div>
                    <div class="rarity-card rarity-very-rare">
                        <span class="rarity-label">Tr√®s Rares</span>
                        <span class="rarity-count">{{ rarity_stats.very_rare.count }} cartes</span>
                        <span class="rarity-views">üëÅÔ∏è {{ rarity_stats.very_rare.total_views }} vues</span>
                        <span class="rarity-likes">‚ù§Ô∏è {{ rarity_stats.very_rare.total_likes }} likes</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container" id="postcards-table-container">
                <p class="load-prompt">Cliquez sur "Charger les cartes" pour afficher la liste compl√®te</p>
            </div>
            <button class="btn-primary" onclick="loadPostcards()">Charger les cartes postales</button>
        </div>

        <!-- Suggestions Tab -->
        <div class="tab-content" id="suggestions-tab">
            <div class="tab-header-bar">
                <h3>üí° Suggestions d'Animation</h3>
                <span class="tab-count">{{ total_suggestions }} total ‚Ä¢ {{ pending_suggestions }} en attente</span>
            </div>
            <div class="suggestions-list">
                {% for s in recent_suggestions %}
                <div class="suggestion-item {% if s.status == 'pending' %}pending{% elif s.status == 'approved' %}approved{% elif s.status == 'rejected' %}rejected{% endif %}" data-id="{{ s.id }}">
                    <div class="suggestion-header">
                        <span class="suggestion-postcard">
                            üñºÔ∏è N¬∞ {{ s.postcard.number }}
                        </span>
                        <span class="suggestion-user">
                            {% if s.user %}üë§ {{ s.user.username }}{% else %}üïµÔ∏è Anonyme{% endif %}
                        </span>
                        <span class="suggestion-date">{{ s.created_at|date:"d/m/Y H:i" }}</span>
                        <span class="suggestion-status status-{{ s.status }}">{{ s.get_status_display }}</span>
                    </div>
                    <p class="suggestion-description">{{ s.description }}</p>
                    <div class="suggestion-actions">
                        <select class="status-select" onchange="updateSuggestionStatus({{ s.id }}, this.value)">
                            <option value="pending" {% if s.status == 'pending' %}selected{% endif %}>En attente</option>
                            <option value="reviewed" {% if s.status == 'reviewed' %}selected{% endif %}>Examin√©</option>
                            <option value="approved" {% if s.status == 'approved' %}selected{% endif %}>Approuv√©</option>
                            <option value="rejected" {% if s.status == 'rejected' %}selected{% endif %}>Rejet√©</option>
                        </select>
                    </div>
                </div>
                {% empty %}
                <p class="no-data">Aucune suggestion pour le moment.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Messages Tab -->
        <div class="tab-content" id="messages-tab">
            <div class="tab-header-bar">
                <h3>üì¨ Messages de Contact</h3>
                <span class="tab-count">{{ total_messages }} total ‚Ä¢ {{ unread_messages }} non lus</span>
            </div>
            <div class="messages-list">
                {% for msg in recent_messages %}
                <div class="message-item {% if not msg.is_read %}unread{% endif %}">
                    <div class="message-header">
                        <span class="message-user">
                            {% if msg.user %}üë§ {{ msg.user.username }}{% else %}üïµÔ∏è Anonyme{% endif %}
                        </span>
                        <span class="message-date">{{ msg.created_at|date:"d/m/Y H:i" }}</span>
                        {% if not msg.is_read %}
                        <span class="new-badge">Nouveau</span>
                        {% endif %}
                    </div>
                    <p class="message-content">{{ msg.message }}</p>
                    <div class="message-footer">
                        <span class="message-ip">IP: {{ msg.ip_address|default:"N/A" }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="no-data">Aucun message re√ßu.</p>
                {% endfor %}
            </div>
        </div>

        <!-- IPs Tab -->
        <div class="tab-content" id="ips-tab">
            <div class="tab-header-bar">
                <h3>üåê Analyse des Adresses IP</h3>
                <span class="tab-count">{{ vpn_proxy_count }} VPN/Proxy d√©tect√©s</span>
            </div>
            
            <div class="ips-section">
                <h4>üìä IPs les plus actives</h4>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>IP</th>
                                <th>Pays</th>
                                <th>Ville</th>
                                <th>FAI</th>
                                <th>Sessions</th>
                                <th>Pages vues</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip in most_active_ips %}
                            <tr>
                                <td>
                                    <a href="#" onclick="lookupIP('{{ ip.ip_address }}'); return false;" class="ip-link">
                                        {{ ip.ip_address }}
                                    </a>
                                </td>
                                <td>{{ ip.country|default:"Unknown" }}</td>
                                <td>{{ ip.city|default:"Unknown" }}</td>
                                <td>{{ ip.isp|truncatechars:30 }}</td>
                                <td>{{ ip.session_count }}</td>
                                <td>{{ ip.total_page_views|default:0 }}</td>
                                <td>
                                    <button class="btn-icon" onclick="lookupIP('{{ ip.ip_address }}')" title="D√©tails">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"/>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="no-data">Aucune donn√©e IP disponible</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="ips-section">
                <h4>‚ö†Ô∏è IPs suspectes (nombreuses sessions)</h4>
                <div class="ips-list">
                    {% for ip in suspicious_ips %}
                    <div class="ip-item suspicious" onclick="lookupIP('{{ ip.ip_address }}')">
                        <div class="ip-main">
                            <span class="ip-address">{{ ip.ip_address }}</span>
                            <span class="ip-location">{{ ip.country }}</span>
                        </div>
                        <div class="ip-stats">
                            <span class="ip-sessions warning">{{ ip.count }} sessions</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data success">Aucune IP suspecte d√©tect√©e üéâ</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <!-- System Health Section -->
    <section class="system-section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Sant√© du Syst√®me
        </h2>
        <div class="system-grid">
            <div class="system-card {% if media_stats.exists %}healthy{% else %}warning{% endif %}">
                <h4>üìÅ Stockage M√©dia</h4>
                <div class="system-stat">
                    <span class="system-value {% if media_stats.exists %}success{% else %}error{% endif %}">
                        {% if media_stats.exists %}‚úì Actif{% else %}‚úó Non disponible{% endif %}
                    </span>
                </div>
                <div class="system-details">
                    <span>Vignettes: {{ media_stats.vignette_count }}</span>
                    <span>Grandes: {{ media_stats.grande_count }}</span>
                    <span>Anim√©es: {{ media_stats.animated_count }}</span>
                </div>
            </div>
            
            <div class="system-card">
                <h4>üóÉÔ∏è Base de donn√©es</h4>
                <div class="system-details">
                    <span>{{ total_postcards }} cartes postales</span>
                    <span>{{ total_users }} utilisateurs</span>
                    <span>{{ total_page_views }} pages vues</span>
                    <span>{{ total_likes }} likes</span>
                </div>
            </div>
            
            <div class="system-card">
                <h4>üìä Th√®mes</h4>
                <div class="system-stat">
                    <span class="system-value">{{ total_themes }}</span>
                    <span class="system-label">th√®mes configur√©s</span>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- IP Lookup Modal -->
<div class="modal-overlay" id="ipModal">
    <div class="modal-backdrop" onclick="closeIPModal()"></div>
    <div class="modal-content modal-large">
        <button class="modal-close" onclick="closeIPModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <h2>üåê D√©tails IP</h2>
        <div id="ipModalContent">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<!-- Postcard Analytics Modal -->
<div class="modal-overlay" id="postcardModal">
    <div class="modal-backdrop" onclick="closePostcardModal()"></div>
    <div class="modal-content modal-large">
        <button class="modal-close" onclick="closePostcardModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <h2>üìä Analytique Carte Postale</h2>
        <div id="postcardModalContent">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const csrfToken = '{{ csrf_token }}';
const dailyStats = {{ daily_stats|safe }};
const hourlyTraffic = {{ hourly_traffic|safe }};

// Tab functionality
function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    event.target.closest('.tab-btn').classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
}

// User management
async function updateUserCategory(userId, category) {
    try {
        const response = await fetch(`/api/admin/user/${userId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ category })
        });
        
        if (response.ok) {
            showNotification('Cat√©gorie mise √† jour', 'success');
        } else {
            showNotification('Erreur lors de la mise √† jour', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/user/${userId}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
        
        if (response.ok) {
            document.querySelector(`tr[data-user-id="${userId}"]`).remove();
            showNotification('Utilisateur supprim√©', 'success');
        } else {
            showNotification('Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}

async function loadAllUsers() {
    try {
        const response = await fetch('/api/admin/users/');
        const data = await response.json();
        showNotification(`${data.users.length} utilisateurs charg√©s`, 'success');
    } catch (error) {
        showNotification('Erreur lors du chargement', 'error');
    }
}

// Suggestion management
async function updateSuggestionStatus(suggestionId, status) {
    try {
        const response = await fetch(`/api/admin/suggestion/${suggestionId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            const item = document.querySelector(`.suggestion-item[data-id="${suggestionId}"]`);
            item.className = `suggestion-item ${status}`;
            showNotification('Statut mis √† jour', 'success');
        }
    } catch (error) {
        showNotification('Erreur', 'error');
    }
}

// Postcards management
async function loadPostcards() {
    try {
        const response = await fetch('/api/admin/postcards/');
        const data = await response.json();
        
        const container = document.getElementById('postcards-table-container');
        container.innerHTML = `
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Num√©ro</th>
                        <th>Titre</th>
                        <th>Raret√©</th>
                        <th>Vues</th>
                        <th>Zooms</th>
                        <th>Likes</th>
                        <th>Images</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.postcards.map(p => `
                        <tr>
                            <td>${p.number}</td>
                            <td>${p.title}</td>
                            <td><span class="rarity-badge rarity-${p.rarity}">${p.rarity}</span></td>
                            <td>${p.views_count}</td>
                            <td>${p.zoom_count || 0}</td>
                            <td>${p.likes_count}</td>
                            <td>${p.has_vignette ? '‚úì' : '‚úó'}</td>
                            <td>
                                <button class="btn-icon" onclick="showPostcardAnalytics(${p.id})" title="Analytique">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <p class="table-info">${data.total} cartes postales au total</p>
        `;
        
        showNotification('Cartes charg√©es', 'success');
    } catch (error) {
        showNotification('Erreur lors du chargement', 'error');
    }
}

// Load more likes
let likesPage = 1;
async function loadMoreLikes() {
    try {
        likesPage++;
        const response = await fetch(`/api/admin/likes/?page=${likesPage}`);
        const data = await response.json();
        
        if (data.likes.length > 0) {
            const tbody = document.querySelector('.likes-table tbody');
            data.likes.forEach(like => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="#" onclick="showPostcardAnalytics(${like.postcard_id}); return false;" class="postcard-link">N¬∞ ${like.postcard_number}</a></td>
                    <td><span class="like-type-badge ${like.is_animated ? 'animated' : 'static'}">${like.is_animated ? 'üé¨ Anim√©' : 'üñºÔ∏è Image'}</span></td>
                    <td>${like.user !== 'Anonyme' ? `<span class="user-badge">üë§ ${like.user}</span>` : '<span class="anonymous-badge">üïµÔ∏è Anonyme</span>'}</td>
                    <td><a href="#" onclick="lookupIP('${like.ip_address}'); return false;" class="ip-link">${like.ip_address}</a></td>
                    <td><span class="location-badge">${like.flag} ${like.city}, ${like.country}</span></td>
                    <td>${like.device_type}</td>
                    <td>${like.browser}</td>
                    <td>${like.created_at}</td>
                    <td><button class="btn-icon" onclick="lookupIP('${like.ip_address}')" title="D√©tails IP">üîç</button></td>
                `;
                tbody.appendChild(row);
            });
            showNotification(`${data.likes.length} likes suppl√©mentaires charg√©s`, 'success');
        } else {
            showNotification('Tous les likes ont √©t√© charg√©s', 'info');
        }
    } catch (error) {
        showNotification('Erreur lors du chargement', 'error');
    }
}

// IP Lookup Modal
async function lookupIP(ipAddress) {
    document.getElementById('ipModal').classList.add('active');
    document.getElementById('ipModalContent').innerHTML = '<div class="loading-spinner"></div>';
    
    try {
        const response = await fetch(`/api/admin/ip/${ipAddress}/`);
        const data = await response.json();
        
        document.getElementById('ipModalContent').innerHTML = `
            <div class="ip-details">
                <div class="ip-detail-section">
                    <h4>üìç Localisation</h4>
                    <div class="ip-detail-grid">
                        <p><strong>IP:</strong> ${data.ip_address}</p>
                        <p><strong>Pays:</strong> ${data.location.flag} ${data.location.country} (${data.location.country_code})</p>
                        <p><strong>Ville:</strong> ${data.location.city}</p>
                        <p><strong>R√©gion:</strong> ${data.location.region}</p>
                        <p><strong>FAI:</strong> ${data.location.isp}</p>
                        <p><strong>Fuseau:</strong> ${data.location.timezone}</p>
                    </div>
                    ${data.location.is_vpn ? '<p class="warning">‚ö†Ô∏è VPN/Hosting d√©tect√©</p>' : ''}
                    ${data.location.is_proxy ? '<p class="warning">‚ö†Ô∏è Proxy d√©tect√©</p>' : ''}
                </div>
                
                <div class="ip-detail-section">
                    <h4>üìä Statistiques</h4>
                    <div class="ip-stats-grid">
                        <div class="ip-stat-item">
                            <span class="ip-stat-value">${data.total_sessions}</span>
                            <span class="ip-stat-label">Sessions</span>
                        </div>
                        <div class="ip-stat-item">
                            <span class="ip-stat-value">${data.total_page_views}</span>
                            <span class="ip-stat-label">Pages vues</span>
                        </div>
                        <div class="ip-stat-item">
                            <span class="ip-stat-value">${data.total_likes}</span>
                            <span class="ip-stat-label">Likes</span>
                        </div>
                        <div class="ip-stat-item">
                            <span class="ip-stat-value">${data.total_searches}</span>
                            <span class="ip-stat-label">Recherches</span>
                        </div>
                    </div>
                </div>
                
                <div class="ip-detail-section">
                    <h4>üíª Sessions r√©centes</h4>
                    <div class="sessions-list">
                        ${data.sessions.map(s => `
                            <div class="session-item">
                                <span class="session-date">${s.first_visit}</span>
                                <span class="session-device">${s.device_type} - ${s.browser}</span>
                                <span class="session-pages">${s.page_views} pages</span>
                                ${s.username ? `<span class="session-user">üë§ ${s.username}</span>` : ''}
                            </div>
                        `).join('') || '<p class="no-data">Aucune session</p>'}
                    </div>
                </div>
                
                <div class="ip-detail-section">
                    <h4>‚ù§Ô∏è Likes r√©cents</h4>
                    <div class="likes-list-mini">
                        ${data.likes.map(l => `
                            <div class="like-item-mini">
                                <span>N¬∞ ${l.postcard_number}</span>
                                <span>${l.is_animated ? 'üé¨' : 'üñºÔ∏è'}</span>
                                <span>${l.created_at}</span>
                            </div>
                        `).join('') || '<p class="no-data">Aucun like</p>'}
                    </div>
                </div>
                
                <div class="ip-detail-section">
                    <h4>üîç Recherches r√©centes</h4>
                    <div class="searches-list-mini">
                        ${data.searches.map(s => `
                            <div class="search-item-mini">
                                <span class="search-keyword">"${s.keyword}"</span>
                                <span class="search-results">${s.results_count} r√©sultats</span>
                                <span class="search-date">${s.created_at}</span>
                            </div>
                        `).join('') || '<p class="no-data">Aucune recherche</p>'}
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('ipModalContent').innerHTML = '<p class="error">Erreur lors du chargement</p>';
    }
}

function closeIPModal() {
    document.getElementById('ipModal').classList.remove('active');
}

// Postcard Analytics Modal
async function showPostcardAnalytics(postcardId) {
    document.getElementById('postcardModal').classList.add('active');
    document.getElementById('postcardModalContent').innerHTML = '<div class="loading-spinner"></div>';
    
    try {
        const response = await fetch(`/api/admin/postcard-analytics/${postcardId}/`);
        const data = await response.json();
        
        document.getElementById('postcardModalContent').innerHTML = `
            <div class="postcard-analytics">
                <div class="postcard-info-section">
                    <div class="postcard-preview">
                        ${data.postcard.vignette_url ? `<img src="${data.postcard.vignette_url}" alt="Carte">` : '<div class="no-image">Pas d\'image</div>'}
                    </div>
                    <div class="postcard-meta">
                        <h3>N¬∞ ${data.postcard.number}</h3>
                        <p>${data.postcard.title}</p>
                        <span class="rarity-badge rarity-${data.postcard.rarity}">${data.postcard.rarity}</span>
                        ${data.postcard.has_animation ? '<span class="animation-badge">üé¨ Anim√©e</span>' : ''}
                    </div>
                </div>
                
                <div class="analytics-stats-grid">
                    <div class="analytics-stat">
                        <span class="stat-value">${data.postcard.views_count}</span>
                        <span class="stat-label">üëÅÔ∏è Vues</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="stat-value">${data.postcard.zoom_count}</span>
                        <span class="stat-label">üîç Zooms</span>
                    </div>
                    <div class="analytics-stat">
                        <span class="stat-value">${data.likes_total}</span>
                        <span class="stat-label">‚ù§Ô∏è Likes</span>
                    </div>
                </div>
                
                <div class="analytics-section">
                    <h4>‚ù§Ô∏è Likes par Pays</h4>
                    <div class="country-breakdown">
                        ${data.likes_by_country.map(c => `
                            <div class="country-item">
                                <span>${c.flag} ${c.country}</span>
                                <span>${c.count} likes</span>
                            </div>
                        `).join('') || '<p class="no-data">Aucune donn√©e</p>'}
                    </div>
                </div>
                
                <div class="analytics-section">
                    <h4>üì± Likes par Appareil</h4>
                    <div class="device-breakdown">
                        ${data.likes_by_device.map(d => `
                            <div class="device-item">
                                <span>${d.device_type}</span>
                                <span>${d.count} likes</span>
                            </div>
                        `).join('') || '<p class="no-data">Aucune donn√©e</p>'}
                    </div>
                </div>
                
                <div class="analytics-section">
                    <h4>üìÖ Derniers likes</h4>
                    <div class="likes-breakdown">
                        ${data.recent_likes.map(l => `
                            <div class="like-item-detail">
                                <span class="like-user">${l.user !== 'Anonyme' ? 'üë§ ' + l.user : 'üïµÔ∏è Anonyme'}</span>
                                <span class="like-location">${l.flag} ${l.city}, ${l.country}</span>
                                <span class="like-device">${l.device_type}</span>
                                <span class="like-date">${l.created_at}</span>
                                ${l.is_animated ? '<span class="animation-like">üé¨</span>' : ''}
                            </div>
                        `).join('') || '<p class="no-data">Aucun like</p>'}
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('postcardModalContent').innerHTML = '<p class="error">Erreur lors du chargement</p>';
    }
}

function closePostcardModal() {
    document.getElementById('postcardModal').classList.remove('active');
}

// Real-time updates
function updateRealTimeVisitors() {
    fetch('/api/admin/realtime/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('activeVisitorCount').textContent = data.count;
            
            const list = document.getElementById('activeVisitorsList');
            if (data.visitors.length > 0) {
                list.innerHTML = data.visitors.map(v => `
                    <div class="active-visitor" onclick="lookupIP('${v.ip_address}')">
                        <span class="visitor-flag">${v.flag || 'üåç'}</span>
                        <span class="visitor-country">${v.country || 'Inconnu'}</span>
                        <span class="visitor-city">${v.city || ''}</span>
                        <span class="visitor-page" title="${v.current_page}">${(v.page_title || '').substring(0, 25)}</span>
                        <span class="visitor-device">${v.device_type || ''}</span>
                        <span class="visitor-browser">${v.browser || ''}</span>
                        ${v.username ? `<span class="visitor-user">üë§ ${v.username}</span>` : ''}
                        <span class="visitor-ip">${v.ip_address}</span>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="no-visitors">Aucun visiteur actif en ce moment</p>';
            }
        })
        .catch(error => console.log('Realtime update error:', error));
}

// Update every 30 seconds
setInterval(updateRealTimeVisitors, 30000);

// Notifications
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        ${message}
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Initialize Charts
document.addEventListener('DOMContentLoaded', () => {
    // Activity Chart
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx && dailyStats.length > 0) {
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: dailyStats.map(d => d.date),
                datasets: [
                    {
                        label: 'Vues',
                        data: dailyStats.map(d => d.views),
                        borderColor: '#b5600b',
                        backgroundColor: 'rgba(181, 96, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Sessions',
                        data: dailyStats.map(d => d.sessions),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Recherches',
                        data: dailyStats.map(d => d.searches),
                        borderColor: '#17a2b8',
                        tension: 0.4
                    },
                    {
                        label: 'Likes',
                        data: dailyStats.map(d => d.likes),
                        borderColor: '#ff6b6b',
                        tension: 0.4
                    },
                    {
                        label: 'Nouveaux utilisateurs',
                        data: dailyStats.map(d => d.users),
                        borderColor: '#ffc168',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                }
            }
        });
    }

    // Users Chart
    const usersCtx = document.getElementById('usersChart');
    if (usersCtx) {
        new Chart(usersCtx, {
            type: 'doughnut',
            data: {
                labels: ['Non v√©rifi√©s', 'V√©rifi√©s', 'Facteurs', 'Visiteurs', 'Staff'],
                datasets: [{
                    data: [
                        {{ user_categories.unverified }},
                        {{ user_categories.verified }},
                        {{ user_categories.postman }},
                        {{ user_categories.viewer }},
                        {{ user_categories.staff }}
                    ],
                    backgroundColor: ['#6c757d', '#28a745', '#b5600b', '#d1872c', '#ffc168']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '60%'
            }
        });
    }

    // Devices Chart
    const devicesCtx = document.getElementById('devicesChart');
    if (devicesCtx) {
        new Chart(devicesCtx, {
            type: 'doughnut',
            data: {
                labels: ['Mobile', 'Desktop', 'Tablette', 'Autre'],
                datasets: [{
                    data: [
                        {{ device_breakdown.mobile }},
                        {{ device_breakdown.desktop }},
                        {{ device_breakdown.tablet }},
                        {{ device_breakdown.other }}
                    ],
                    backgroundColor: ['#17a2b8', '#28a745', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '60%'
            }
        });
    }

    // Hourly Chart
    const hourlyCtx = document.getElementById('hourlyChart');
    if (hourlyCtx && hourlyTraffic.length > 0) {
        new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: hourlyTraffic.map(h => h.hour),
                datasets: [{
                    label: 'Vues',
                    data: hourlyTraffic.map(h => h.count),
                    backgroundColor: 'rgba(181, 96, 11, 0.7)',
                    borderColor: '#b5600b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                    }
                }
            }
        });
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeIPModal();
        closePostcardModal();
    }
});
</script>

<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
{% endblock %}