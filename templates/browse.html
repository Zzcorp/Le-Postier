<!-- templates/browse.html -->
{% extends 'base.html' %}
{% load static %}
 
{% block page_title %}Rechercher{% endblock %}
 
{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p class="loading-text">Chargement...</p>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
    </div>
</div>
 
<!-- Cinema/Diaporama Modal -->
<div class="cinema-modal" id="cinemaModal">
    <div class="cinema-backdrop" onclick="closeCinema()"></div>
    <div class="cinema-container">
        <button class="cinema-close" onclick="closeCinema()" title="Fermer">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
       
        <div class="cinema-screen">
            <img id="cinemaImage" src="" alt="Diaporama" class="cinema-media">
            <video id="cinemaVideo" muted loop playsinline class="cinema-media" style="display:none;">
                <source src="" type="video/mp4">
            </video>
            <div class="cinema-loading" id="cinemaLoading">
                <div class="cinema-spinner"></div>
            </div>
        </div>
       
        <div class="cinema-info">
            <span class="cinema-counter" id="cinemaCounter">1 / 50</span>
            <h3 id="cinemaTitle">Titre de la carte</h3>
            <span id="cinemaNumber">N¬∞ 000001</span>
        </div>
       
        <div class="cinema-controls">
            <button class="cinema-nav-btn" id="cinemaPrev" onclick="cinemaPrev()" title="Pr√©c√©dent">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </button>
           
            <button class="cinema-play-btn" id="cinemaPlayBtn" onclick="toggleCinemaPlay()" title="Lecture/Pause">
                <svg id="playIcon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg id="pauseIcon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            </button>
           
            <button class="cinema-nav-btn" id="cinemaNext" onclick="cinemaNext()" title="Suivant">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                </svg>
            </button>
        </div>
       
        <div class="cinema-mode-selector">
            <button class="mode-btn active" data-mode="static" onclick="setCinemaMode('static')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <path d="m21 15-5-5L5 21"/>
                </svg>
                Images
            </button>
            <button class="mode-btn" data-mode="animated" onclick="setCinemaMode('animated')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Anim√©es
            </button>
            <button class="mode-btn" data-mode="mixed" onclick="setCinemaMode('mixed')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="9" height="9" rx="1"/>
                    <rect x="13" y="2" width="9" height="9" rx="1"/>
                    <rect x="2" y="13" width="9" height="9" rx="1"/>
                    <rect x="13" y="13" width="9" height="9" rx="1"/>
                </svg>
                Mixte
            </button>
        </div>
       
        <div class="cinema-progress">
            <div class="cinema-progress-bar" id="cinemaProgressBar"></div>
        </div>
    </div>
</div>
 
<!-- River Background -->
<div class="river-background" id="river-background">
    <div class="river-gradient"></div>
    
    <!-- Fish Container - Behind everything -->
    <div class="fish-container" id="fish-container"></div>
    
    <!-- Back Wave (slower, brighter) -->
    <svg class="waves-svg waves-back" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <defs>
            <linearGradient id="waveGradientBack" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:rgba(255,193,104,0.08)"/>
                <stop offset="50%" style="stop-color:rgba(255,220,150,0.12)"/>
                <stop offset="100%" style="stop-color:rgba(255,193,104,0.08)"/>
            </linearGradient>
        </defs>
        <path class="wave wave-back" fill="url(#waveGradientBack)">
            <animate attributeName="d"
                     dur="20s"
                     repeatCount="indefinite"
                     values="M0,180L48,195C96,210,192,240,288,230C384,220,480,170,576,155C672,140,768,160,864,185C960,210,1056,240,1152,225C1248,210,1344,150,1392,120L1440,90L1440,320L0,320Z;
                            M0,200L48,185C96,170,192,140,288,155C384,170,480,220,576,235C672,250,768,230,864,200C960,170,1056,140,1152,145C1248,150,1344,190,1392,210L1440,230L1440,320L0,320Z;
                            M0,180L48,195C96,210,192,240,288,230C384,220,480,170,576,155C672,140,768,160,864,185C960,210,1056,240,1152,225C1248,210,1344,150,1392,120L1440,90L1440,320L0,320Z"/>
        </path>
    </svg>
    
    <!-- Front Wave (original, faster) -->
    <svg class="waves-svg waves-front" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <defs>
            <linearGradient id="waveGradient1" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:rgba(181,96,11,0.12)"/>
                <stop offset="50%" style="stop-color:rgba(209,135,44,0.18)"/>
                <stop offset="100%" style="stop-color:rgba(181,96,11,0.12)"/>
            </linearGradient>
        </defs>
        <path class="wave wave-1" fill="url(#waveGradient1)">
            <animate attributeName="d"
                     dur="12s"
                     repeatCount="indefinite"
                     values="M0,160L48,176C96,192,192,224,288,213.3C384,203,480,149,576,138.7C672,128,768,160,864,181.3C960,203,1056,213,1152,197.3C1248,181,1344,139,1392,117.3L1440,96L1440,320L0,320Z;
                            M0,192L48,181.3C96,171,192,149,288,160C384,171,480,213,576,218.7C672,224,768,192,864,165.3C960,139,1056,117,1152,128C1248,139,1344,181,1392,202.7L1440,224L1440,320L0,320Z;
                            M0,160L48,176C96,192,192,224,288,213.3C384,203,480,149,576,138.7C672,128,768,160,864,181.3C960,203,1056,213,1152,197.3C1248,181,1344,139,1392,117.3L1440,96L1440,320L0,320Z"/>
        </path>
    </svg>
    
    <!-- Light Particles Container -->
    <div class="light-particles" id="light-particles"></div>
    
    <div class="river-particles" id="river-particles"></div>
</div>
 
<div class="browse-page">
    <!-- Search Section -->
    <div class="search-section">
        <form id="searchForm" class="search-form" method="get" action="{% url 'browse' %}">
            <div class="search-box">
                <input type="text"
                       name="keywords_input"
                       id="searchInput"
                       value="{{ query|default:'' }}"
                       placeholder="Rechercher dans la collection..."
                       autocomplete="off">
                <button type="button" class="clear-btn" id="clearBtn" onclick="clearSearch()" title="Effacer">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <button type="submit" class="search-submit" aria-label="Rechercher">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </button>
            </div>
        </form>
       
        <div class="search-info" id="searchInfo">
            {% if query %}
            <p class="search-results-text">
                <span class="result-count">{{ displayed_count }}</span> r√©sultat{{ displayed_count|pluralize }} pour
                "<span class="result-query">{{ query }}</span>"
            </p>
            {% endif %}
        </div>
    </div>
 
    <!-- Cinema/Diaporama Button -->
    <div class="cinema-launcher" id="cinemaLauncher">
        <button class="cinema-big-btn" onclick="openCinema()" title="Lancer le diaporama">
            <div class="cinema-btn-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="2" width="20" height="20" rx="2.18"/>
                    <path d="M7 2v20M17 2v20M2 12h20M2 7h5M2 17h5M17 17h5M17 7h5"/>
                </svg>
            </div>
            <div class="cinema-btn-text">
                <span class="cinema-btn-title">Diaporama</span>
                <span class="cinema-btn-subtitle">Parcourir la s√©lection</span>
            </div>
            <div class="cinema-btn-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </div>
        </button>
    </div>
 
    <!-- Floating River Keywords Section -->
    <div class="river-keywords-section" id="river-keywords-section">
        <div class="river-keywords-header">
            <h3>Explorez par th√®me</h3>
            <p>Cliquez sur un mot-cl√©</p>
        </div>
        <div class="river-keywords-container" id="river-keywords-container">
            <!-- Keywords populated by JS -->
        </div>
    </div>
 
    <!-- Results Grid -->
    <div class="results-section" id="results-section">
        <div class="postcards-grid" id="postcards-grid">
            {% for postcard in postcards %}
            <div class="postcard-card"
                 data-id="{{ postcard.id }}"
                 data-number="{{ postcard.number }}"
                 data-title="{{ postcard.title|escapejs }}"
                 data-keywords="{{ postcard.keywords|lower }}"
                 data-vignette="{{ postcard.get_vignette_url }}"
                 data-grande="{{ postcard.get_grande_url }}"
                 data-dos="{{ postcard.get_dos_url }}"
                 data-zoom="{{ postcard.get_zoom_url }}"
                 data-has-video="{% if postcard.get_animated_urls %}true{% else %}false{% endif %}"
                 data-video-url="{{ postcard.get_first_video_url|default:'' }}"
                 onclick="showDetail({{ postcard.id }})">
               
                <div class="card-image-wrapper">
                    {% with vignette_url=postcard.get_vignette_url %}
                    {% if vignette_url %}
                    <img class="card-image"
                         data-src="{{ vignette_url }}"
                         alt="{{ postcard.title }}"
                         loading="lazy">
                    <div class="card-placeholder">
                        <div class="placeholder-spinner"></div>
                    </div>
                    {% else %}
                    <div class="card-no-image">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="m21 15-5-5L5 21"/>
                        </svg>
                    </div>
                    {% endif %}
                    {% endwith %}
                   
                    {% if postcard.get_animated_urls %}
                    <div class="animated-badge-static">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                    {% endif %}
                </div>
               
                <div class="card-overlay">
                    <div class="card-actions">
                        <button class="action-btn view-btn" onclick="event.stopPropagation(); showDetail({{ postcard.id }})" title="Voir le d√©tail">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                       
                        <button class="action-btn like-btn {% if postcard.id in user_likes %}liked{% endif %}"
                                onclick="event.stopPropagation(); toggleLike(event, {{ postcard.id }})"
                                title="J'aime"
                                data-id="{{ postcard.id }}">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="{% if postcard.id in user_likes %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </button>
                       
                        <button class="action-btn zoom-btn" onclick="event.stopPropagation(); showZoom({{ postcard.id }})" title="Agrandir">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35M11 8v6M8 11h6"/>
                            </svg>
                        </button>
                       
                        {% if postcard.get_animated_urls %}
                        <a href="{% url 'animated_gallery' %}?highlight={{ postcard.id }}" 
                           class="action-btn action-video" 
                           onclick="event.stopPropagation();" 
                           title="Voir l'animation">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                    <p class="card-title">{{ postcard.title|truncatechars:50 }}</p>
                    <span class="card-number">N¬∞ {{ postcard.number }}</span>
                </div>
            </div>
            {% empty %}
            <div class="no-results-message">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <path d="m21 15-5-5L5 21"/>
                </svg>
                <h3>D√©sol√©, aucune carte postale trouv√©e</h3>
                <p>Modifiez vos crit√®res de recherche ou parcourez les mots-cl√©s ci-dessus.</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" id="pagination-container">
            <!-- Pagination will be populated by JS -->
        </div>
       
        <div class="no-results" id="noResults" style="display:none;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.5">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <h3>D√©sol√©, aucune carte postale trouv√©e</h3>
            <p>Essayez d'autres mots-cl√©s ou modifiez votre recherche</p>
            <button class="reset-btn" onclick="clearSearch()">R√©initialiser la recherche</button>
        </div>
    </div>
   
    <div class="browse-footer">
        <p><span id="visible-count">{{ displayed_count }}</span> cartes affich√©es sur {{ total_count }}</p>
    </div>
</div>
 
<!-- Detail Popup -->
<div class="popup-overlay" id="popup-overlay"></div>
 
<div class="popup-modal" id="popup-detail">
    <button class="popup-close" onclick="closeDetailPopup()" title="Fermer">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
    </button>
   
    <button class="popup-flip" id="popup-flip" onclick="togglePostcardSide()" title="Voir le verso">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7v6h6"/>
            <path d="M21 17v-6h-6"/>
            <path d="M16 3a9 9 0 0 0-12.735 3"/>
            <path d="M8 21a9 9 0 0 0 12.735-3"/>
        </svg>
    </button>
   
    <button class="popup-nav popup-prev" id="popup-prev" onclick="previousImage()" title="Pr√©c√©dent">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6"/>
        </svg>
    </button>
   
    <div class="popup-image-container">
        <img id="popup-image" src="" alt="">
        
        <!-- Actions on image - bottom left -->
        <div class="popup-image-actions">
            <button class="popup-img-action-btn popup-like-img-btn" id="popup-like-img-btn" onclick="togglePopupLike()" title="J'aime">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                <span id="popup-like-count-img">0</span>
            </button>
            
            <a class="popup-img-action-btn popup-send-img-btn" id="popup-send-img-btn" href="#" title="Envoyer cette carte">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                </svg>
            </a>
            
            <a class="popup-img-action-btn popup-video-img-btn" id="popup-video-img-btn" href="#" title="Voir l'animation" style="display:none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </a>
        </div>
    </div>
   
    <button class="popup-nav popup-next" id="popup-next" onclick="nextImage()" title="Suivant">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m9 18 6-6-6-6"/>
        </svg>
    </button>
   
    <div class="popup-info">
        <h3 id="popup-title"></h3>
        <span id="popup-number"></span>
    </div>
</div>
 
<!-- Enhanced Zoom Modal -->
<div class="zoom-modal" id="zoom-modal">
    <div class="zoom-backdrop" onclick="closeZoomPopup()"></div>
    <div class="zoom-content">
        <button class="zoom-close-btn" onclick="closeZoomPopup()" title="Fermer (√âchap)">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
        
        <div class="zoom-image-wrapper" id="zoom-image-wrapper">
            <img id="zoom-image" src="" alt="Zoom" draggable="false">
        </div>
        
        <div class="zoom-toolbar">
            <button class="zoom-tool-btn" onclick="zoomOut()" title="Zoom arri√®re (-)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <span class="zoom-level" id="zoom-level">100%</span>
            <button class="zoom-tool-btn" onclick="zoomIn()" title="Zoom avant (+)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <div class="zoom-separator"></div>
            <button class="zoom-tool-btn" onclick="resetZoom()" title="R√©initialiser (0)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
            </button>
            <button class="zoom-tool-btn" onclick="fitToScreen()" title="Ajuster √† l'√©cran (F)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
        </div>
        
        <div class="zoom-instructions">
            <span>üñ±Ô∏è Molette pour zoomer ‚Ä¢ Glisser pour d√©placer ‚Ä¢ Double-clic pour zoom rapide</span>
        </div>
    </div>
</div>

<!-- Bubble Pop Effect Container -->
<div class="bubble-pop-container" id="bubble-pop-container"></div>
 
<script>
// =============================================
// DATA
// =============================================
const csrfToken = '{{ csrf_token }}';
const ITEMS_PER_PAGE = 50;
let currentPage = 1;
 
const allPostcardsData = [
    {% for postcard in postcards %}
    {
        id: {{ postcard.id }},
        number: "{{ postcard.number|escapejs }}",
        title: "{{ postcard.title|escapejs }}",
        keywords: "{{ postcard.keywords|escapejs|lower }}",
        grande_url: "{{ postcard.get_grande_url }}",
        dos_url: "{{ postcard.get_dos_url }}",
        zoom_url: "{{ postcard.get_zoom_url }}",
        vignette_url: "{{ postcard.get_vignette_url }}",
        likes_count: {{ postcard.likes_count|default:0 }},
        has_video: {% if postcard.get_animated_urls %}true{% else %}false{% endif %},
        video_url: "{{ postcard.get_first_video_url|default:'' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
 
// Expanded floating keywords
const riverKeywords = [
    { word: 'Seine', size: 'large', importance: 1 },
    { word: 'Marne', size: 'large', importance: 1 },
    { word: 'Bateau', size: 'large', importance: 1 },
    { word: 'Paris', size: 'large', importance: 1 },
    { word: 'P√©niche', size: 'medium', importance: 2 },
    { word: 'Pont', size: 'medium', importance: 2 },
    { word: '√âcluse', size: 'medium', importance: 2 },
    { word: 'Port', size: 'medium', importance: 2 },
    { word: 'Fleuve', size: 'medium', importance: 2 },
    { word: 'Vapeur', size: 'medium', importance: 2 },
    { word: 'Quai', size: 'medium', importance: 2 },
    { word: 'Navigation', size: 'medium', importance: 2 },
    { word: 'Berge', size: 'small', importance: 3 },
    { word: 'Croisi√®re', size: 'small', importance: 3 },
    { word: 'Marinier', size: 'small', importance: 3 },
    { word: 'Barque', size: 'small', importance: 3 },
    { word: 'Remorqueur', size: 'small', importance: 3 },
    { word: 'Lavoir', size: 'small', importance: 3 },
    { word: 'P√™cheur', size: 'small', importance: 3 },
    { word: 'Inondation', size: 'small', importance: 3 },
    {% for theme in themes %}
    { word: '{{ theme.display_name|escapejs }}', size: 'medium', importance: 2 },
    {% endfor %}
];
 
let filteredPostcards = [...allPostcardsData];
let currentIndex = 0;
let currentView = 'front';
let currentPostcardId = null;
let popupsOpen = false;

// =============================================
// SIMPLE EXACT PHRASE SEARCH
// =============================================
class SimpleSearchEngine {
    constructor() {
        this.searchInput = document.getElementById('searchInput');
        this.clearBtn = document.getElementById('clearBtn');
        this.init();
    }
   
    init() {
        this.searchInput.addEventListener('input', (e) => this.handleInput(e));
        this.updateClearButton();
    }
   
    handleInput(e) {
        this.updateClearButton();
    }
   
    updateClearButton() {
        const hasValue = this.searchInput.value.trim().length > 0;
        this.clearBtn.classList.toggle('visible', hasValue);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    window.location.href = '{% url "browse" %}';
}

// =============================================
// PAGINATION SYSTEM
// =============================================
function renderCurrentPage() {
    const grid = document.getElementById('postcards-grid');
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageItems = filteredPostcards.slice(start, end);
    
    // Clear grid
    grid.innerHTML = '';
    
    if (pageItems.length === 0) {
        grid.innerHTML = `
            <div class="no-results-message">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <path d="m21 15-5-5L5 21"/>
                </svg>
                <h3>Aucune carte postale trouv√©e</h3>
                <p>Modifiez vos crit√®res de recherche ou parcourez les mots-cl√©s ci-dessus.</p>
            </div>
        `;
        document.getElementById('pagination-container').innerHTML = '';
        document.getElementById('visible-count').textContent = '0';
        return;
    }
    
    // Render postcards
    pageItems.forEach(postcard => {
        const card = createPostcardCard(postcard);
        grid.appendChild(card);
    });
    
    // Render pagination
    renderPagination();
    
    // Update count
    document.getElementById('visible-count').textContent = filteredPostcards.length;
    
    // Re-initialize lazy loading
    initLazyLoading();
    
    // Scroll to top of results
    if (currentPage > 1) {
        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function createPostcardCard(postcard) {
    const card = document.createElement('div');
    card.className = 'postcard-card';
    card.dataset.id = postcard.id;
    card.dataset.number = postcard.number;
    card.dataset.title = postcard.title;
    card.dataset.keywords = postcard.keywords;
    card.dataset.vignette = postcard.vignette_url;
    card.dataset.grande = postcard.grande_url;
    card.dataset.dos = postcard.dos_url;
    card.dataset.zoom = postcard.zoom_url;
    card.dataset.hasVideo = postcard.has_video;
    card.dataset.videoUrl = postcard.video_url;
    card.onclick = () => showDetail(postcard.id);
    
    const userLikes = new Set();
    const isLiked = userLikes.has(postcard.id);
    
    card.innerHTML = `
        <div class="card-image-wrapper">
            ${postcard.vignette_url ? `
                <img class="card-image" data-src="${postcard.vignette_url}" alt="${escapeHtml(postcard.title)}" loading="lazy">
                <div class="card-placeholder">
                    <div class="placeholder-spinner"></div>
                </div>
            ` : `
                <div class="card-no-image">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <path d="m21 15-5-5L5 21"/>
                    </svg>
                </div>
            `}
            ${postcard.has_video ? `
                <div class="animated-badge-static">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            ` : ''}
        </div>
        <div class="card-overlay">
            <div class="card-actions">
                <button class="action-btn view-btn" onclick="event.stopPropagation(); showDetail(${postcard.id})" title="Voir le d√©tail">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
                <button class="action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLike(event, ${postcard.id})" title="J'aime" data-id="${postcard.id}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                </button>
                <button class="action-btn zoom-btn" onclick="event.stopPropagation(); showZoom(${postcard.id})" title="Agrandir">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35M11 8v6M8 11h6"/>
                    </svg>
                </button>
                ${postcard.has_video ? `
                    <a href="/cp-animes/?highlight=${postcard.id}" class="action-btn action-video" onclick="event.stopPropagation();" title="Voir l'animation">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </a>
                ` : ''}
            </div>
            <p class="card-title">${escapeHtml(postcard.title.substring(0, 50))}${postcard.title.length > 50 ? '...' : ''}</p>
            <span class="card-number">N¬∞ ${postcard.number}</span>
        </div>
    `;
    
    return card;
}

function renderPagination() {
    const container = document.getElementById('pagination-container');
    const totalPages = Math.ceil(filteredPostcards.length / ITEMS_PER_PAGE);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<div class="pagination">';
    
    // Previous button
    html += `<button class="page-btn page-prev ${currentPage === 1 ? 'disabled' : ''}" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m15 18-6-6 6-6"/>
        </svg>
    </button>`;
    
    // Page numbers
    const maxVisiblePages = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            html += `<span class="page-ellipsis">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<span class="page-ellipsis">...</span>`;
        }
        html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    html += `<button class="page-btn page-next ${currentPage === totalPages ? 'disabled' : ''}" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m9 18 6-6-6-6"/>
        </svg>
    </button>`;
    
    html += '</div>';
    
    // Page info
    const start = (currentPage - 1) * ITEMS_PER_PAGE + 1;
    const end = Math.min(currentPage * ITEMS_PER_PAGE, filteredPostcards.length);
    html += `<p class="page-info">${start} - ${end} sur ${filteredPostcards.length} cartes</p>`;
    
    container.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredPostcards.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderCurrentPage();
}

function initLazyLoading() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.onload = () => {
                        img.classList.add('loaded');
                        const placeholder = img.closest('.card-image-wrapper')?.querySelector('.card-placeholder');
                        if (placeholder) placeholder.classList.add('hidden');
                    };
                    img.onerror = () => {
                        const placeholder = img.closest('.card-image-wrapper')?.querySelector('.card-placeholder');
                        if (placeholder) placeholder.classList.add('hidden');
                    };
                }
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '100px', threshold: 0.1 });
    
    document.querySelectorAll('.card-image[data-src]').forEach(img => {
        if (!img.classList.contains('loaded')) {
            observer.observe(img);
        }
    });
}

// =============================================
// FLOATING KEYWORDS WITH BUBBLE EFFECTS
// =============================================
class FloatingKeywords {
    constructor() {
        this.container = document.getElementById('river-keywords-container');
        this.keywords = [];
        this.animationFrameId = null;
        this.isVisible = true;
        this.maxVisibleKeywords = 15;
       
        if (!this.container) return;
        this.init();
    }
   
    init() {
        this.createKeywords();
        this.startAnimation();
        this.setupVisibilityObserver();
    }
   
    createKeywords() {
        const selectedKeywords = this.selectKeywords();
       
        selectedKeywords.forEach((kw, index) => {
            const element = document.createElement('button');
            element.className = `floating-keyword keyword-${kw.size} bubble-keyword`;
            element.innerHTML = `<span class="keyword-text">${kw.word}</span>`;
            element.dataset.word = kw.word;
           
            const startX = (index / selectedKeywords.length) * 100;
            const startY = 15 + (index % 3) * 30 + Math.random() * 20;
           
            const baseSpeed = kw.size === 'large' ? 0.15 : kw.size === 'medium' ? 0.2 : 0.25;
            const speed = baseSpeed + Math.random() * 0.1;
           
            const waveAmplitude = 8 + Math.random() * 12;
            const waveFrequency = 0.3 + Math.random() * 0.4;
            const waveOffset = Math.random() * Math.PI * 2;
            
            // Border oscillation parameters
            const borderWaveSpeed = 0.5 + Math.random() * 0.5;
            const borderWaveOffset = Math.random() * Math.PI * 2;
           
            const keywordObj = {
                element,
                x: startX,
                y: startY,
                speed,
                waveAmplitude,
                waveFrequency,
                waveOffset,
                borderWaveSpeed,
                borderWaveOffset,
                startTime: performance.now(),
                word: kw.word
            };
           
            this.keywords.push(keywordObj);
            this.container.appendChild(element);
           
            element.addEventListener('click', (e) => this.onKeywordClick(e, kw.word, element));
           
            element.style.cssText = `
                position: absolute;
                left: ${startX}%;
                top: ${startY}%;
                opacity: 0.8;
            `;
        });
    }
   
    selectKeywords() {
        const shuffled = [...riverKeywords].sort(() => Math.random() - 0.5);
        const large = shuffled.filter(k => k.size === 'large').slice(0, 4);
        const medium = shuffled.filter(k => k.size === 'medium').slice(0, 6);
        const small = shuffled.filter(k => k.size === 'small').slice(0, 5);
        return [...large, ...medium, ...small];
    }
   
    startAnimation() {
        const animate = (timestamp) => {
            if (!this.isVisible) {
                this.animationFrameId = requestAnimationFrame(animate);
                return;
            }
           
            this.keywords.forEach(kw => {
                const elapsed = (timestamp - kw.startTime) / 1000;
               
                kw.x -= kw.speed * 0.03;
               
                if (kw.x < -15) {
                    kw.x = 105;
                    kw.y = 15 + Math.random() * 70;
                }
               
                const waveY = Math.sin(elapsed * kw.waveFrequency + kw.waveOffset) * kw.waveAmplitude;
               
                let opacity = 0.85;
                if (kw.x > 85) opacity = (100 - kw.x) / 15;
                else if (kw.x < 15) opacity = kw.x / 15;
                opacity = Math.max(0.1, Math.min(0.85, opacity));
                
                // Oscillating border radius for wavy effect
                const borderWave = Math.sin(elapsed * kw.borderWaveSpeed + kw.borderWaveOffset);
                const r1 = 45 + borderWave * 8;
                const r2 = 55 - borderWave * 8;
                const r3 = 50 + borderWave * 5;
                const r4 = 50 - borderWave * 5;
               
                kw.element.style.left = `${kw.x}%`;
                kw.element.style.top = `${kw.y}%`;
                kw.element.style.transform = `translateY(${waveY}px)`;
                kw.element.style.opacity = opacity;
                kw.element.style.borderRadius = `${r1}% ${r2}% ${r3}% ${r4}% / ${r2}% ${r1}% ${r4}% ${r3}%`;
            });
           
            this.animationFrameId = requestAnimationFrame(animate);
        };
       
        this.animationFrameId = requestAnimationFrame(animate);
    }
   
    setupVisibilityObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                this.isVisible = entry.isIntersecting;
            });
        }, { threshold: 0.1 });
       
        observer.observe(this.container);
    }
   
    onKeywordClick(event, word, element) {
        // Create bubble pop effect
        createBubblePop(event.clientX, event.clientY);
        
        // Add pop animation to the keyword
        element.classList.add('popping');
        
        // Wait for animation then redirect
        setTimeout(() => {
            document.getElementById('searchInput').value = word;
            document.getElementById('searchForm').submit();
        }, 400);
    }
}

// Bubble Pop Effect
function createBubblePop(x, y) {
    const container = document.getElementById('bubble-pop-container');
    
    // Create multiple bubble particles
    for (let i = 0; i < 12; i++) {
        const bubble = document.createElement('div');
        bubble.className = 'bubble-particle';
        
        const angle = (i / 12) * Math.PI * 2;
        const distance = 30 + Math.random() * 50;
        const size = 8 + Math.random() * 16;
        
        bubble.style.cssText = `
            left: ${x}px;
            top: ${y}px;
            width: ${size}px;
            height: ${size}px;
            --tx: ${Math.cos(angle) * distance}px;
            --ty: ${Math.sin(angle) * distance}px;
        `;
        
        container.appendChild(bubble);
        
        // Remove after animation
        setTimeout(() => bubble.remove(), 600);
    }
    
    // Create central burst
    const burst = document.createElement('div');
    burst.className = 'bubble-burst';
    burst.style.cssText = `left: ${x}px; top: ${y}px;`;
    container.appendChild(burst);
    setTimeout(() => burst.remove(), 500);
}

// =============================================
// FISH & SEAHORSE ANIMATION
// =============================================
class AquaticLifeManager {
    constructor() {
        this.container = document.getElementById('fish-container');
        this.creatures = [];
        
        if (!this.container) return;
        this.init();
    }
    
    init() {
        // Create various fish
        this.createFish({ size: 60, speed: 0.4, y: 25, type: 'fish', color: 'rgba(181, 96, 11, 0.25)' });
        this.createFish({ size: 45, speed: 0.5, y: 45, type: 'fish', color: 'rgba(209, 135, 44, 0.2)' });
        this.createFish({ size: 70, speed: 0.35, y: 65, type: 'fish', color: 'rgba(181, 96, 11, 0.22)' });
        this.createFish({ size: 35, speed: 0.6, y: 35, type: 'fish', color: 'rgba(255, 193, 104, 0.18)' });
        this.createFish({ size: 50, speed: 0.45, y: 55, type: 'fish', color: 'rgba(181, 96, 11, 0.2)' });
        this.createFish({ size: 40, speed: 0.55, y: 75, type: 'fish', color: 'rgba(209, 135, 44, 0.18)' });
        this.createFish({ size: 55, speed: 0.38, y: 20, type: 'fish', color: 'rgba(255, 193, 104, 0.2)' });
        
        // Create seahorse duo
        this.createSeahorse({ size: 40, speed: 0.25, y: 40, offset: 0 });
        this.createSeahorse({ size: 35, speed: 0.25, y: 48, offset: 15 }); // Following partner
        
        this.animate();
    }
    
    createFish(config) {
        const fish = document.createElement('div');
        fish.className = 'swimming-creature swimming-fish';
        
        const direction = Math.random() > 0.5 ? 1 : -1;
        const startX = direction === 1 ? -20 : 120;
        
        fish.innerHTML = `
            <svg viewBox="0 0 60 35" fill="none">
                <!-- Body -->
                <ellipse cx="30" cy="17" rx="22" ry="12" fill="${config.color}"/>
                <!-- Tail -->
                <path d="M8 17 L-5 5 L-2 17 L-5 29 Z" fill="${config.color.replace('0.', '0.15').replace(')', ')')}"/>
                <!-- Dorsal fin -->
                <path d="M25 5 Q30 0 35 5 L30 10 Z" fill="${config.color.replace('0.', '0.12').replace(')', ')')}"/>
                <!-- Eye -->
                <circle cx="42" cy="14" r="3" fill="rgba(255, 255, 255, 0.3)"/>
                <circle cx="43" cy="13" r="1.5" fill="rgba(255, 255, 255, 0.5)"/>
                <!-- Pectoral fin -->
                <ellipse cx="28" cy="22" rx="6" ry="4" fill="${config.color.replace('0.', '0.1').replace(')', ')')}" transform="rotate(-20 28 22)"/>
            </svg>
        `;
        
        const creatureObj = {
            element: fish,
            x: startX,
            y: config.y,
            speed: config.speed * direction,
            size: config.size,
            waveOffset: Math.random() * Math.PI * 2,
            waveAmplitude: 4 + Math.random() * 6,
            tailWaveOffset: Math.random() * Math.PI * 2,
            direction,
            type: 'fish'
        };
        
        fish.style.cssText = `
            position: absolute;
            width: ${config.size}px;
            height: ${config.size * 0.6}px;
            left: ${startX}%;
            top: ${config.y}%;
            transform: scaleX(${direction});
            opacity: 0.8;
            pointer-events: none;
            z-index: 1;
        `;
        
        this.creatures.push(creatureObj);
        this.container.appendChild(fish);
    }
    
    createSeahorse(config) {
        const seahorse = document.createElement('div');
        seahorse.className = 'swimming-creature swimming-seahorse';
        
        const startX = -20 + config.offset;
        
        seahorse.innerHTML = `
            <svg viewBox="0 0 30 50" fill="none">
                <!-- Head -->
                <ellipse cx="18" cy="8" rx="8" ry="6" fill="rgba(181, 96, 11, 0.2)"/>
                <!-- Snout -->
                <ellipse cx="26" cy="10" rx="5" ry="2" fill="rgba(181, 96, 11, 0.18)"/>
                <!-- Body curve -->
                <path d="M15 12 Q8 20 10 30 Q12 40 18 48" stroke="rgba(181, 96, 11, 0.2)" stroke-width="8" fill="none" stroke-linecap="round"/>
                <!-- Belly -->
                <path d="M18 15 Q25 22 22 32 Q20 38 18 42" stroke="rgba(255, 193, 104, 0.15)" stroke-width="6" fill="none" stroke-linecap="round"/>
                <!-- Dorsal fin ridge -->
                <path d="M12 18 Q6 22 8 28 Q6 32 10 36" stroke="rgba(181, 96, 11, 0.15)" stroke-width="3" fill="none"/>
                <!-- Eye -->
                <circle cx="20" cy="7" r="2" fill="rgba(255, 255, 255, 0.3)"/>
                <!-- Crown/crest -->
                <path d="M12 4 Q14 0 16 4 Q18 1 20 5" stroke="rgba(181, 96, 11, 0.18)" stroke-width="2" fill="none"/>
                <!-- Tail curl -->
                <path d="M18 48 Q22 50 20 46 Q18 44 20 42" stroke="rgba(181, 96, 11, 0.18)" stroke-width="3" fill="none" stroke-linecap="round"/>
            </svg>
        `;
        
        const creatureObj = {
            element: seahorse,
            x: startX,
            y: config.y,
            speed: config.speed,
            size: config.size,
            waveOffset: Math.random() * Math.PI * 2,
            waveAmplitude: 2 + Math.random() * 3,
            bobOffset: Math.random() * Math.PI * 2,
            direction: 1,
            type: 'seahorse',
            partnerOffset: config.offset
        };
        
        seahorse.style.cssText = `
            position: absolute;
            width: ${config.size}px;
            height: ${config.size * 1.6}px;
            left: ${startX}%;
            top: ${config.y}%;
            opacity: 0.7;
            pointer-events: none;
            z-index: 1;
        `;
        
        this.creatures.push(creatureObj);
        this.container.appendChild(seahorse);
    }
    
    animate() {
        const tick = (timestamp) => {
            this.creatures.forEach(creature => {
                creature.x += creature.speed * 0.025;
                
                // Reset position when off screen
                if (creature.type === 'fish') {
                    if (creature.direction === 1 && creature.x > 120) {
                        creature.x = -20;
                        creature.y = 15 + Math.random() * 70;
                    } else if (creature.direction === -1 && creature.x < -20) {
                        creature.x = 120;
                        creature.y = 15 + Math.random() * 70;
                    }
                } else {
                    // Seahorse
                    if (creature.x > 120) {
                        creature.x = -20 + creature.partnerOffset;
                        creature.y = 30 + Math.random() * 40;
                    }
                }
                
                // Wave motion
                let waveY, transform;
                
                if (creature.type === 'fish') {
                    waveY = Math.sin(timestamp * 0.001 + creature.waveOffset) * creature.waveAmplitude;
                    const tailWave = Math.sin(timestamp * 0.008 + creature.tailWaveOffset) * 3;
                    transform = `scaleX(${creature.direction}) translateY(${waveY}px) rotate(${tailWave}deg)`;
                } else {
                    // Seahorse has bobbing motion
                    waveY = Math.sin(timestamp * 0.0015 + creature.waveOffset) * creature.waveAmplitude;
                    const bob = Math.sin(timestamp * 0.003 + creature.bobOffset) * 2;
                    transform = `translateY(${waveY}px) rotate(${bob}deg)`;
                }
                
                creature.element.style.left = `${creature.x}%`;
                creature.element.style.top = `${creature.y}%`;
                creature.element.style.transform = transform;
            });
            
            requestAnimationFrame(tick);
        };
        
        requestAnimationFrame(tick);
    }
}

// =============================================
// LIGHT PARTICLES
// =============================================
class LightParticles {
    constructor() {
        this.container = document.getElementById('light-particles');
        this.particles = [];
        this.particleCount = 30;
        
        if (!this.container) return;
        this.init();
    }
    
    init() {
        for (let i = 0; i < this.particleCount; i++) {
            this.createParticle(i);
        }
        this.animate();
    }
    
    createParticle(index) {
        const particle = document.createElement('div');
        particle.className = 'light-particle';
        
        const size = 2 + Math.random() * 4;
        const startX = Math.random() * 100;
        const startY = Math.random() * 100;
        const speed = 0.08 + Math.random() * 0.15;
        
        const particleObj = {
            element: particle,
            x: startX,
            y: startY,
            speed,
            size,
            twinkleOffset: Math.random() * Math.PI * 2,
            twinkleSpeed: 0.002 + Math.random() * 0.003,
            waveOffset: Math.random() * Math.PI * 2,
            waveAmplitude: 5 + Math.random() * 10
        };
        
        particle.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${startX}%;
            top: ${startY}%;
            background: radial-gradient(circle, rgba(255, 230, 180, 0.9) 0%, rgba(255, 193, 104, 0.5) 40%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 ${size * 3}px rgba(255, 200, 120, 0.4);
        `;
        
        this.particles.push(particleObj);
        this.container.appendChild(particle);
    }
    
    animate() {
        const tick = (timestamp) => {
            this.particles.forEach(p => {
                p.x -= p.speed * 0.04;
                
                if (p.x < -5) {
                    p.x = 105;
                    p.y = Math.random() * 100;
                }
                
                const waveY = Math.sin(timestamp * 0.0006 + p.waveOffset) * p.waveAmplitude;
                const twinkle = 0.3 + (Math.sin(timestamp * p.twinkleSpeed + p.twinkleOffset) * 0.5 + 0.5) * 0.7;
                
                p.element.style.left = `${p.x}%`;
                p.element.style.top = `${p.y}%`;
                p.element.style.transform = `translateY(${waveY}px)`;
                p.element.style.opacity = twinkle;
            });
            
            requestAnimationFrame(tick);
        };
        
        requestAnimationFrame(tick);
    }
}

// =============================================
// ZOOM FUNCTIONALITY
// =============================================
let zoomState = {
    scale: 1,
    minScale: 0.5,
    maxScale: 5,
    x: 0,
    y: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    lastX: 0,
    lastY: 0
};

function showZoom(id) {
    const postcard = allPostcardsData.find(p => p.id === id);
    if (!postcard) return;
    
    const modal = document.getElementById('zoom-modal');
    const img = document.getElementById('zoom-image');
    const wrapper = document.getElementById('zoom-image-wrapper');
    
    zoomState = {
        scale: 1,
        minScale: 0.5,
        maxScale: 5,
        x: 0,
        y: 0,
        isDragging: false,
        startX: 0,
        startY: 0,
        lastX: 0,
        lastY: 0
    };
    
    const imageUrl = postcard.zoom_url || postcard.grande_url || postcard.vignette_url;
    
    img.onload = function() {
        updateZoomTransform();
        updateZoomLevel();
    };
    
    img.src = imageUrl;
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    popupsOpen = true;
    
    initZoomControls();
}

function closeZoomPopup() {
    const modal = document.getElementById('zoom-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    popupsOpen = false;
    removeZoomControls();
}

function initZoomControls() {
    const wrapper = document.getElementById('zoom-image-wrapper');
    
    wrapper.addEventListener('wheel', handleWheel, { passive: false });
    wrapper.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    wrapper.addEventListener('dblclick', handleDoubleClick);
    wrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
    wrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
    wrapper.addEventListener('touchend', handleTouchEnd);
    document.addEventListener('keydown', handleZoomKeyboard);
}

function removeZoomControls() {
    const wrapper = document.getElementById('zoom-image-wrapper');
    if (!wrapper) return;
    
    wrapper.removeEventListener('wheel', handleWheel);
    wrapper.removeEventListener('mousedown', handleMouseDown);
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    wrapper.removeEventListener('dblclick', handleDoubleClick);
    wrapper.removeEventListener('touchstart', handleTouchStart);
    wrapper.removeEventListener('touchmove', handleTouchMove);
    wrapper.removeEventListener('touchend', handleTouchEnd);
    document.removeEventListener('keydown', handleZoomKeyboard);
}

function handleWheel(e) {
    e.preventDefault();
    
    const wrapper = document.getElementById('zoom-image-wrapper');
    const rect = wrapper.getBoundingClientRect();
    
    const mouseX = e.clientX - rect.left - rect.width / 2;
    const mouseY = e.clientY - rect.top - rect.height / 2;
    
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    const newScale = Math.min(Math.max(zoomState.scale + delta, zoomState.minScale), zoomState.maxScale);
    
    if (newScale !== zoomState.scale) {
        const scaleFactor = newScale / zoomState.scale;
        zoomState.x = mouseX - (mouseX - zoomState.x) * scaleFactor;
        zoomState.y = mouseY - (mouseY - zoomState.y) * scaleFactor;
        zoomState.scale = newScale;
        
        updateZoomTransform();
        updateZoomLevel();
    }
}

function handleMouseDown(e) {
    if (e.button !== 0) return;
    
    zoomState.isDragging = true;
    zoomState.startX = e.clientX - zoomState.x;
    zoomState.startY = e.clientY - zoomState.y;
    
    const wrapper = document.getElementById('zoom-image-wrapper');
    wrapper.style.cursor = 'grabbing';
    
    e.preventDefault();
}

function handleMouseMove(e) {
    if (!zoomState.isDragging) return;
    
    zoomState.x = e.clientX - zoomState.startX;
    zoomState.y = e.clientY - zoomState.startY;
    
    updateZoomTransform();
}

function handleMouseUp() {
    zoomState.isDragging = false;
    
    const wrapper = document.getElementById('zoom-image-wrapper');
    if (wrapper) {
        wrapper.style.cursor = zoomState.scale > 1 ? 'grab' : 'zoom-in';
    }
}

function handleDoubleClick(e) {
    const wrapper = document.getElementById('zoom-image-wrapper');
    const rect = wrapper.getBoundingClientRect();
    
    const mouseX = e.clientX - rect.left - rect.width / 2;
    const mouseY = e.clientY - rect.top - rect.height / 2;
    
    if (zoomState.scale < 2) {
        const targetScale = 2;
        const scaleFactor = targetScale / zoomState.scale;
        zoomState.x = mouseX - (mouseX - zoomState.x) * scaleFactor;
        zoomState.y = mouseY - (mouseY - zoomState.y) * scaleFactor;
        zoomState.scale = targetScale;
    } else {
        zoomState.scale = 1;
        zoomState.x = 0;
        zoomState.y = 0;
    }
    
    updateZoomTransform(true);
    updateZoomLevel();
}

let lastTouchDistance = 0;
let lastTouchCenter = { x: 0, y: 0 };

function handleTouchStart(e) {
    if (e.touches.length === 2) {
        lastTouchDistance = getTouchDistance(e.touches);
        lastTouchCenter = getTouchCenter(e.touches);
        e.preventDefault();
    } else if (e.touches.length === 1) {
        zoomState.isDragging = true;
        zoomState.startX = e.touches[0].clientX - zoomState.x;
        zoomState.startY = e.touches[0].clientY - zoomState.y;
        e.preventDefault();
    }
}

function handleTouchMove(e) {
    if (e.touches.length === 2) {
        const newDistance = getTouchDistance(e.touches);
        
        const scaleDelta = (newDistance - lastTouchDistance) * 0.01;
        const newScale = Math.min(Math.max(zoomState.scale + scaleDelta, zoomState.minScale), zoomState.maxScale);
        
        if (newScale !== zoomState.scale) {
            zoomState.scale = newScale;
            updateZoomTransform();
            updateZoomLevel();
        }
        
        lastTouchDistance = newDistance;
        e.preventDefault();
    } else if (e.touches.length === 1 && zoomState.isDragging) {
        zoomState.x = e.touches[0].clientX - zoomState.startX;
        zoomState.y = e.touches[0].clientY - zoomState.startY;
        updateZoomTransform();
        e.preventDefault();
    }
}

function handleTouchEnd() {
    zoomState.isDragging = false;
    lastTouchDistance = 0;
}

function getTouchDistance(touches) {
    return Math.hypot(
        touches[0].clientX - touches[1].clientX,
        touches[0].clientY - touches[1].clientY
    );
}

function getTouchCenter(touches) {
    return {
        x: (touches[0].clientX + touches[1].clientX) / 2,
        y: (touches[0].clientY + touches[1].clientY) / 2
    };
}

function handleZoomKeyboard(e) {
    if (!document.getElementById('zoom-modal').classList.contains('active')) return;
    
    switch(e.key) {
        case '+':
        case '=':
            e.preventDefault();
            zoomIn();
            break;
        case '-':
            e.preventDefault();
            zoomOut();
            break;
        case '0':
            e.preventDefault();
            resetZoom();
            break;
        case 'f':
        case 'F':
            e.preventDefault();
            fitToScreen();
            break;
        case 'Escape':
            closeZoomPopup();
            break;
    }
}

function zoomIn() {
    zoomState.scale = Math.min(zoomState.scale + 0.25, zoomState.maxScale);
    updateZoomTransform(true);
    updateZoomLevel();
}

function zoomOut() {
    zoomState.scale = Math.max(zoomState.scale - 0.25, zoomState.minScale);
    updateZoomTransform(true);
    updateZoomLevel();
}

function resetZoom() {
    zoomState.scale = 1;
    zoomState.x = 0;
    zoomState.y = 0;
    updateZoomTransform(true);
    updateZoomLevel();
}

function fitToScreen() {
    const wrapper = document.getElementById('zoom-image-wrapper');
    const img = document.getElementById('zoom-image');
    
    if (!img.naturalWidth || !img.naturalHeight) return;
    
    const wrapperRect = wrapper.getBoundingClientRect();
    const scaleX = (wrapperRect.width - 40) / img.naturalWidth;
    const scaleY = (wrapperRect.height - 40) / img.naturalHeight;
    
    zoomState.scale = Math.min(scaleX, scaleY, 1);
    zoomState.x = 0;
    zoomState.y = 0;
    
    updateZoomTransform(true);
    updateZoomLevel();
}

function updateZoomTransform(animate = false) {
    const img = document.getElementById('zoom-image');
    const wrapper = document.getElementById('zoom-image-wrapper');
    
    if (animate) {
        img.style.transition = 'transform 0.3s ease';
        setTimeout(() => { img.style.transition = ''; }, 300);
    } else {
        img.style.transition = '';
    }
    
    img.style.transform = `translate(${zoomState.x}px, ${zoomState.y}px) scale(${zoomState.scale})`;
    
    wrapper.style.cursor = zoomState.scale > 1 ? 'grab' : 'zoom-in';
}

function updateZoomLevel() {
    const levelDisplay = document.getElementById('zoom-level');
    levelDisplay.textContent = Math.round(zoomState.scale * 100) + '%';
}
 
// =============================================
// CINEMA / DIAPORAMA
// =============================================
let cinemaMode = 'mixed';
let cinemaPostcards = [];
let cinemaIndex = 0;
let cinemaPlaying = false;
let cinemaInterval = null;
const CINEMA_INTERVAL_MS = 4000;
 
function openCinema() {
    buildCinemaList();
   
    if (cinemaPostcards.length === 0) {
        alert('Aucune carte postale √† afficher');
        return;
    }
   
    cinemaIndex = 0;
    document.getElementById('cinemaModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    popupsOpen = true;
    updateCinemaDisplay();
}
 
function closeCinema() {
    stopCinemaPlay();
    document.getElementById('cinemaModal').classList.remove('active');
    document.body.style.overflow = '';
    popupsOpen = false;
   
    const video = document.getElementById('cinemaVideo');
    video.pause();
    video.removeAttribute('src');
}
 
function buildCinemaList() {
    const hasImages = p => p.vignette_url;
    const hasVideo = p => p.has_video && p.video_url;
   
    switch(cinemaMode) {
        case 'static':
            cinemaPostcards = filteredPostcards.filter(p => hasImages(p) && !hasVideo(p));
            if (cinemaPostcards.length === 0) {
                cinemaPostcards = filteredPostcards.filter(hasImages);
            }
            break;
        case 'animated':
            cinemaPostcards = filteredPostcards.filter(hasVideo);
            break;
        case 'mixed':
        default:
            cinemaPostcards = filteredPostcards.filter(p => hasImages(p) || hasVideo(p));
            break;
    }
}
 
function setCinemaMode(mode) {
    cinemaMode = mode;
   
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
   
    buildCinemaList();
    cinemaIndex = 0;
   
    if (cinemaPostcards.length === 0) {
        document.getElementById('cinemaImage').src = '';
        document.getElementById('cinemaTitle').textContent = 'Aucune carte disponible';
        return;
    }
   
    updateCinemaDisplay();
}
 
function updateCinemaDisplay() {
    if (cinemaPostcards.length === 0) return;
   
    const postcard = cinemaPostcards[cinemaIndex];
    const img = document.getElementById('cinemaImage');
    const video = document.getElementById('cinemaVideo');
    const loading = document.getElementById('cinemaLoading');
   
    document.getElementById('cinemaTitle').textContent = postcard.title;
    document.getElementById('cinemaNumber').textContent = 'N¬∞ ' + postcard.number;
    document.getElementById('cinemaCounter').textContent = `${cinemaIndex + 1} / ${cinemaPostcards.length}`;
   
    const progress = ((cinemaIndex + 1) / cinemaPostcards.length) * 100;
    document.getElementById('cinemaProgressBar').style.width = progress + '%';
   
    const showVideo = (cinemaMode === 'animated' || cinemaMode === 'mixed') && postcard.has_video && postcard.video_url;
   
    loading.style.display = 'flex';
   
    if (showVideo) {
        img.style.display = 'none';
        video.style.display = 'block';
        video.src = postcard.video_url;
        video.load();
       
        video.oncanplay = () => {
            loading.style.display = 'none';
            video.play().catch(() => {});
        };
       
        video.onerror = () => {
            loading.style.display = 'none';
            video.style.display = 'none';
            img.style.display = 'block';
            img.src = postcard.grande_url || postcard.vignette_url;
        };
    } else {
        video.pause();
        video.style.display = 'none';
        img.style.display = 'block';
       
        const imageUrl = postcard.grande_url || postcard.vignette_url;
        img.onload = () => { loading.style.display = 'none'; };
        img.onerror = () => { loading.style.display = 'none'; };
        img.src = imageUrl;
    }
}
 
function cinemaPrev() {
    if (cinemaIndex > 0) {
        cinemaIndex--;
        updateCinemaDisplay();
    }
}
 
function cinemaNext() {
    if (cinemaIndex < cinemaPostcards.length - 1) {
        cinemaIndex++;
    } else if (cinemaPlaying) {
        cinemaIndex = 0;
    }
    updateCinemaDisplay();
}
 
function toggleCinemaPlay() {
    if (cinemaPlaying) {
        stopCinemaPlay();
    } else {
        startCinemaPlay();
    }
}
 
function startCinemaPlay() {
    cinemaPlaying = true;
    document.getElementById('playIcon').style.display = 'none';
    document.getElementById('pauseIcon').style.display = 'block';
    cinemaInterval = setInterval(cinemaNext, CINEMA_INTERVAL_MS);
}
 
function stopCinemaPlay() {
    cinemaPlaying = false;
    document.getElementById('playIcon').style.display = 'block';
    document.getElementById('pauseIcon').style.display = 'none';
   
    if (cinemaInterval) {
        clearInterval(cinemaInterval);
        cinemaInterval = null;
    }
}
 
// =============================================
// DETAIL POPUP
// =============================================
function showDetail(id) {
    const postcard = filteredPostcards.find(p => p.id === id) || allPostcardsData.find(p => p.id === id);
    if (!postcard) return;
   
    currentPostcardId = id;
    currentIndex = filteredPostcards.findIndex(p => p.id === id);
    if (currentIndex === -1) currentIndex = 0;
    currentView = 'front';
   
    document.getElementById('popup-image').src = postcard.grande_url || postcard.vignette_url;
    document.getElementById('popup-title').textContent = postcard.title;
    document.getElementById('popup-number').textContent = 'N¬∞ ' + postcard.number;
    document.getElementById('popup-like-count-img').textContent = postcard.likes_count || 0;
   
    // Update send button link
    const sendBtn = document.getElementById('popup-send-img-btn');
    sendBtn.href = `/la-poste/?postcard=${id}`;
   
    // Update video button
    const videoBtn = document.getElementById('popup-video-img-btn');
    if (postcard.has_video) {
        videoBtn.style.display = 'flex';
        videoBtn.href = '/cp-animes/?highlight=' + id;
    } else {
        videoBtn.style.display = 'none';
    }
    
    document.getElementById('popup-flip').style.display = postcard.dos_url ? 'flex' : 'none';
   
    const cardLikeBtn = document.querySelector(`.like-btn[data-id="${id}"]`);
    const popupLikeBtn = document.getElementById('popup-like-img-btn');
    popupLikeBtn.classList.toggle('liked', cardLikeBtn?.classList.contains('liked'));
   
    document.getElementById('popup-overlay').classList.add('active');
    document.getElementById('popup-detail').classList.add('active');
    document.body.style.overflow = 'hidden';
    popupsOpen = true;
   
    updateNavButtons();
}
 
function closeDetailPopup() {
    document.getElementById('popup-overlay').classList.remove('active');
    document.getElementById('popup-detail').classList.remove('active');
    document.body.style.overflow = '';
    popupsOpen = false;
}
 
function togglePostcardSide() {
    const postcard = filteredPostcards[currentIndex];
    if (!postcard) return;
   
    const img = document.getElementById('popup-image');
    const flipBtn = document.getElementById('popup-flip');
   
    if (currentView === 'front' && postcard.dos_url) {
        img.src = postcard.dos_url;
        currentView = 'back';
        flipBtn.classList.add('flipped');
    } else {
        img.src = postcard.grande_url || postcard.vignette_url;
        currentView = 'front';
        flipBtn.classList.remove('flipped');
    }
}
 
function previousImage() {
    if (currentIndex > 0) {
        currentIndex--;
        updatePopup();
    }
}
 
function nextImage() {
    if (currentIndex < filteredPostcards.length - 1) {
        currentIndex++;
        updatePopup();
    }
}
 
function updatePopup() {
    const postcard = filteredPostcards[currentIndex];
    if (!postcard) return;
   
    currentPostcardId = postcard.id;
    currentView = 'front';
    document.getElementById('popup-image').src = postcard.grande_url || postcard.vignette_url;
    document.getElementById('popup-title').textContent = postcard.title;
    document.getElementById('popup-number').textContent = 'N¬∞ ' + postcard.number;
    document.getElementById('popup-like-count-img').textContent = postcard.likes_count || 0;
    
    const sendBtn = document.getElementById('popup-send-img-btn');
    sendBtn.href = `/la-poste/?postcard=${postcard.id}`;
    
    const videoBtn = document.getElementById('popup-video-img-btn');
    if (postcard.has_video) {
        videoBtn.style.display = 'flex';
        videoBtn.href = '/cp-animes/?highlight=' + postcard.id;
    } else {
        videoBtn.style.display = 'none';
    }
    
    document.getElementById('popup-flip').style.display = postcard.dos_url ? 'flex' : 'none';
    document.getElementById('popup-flip').classList.remove('flipped');
   
    updateNavButtons();
}
 
function updateNavButtons() {
    document.getElementById('popup-prev').style.display = currentIndex > 0 ? 'flex' : 'none';
    document.getElementById('popup-next').style.display = currentIndex < filteredPostcards.length - 1 ? 'flex' : 'none';
}
 
// =============================================
// LIKES
// =============================================
async function toggleLike(event, postcardId) {
    event.stopPropagation();
   
    try {
        const formData = new FormData();
        formData.append('is_animated', 'false');
       
        const response = await fetch(`/api/postcard/${postcardId}/like/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
       
        const data = await response.json();
       
        if (data.success) {
            const cardBtn = document.querySelector(`.like-btn[data-id="${postcardId}"]`);
            if (cardBtn) {
                cardBtn.classList.toggle('liked', data.liked);
                const svg = cardBtn.querySelector('svg');
                svg.setAttribute('fill', data.liked ? 'currentColor' : 'none');
            }
           
            if (currentPostcardId === postcardId) {
                const popupBtn = document.getElementById('popup-like-img-btn');
                popupBtn.classList.toggle('liked', data.liked);
                document.getElementById('popup-like-count-img').textContent = data.likes_count;
            }
           
            const postcard = allPostcardsData.find(p => p.id === postcardId);
            if (postcard) postcard.likes_count = data.likes_count;
        }
    } catch (error) {
        console.error('Like error:', error);
    }
}
 
function togglePopupLike() {
    if (currentPostcardId) {
        toggleLike({stopPropagation: () => {}}, currentPostcardId);
    }
}
 
// =============================================
// IMAGE LOADING
// =============================================
class ImageLoader {
    constructor() {
        this.observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    this.loadImage(entry.target);
                    this.observer.unobserve(entry.target);
                }
            });
        }, {
            rootMargin: '100px',
            threshold: 0.1
        });
       
        document.querySelectorAll('.card-image[data-src]').forEach(img => {
            this.observer.observe(img);
        });
    }
   
    loadImage(img) {
        const src = img.dataset.src;
        if (!src) return;
       
        img.src = src;
       
        img.onload = () => {
            img.classList.add('loaded');
            const placeholder = img.closest('.card-image-wrapper')?.querySelector('.card-placeholder');
            if (placeholder) placeholder.classList.add('hidden');
        };
       
        img.onerror = () => {
            const placeholder = img.closest('.card-image-wrapper')?.querySelector('.card-placeholder');
            if (placeholder) placeholder.classList.add('hidden');
        };
    }
}
 
// =============================================
// LOADING
// =============================================
class LoadingManager {
    constructor() {
        this.overlay = document.getElementById('loading-overlay');
        this.bar = document.getElementById('loading-bar');
        this.startTime = Date.now();
    }
   
    start() {
        let progress = 0;
        const tick = () => {
            progress += (100 - progress) * 0.15;
            this.bar.style.width = progress + '%';
            if (progress < 95) requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
    }
   
    hide() {
        const elapsed = Date.now() - this.startTime;
        const remaining = Math.max(0, 400 - elapsed);
       
        setTimeout(() => {
            this.bar.style.width = '100%';
            setTimeout(() => {
                this.overlay.classList.add('hidden');
            }, 100);
        }, remaining);
    }
}
 
// =============================================
// KEYBOARD NAVIGATION
// =============================================
document.addEventListener('keydown', (e) => {
    // Cinema modal
    if (document.getElementById('cinemaModal').classList.contains('active')) {
        if (e.key === 'ArrowLeft') cinemaPrev();
        else if (e.key === 'ArrowRight') cinemaNext();
        else if (e.key === ' ') { e.preventDefault(); toggleCinemaPlay(); }
        else if (e.key === 'Escape') closeCinema();
        return;
    }
    
    // Zoom modal
    if (document.getElementById('zoom-modal').classList.contains('active')) {
        return;
    }
   
    // Detail popup
    if (document.getElementById('popup-detail').classList.contains('active')) {
        if (e.key === 'ArrowLeft') previousImage();
        else if (e.key === 'ArrowRight') nextImage();
        else if (e.key === 'Escape') closeDetailPopup();
        return;
    }
});

// Click on overlay to close detail popup
document.getElementById('popup-overlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDetailPopup();
    }
});
 
// =============================================
// INITIALIZE
// =============================================
document.addEventListener('DOMContentLoaded', () => {
    const loadingManager = new LoadingManager();
    loadingManager.start();
   
    window.searchEngine = new SimpleSearchEngine();
    window.floatingKeywords = new FloatingKeywords();
    window.aquaticLife = new AquaticLifeManager();
    window.lightParticles = new LightParticles();
    new ImageLoader();
   
    if (document.getElementById('searchInput').value.trim()) {
        document.getElementById('river-keywords-section').classList.add('searching');
    }
   
    window.addEventListener('load', () => loadingManager.hide());
    setTimeout(() => loadingManager.hide(), 1000);
});
</script>
 
<style>
/* ========================================
   BASE & LOADING
   ======================================== */
.loading-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: #1a1208;
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.3s ease;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-content { text-align: center; }
.loading-spinner {
    width: 40px; height: 40px; margin: 0 auto 15px;
    border: 3px solid rgba(181, 96, 11, 0.2);
    border-top-color: #b5600b; border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-bottom: 12px; }
.loading-progress { width: 150px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 0 auto; }
.loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #b5600b, #ffc168); transition: width 0.1s; }
 
/* ========================================
   RIVER BACKGROUND
   ======================================== */
.river-background {
    position: fixed; inset: 0; z-index: 0;
    background: linear-gradient(180deg, #1a1208 0%, #2d1f0d 30%, #3d2a12 50%, #2d1f0d 70%, #1a1208 100%);
    overflow: hidden;
}
 
.river-gradient {
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at 20% 30%, rgba(255, 180, 50, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(181, 96, 11, 0.06) 0%, transparent 50%);
    z-index: 1;
}

/* Fish Container - Behind waves */
.fish-container {
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    overflow: hidden;
}

.swimming-creature {
    position: absolute;
    pointer-events: none;
    will-change: transform, left, top;
}

.swimming-fish svg,
.swimming-seahorse svg {
    width: 100%;
    height: 100%;
}

/* Back Wave - Slower, Brighter */
.waves-svg.waves-back {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    min-height: 250px;
    z-index: 3;
}

.waves-svg.waves-back .wave-back {
    opacity: 0.6;
}

/* Front Wave - Original */
.waves-svg.waves-front {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 40%;
    min-height: 200px;
    z-index: 4;
}
 
.wave { opacity: 0.4; }

/* Light Particles */
.light-particles {
    position: absolute;
    inset: 0;
    z-index: 5;
    pointer-events: none;
    overflow: hidden;
}

.light-particle {
    position: absolute;
    pointer-events: none;
    will-change: transform, opacity;
}
 
.river-particles { position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 6; }
 
/* ========================================
   BUBBLE POP EFFECT
   ======================================== */
.bubble-pop-container {
    position: fixed;
    inset: 0;
    z-index: 9998;
    pointer-events: none;
    overflow: hidden;
}

.bubble-particle {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255, 220, 180, 0.9), rgba(181, 96, 11, 0.6));
    border: 1px solid rgba(255, 255, 255, 0.4);
    animation: bubblePop 0.6s ease-out forwards;
    pointer-events: none;
}

@keyframes bubblePop {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    100% {
        transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0);
        opacity: 0;
    }
}

.bubble-burst {
    position: absolute;
    width: 80px;
    height: 80px;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 193, 104, 0.5) 0%, transparent 70%);
    animation: burstExpand 0.5s ease-out forwards;
    pointer-events: none;
}

@keyframes burstExpand {
    0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
    }
}

/* ========================================
   BROWSE PAGE
   ======================================== */
.browse-page { position: relative; z-index: 1; min-height: 100vh; padding-top: 70px; }
 
/* Search */
.search-section { padding: 20px 20px 10px; text-align: center; }
.search-form { max-width: 500px; margin: 0 auto; }
.search-box {
    display: flex; align-items: center;
    background: rgba(255,255,255,0.95);
    border-radius: 40px; overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transition: box-shadow 0.3s;
}
.search-box:focus-within { box-shadow: 0 6px 30px rgba(181, 96, 11, 0.4); }
 
#searchInput {
    flex: 1; padding: 14px 20px; border: none; background: transparent;
    font-size: 1rem; color: #333; outline: none;
}
#searchInput::placeholder { color: #999; }
 
.clear-btn {
    width: 36px; height: 36px; margin-right: 4px;
    background: rgba(0,0,0,0.1); border: none; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    opacity: 0; visibility: hidden; transform: scale(0.8);
}
 
.clear-btn.visible { opacity: 1; visibility: visible; transform: scale(1); }
.clear-btn:hover { background: rgba(220, 53, 69, 0.2); }
.clear-btn:hover svg { stroke: #dc3545; }
.clear-btn svg { stroke: #666; transition: stroke 0.2s; }
 
.search-submit {
    width: 50px; height: 50px; margin: 3px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.search-submit:hover { transform: scale(1.05); }
.search-submit svg { stroke: white; }
 
.search-info { margin-top: 12px; }
.search-results-text { color: rgba(255,255,255,0.8); font-size: 0.9rem; }
.search-results-text.no-results-text { color: rgba(255, 150, 150, 0.8); }
.result-count { color: #ffc168; font-weight: 600; }
.result-query { color: #b5600b; }
 
/* ========================================
   CINEMA BUTTON
   ======================================== */
.cinema-launcher {
    max-width: 600px;
    margin: 25px auto;
    padding: 0 20px;
}
 
.cinema-big-btn {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 18px 25px;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.12), rgba(181, 96, 11, 0.05));
    border: 2px solid rgba(181, 96, 11, 0.35);
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
}
 
.cinema-big-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    opacity: 0;
    transition: opacity 0.4s ease;
}
 
.cinema-big-btn:hover::before { opacity: 1; }
 
.cinema-big-btn:hover {
    border-color: #b5600b;
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(181, 96, 11, 0.35);
}
 
.cinema-btn-icon {
    position: relative; z-index: 1;
    width: 55px; height: 55px;
    background: rgba(181, 96, 11, 0.25);
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.4s ease;
}
 
.cinema-big-btn:hover .cinema-btn-icon { background: rgba(255, 255, 255, 0.2); }
.cinema-btn-icon svg { stroke: #ffc168; transition: stroke 0.4s ease; }
.cinema-big-btn:hover .cinema-btn-icon svg { stroke: white; }
 
.cinema-btn-text { position: relative; z-index: 1; flex: 1; text-align: left; }
.cinema-btn-title { display: block; color: white; font-size: 1.3rem; font-weight: 600; margin-bottom: 3px; }
.cinema-btn-subtitle { display: block; color: rgba(255, 255, 255, 0.55); font-size: 0.85rem; }
.cinema-big-btn:hover .cinema-btn-subtitle { color: rgba(255, 255, 255, 0.9); }
 
.cinema-btn-arrow { position: relative; z-index: 1; transition: transform 0.4s ease; }
.cinema-btn-arrow svg { stroke: #b5600b; transition: stroke 0.4s ease; }
.cinema-big-btn:hover .cinema-btn-arrow { transform: translateX(5px); }
.cinema-big-btn:hover .cinema-btn-arrow svg { stroke: white; }
 
/* ========================================
   FLOATING RIVER KEYWORDS SECTION
   ======================================== */
.river-keywords-section {
    position: relative;
    max-width: 100%;
    margin: 0 auto 30px;
    padding: 0;
    overflow: hidden;
    transition: all 0.5s ease;
}
 
.river-keywords-section.searching {
    height: 0;
    margin: 0;
    opacity: 0;
    pointer-events: none;
}
 
.river-keywords-header {
    text-align: center;
    padding: 0 20px 15px;
    position: relative;
    z-index: 2;
}
 
.river-keywords-header h3 {
    color: white;
    font-size: 1.1rem;
    margin-bottom: 5px;
}
 
.river-keywords-header p {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
}
 
.river-keywords-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}
 
/* Floating Keywords with oscillating wavy borders */
.floating-keyword {
    position: absolute;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
    color: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    white-space: nowrap;
    font-family: inherit;
    border: 2px solid rgba(255, 255, 255, 0.15);
    transition: transform 0.3s ease, background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    will-change: transform, left, top, opacity, border-radius;
}

.bubble-keyword {
    padding: 12px 24px;
    box-shadow: 
        inset 0 0 20px rgba(255, 255, 255, 0.05),
        0 2px 10px rgba(0, 0, 0, 0.2);
}

.keyword-text {
    position: relative;
    z-index: 1;
}

/* Hover - slight scale, no vertical movement */
.floating-keyword:hover {
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.5), rgba(181, 96, 11, 0.3));
    border-color: rgba(255, 193, 104, 0.6);
    color: white;
    text-shadow: 0 0 15px rgba(255, 193, 104, 0.8);
    z-index: 10;
    transform: scale(1.08) !important;
    box-shadow: 
        inset 0 0 25px rgba(255, 193, 104, 0.15),
        0 4px 20px rgba(181, 96, 11, 0.4);
}

.floating-keyword.popping {
    animation: keywordPop 0.4s ease-out forwards;
}

@keyframes keywordPop {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.3);
        opacity: 0.8;
    }
    100% {
        transform: scale(0);
        opacity: 0;
    }
}
 
/* Keyword sizes */
.keyword-large {
    padding: 14px 28px;
    font-size: 1.1rem;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.25), rgba(181, 96, 11, 0.1));
    border-color: rgba(181, 96, 11, 0.35);
    box-shadow: 
        inset 0 0 30px rgba(255, 193, 104, 0.1),
        0 4px 20px rgba(181, 96, 11, 0.25);
}
 
.keyword-medium {
    padding: 11px 22px;
    font-size: 0.95rem;
    font-weight: 500;
}
 
.keyword-small {
    padding: 9px 18px;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
}
 
/* ========================================
   PAGINATION
   ======================================== */
.pagination-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin: 40px 0;
    padding: 0 20px;
}

.pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}

.page-btn {
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    color: white;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.page-btn:hover:not(.disabled) {
    background: rgba(181, 96, 11, 0.4);
    border-color: #b5600b;
    transform: translateY(-2px);
}

.page-btn.active {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-color: #b5600b;
    font-weight: 600;
}

.page-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.page-btn.page-prev,
.page-btn.page-next {
    padding: 0;
}

.page-ellipsis {
    color: rgba(255, 255, 255, 0.5);
    padding: 0 8px;
}

.page-info {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

/* ========================================
   CINEMA MODAL
   ======================================== */
.cinema-modal {
    position: fixed; inset: 0; z-index: 5000;
    display: none; align-items: center; justify-content: center;
}
.cinema-modal.active { display: flex; }
.cinema-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.97); }
 
.cinema-container {
    position: relative; width: 95%; max-width: 1000px;
    display: flex; flex-direction: column; align-items: center;
}
 
.cinema-close {
    position: absolute; top: -50px; right: 0;
    width: 44px; height: 44px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.cinema-close:hover { background: #b5600b; border-color: #b5600b; transform: rotate(90deg); }
 
.cinema-screen {
    position: relative; width: 100%; max-height: 60vh;
    display: flex; align-items: center; justify-content: center;
    background: #000; border-radius: 8px; overflow: hidden;
}
.cinema-media { max-width: 100%; max-height: 60vh; border-radius: 8px; }
.cinema-loading {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.8);
}
.cinema-spinner {
    width: 36px; height: 36px;
    border: 3px solid rgba(255,255,255,0.2);
    border-top-color: #b5600b; border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
 
.cinema-info {
    text-align: center; padding: 15px;
    display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;
}
.cinema-info h3 { color: white; font-size: 1rem; margin: 0; }
.cinema-info span { color: rgba(255,255,255,0.6); font-size: 0.85rem; }
.cinema-counter {
    background: rgba(181, 96, 11, 0.3); padding: 4px 12px;
    border-radius: 15px; font-size: 0.8rem;
}
 
.cinema-controls { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
.cinema-nav-btn {
    width: 44px; height: 44px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.cinema-nav-btn:hover { background: rgba(181, 96, 11, 0.5); border-color: #b5600b; }
.cinema-play-btn {
    width: 56px; height: 56px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.cinema-play-btn:hover { transform: scale(1.08); }
 
.cinema-mode-selector { display: flex; gap: 6px; margin: 12px 0; }
.mode-btn {
    display: flex; align-items: center; gap: 5px;
    padding: 8px 14px;
    background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px; color: rgba(255,255,255,0.7); font-size: 0.8rem;
    cursor: pointer; transition: all 0.3s;
}
.mode-btn:hover { background: rgba(181, 96, 11, 0.3); border-color: rgba(181, 96, 11, 0.5); }
.mode-btn.active { background: #b5600b; border-color: #b5600b; color: white; }
.mode-btn svg { stroke: currentColor; }
 
.cinema-progress { width: 100%; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; }
.cinema-progress-bar { height: 100%; background: linear-gradient(90deg, #b5600b, #ffc168); border-radius: 2px; transition: width 0.3s; width: 0%; }
 
/* ========================================
   RESULTS GRID
   ======================================== */
.results-section { padding: 20px; max-width: 1400px; margin: 0 auto; }
 
.postcards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
}
 
.postcard-card {
    position: relative; border-radius: 12px; overflow: hidden;
    background: rgba(30, 25, 20, 0.8);
    border: 1px solid rgba(181, 96, 11, 0.2);
    transition: all 0.3s;
    cursor: pointer;
}
.postcard-card:hover {
    transform: translateY(-5px);
    border-color: #b5600b;
    box-shadow: 0 10px 30px rgba(181, 96, 11, 0.3);
}
 
.card-image-wrapper { position: relative; aspect-ratio: 4/3; overflow: hidden; background: #1a1208; }
.card-image { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
.card-image.loaded { opacity: 1; }
.card-placeholder {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.1), rgba(181, 96, 11, 0.05));
}
.card-placeholder.hidden { display: none; }
.placeholder-spinner {
    width: 24px; height: 24px;
    border: 2px solid rgba(181, 96, 11, 0.3);
    border-top-color: #b5600b; border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
.card-no-image {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0, 0, 0, 0.3);
}

/* Static animation badge */
.animated-badge-static {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 5;
}

.animated-badge-static svg {
    width: 14px;
    height: 14px;
}
 
.card-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 60%);
    display: flex; flex-direction: column; justify-content: flex-end;
    padding: 15px;
    opacity: 0;
    transition: opacity 0.3s;
}
.postcard-card:hover .card-overlay { opacity: 1; }
 
.card-actions { display: flex; gap: 8px; margin-bottom: 10px; }
.action-btn {
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    text-decoration: none;
}
.action-btn:hover { background: #b5600b; border-color: #b5600b; transform: scale(1.1); }
.action-btn.liked { background: rgba(255, 100, 100, 0.3); border-color: #ff6b6b; color: #ff6b6b; }
.action-btn.action-video { background: rgba(181, 96, 11, 0.4); border-color: #b5600b; }
.action-btn.action-video:hover { background: #b5600b; }
 
.card-title { color: white; font-size: 0.85rem; margin-bottom: 4px; line-height: 1.3; }
.card-number { color: #b5600b; font-size: 0.75rem; }
 
.no-results {
    grid-column: 1 / -1;
    text-align: center; padding: 60px 20px;
}
.no-results h3 { color: white; margin: 15px 0 8px; }
.no-results p { color: rgba(255,255,255,0.6); margin-bottom: 20px; }
.reset-btn {
    padding: 10px 25px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 20px;
    color: white; cursor: pointer;
    transition: all 0.3s;
}
.reset-btn:hover { transform: scale(1.05); }

.no-results-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
}

.no-results-message h3 {
    color: white;
    margin: 15px 0 8px;
}

.no-results-message p {
    color: rgba(255, 255, 255, 0.6);
}
 
.browse-footer { text-align: center; padding: 30px; color: rgba(255,255,255,0.5); font-size: 0.85rem; }
 
/* ========================================
   DETAIL POPUP
   ======================================== */
.popup-overlay {
    position: fixed; inset: 0; z-index: 3000;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(5px);
    opacity: 0; visibility: hidden;
    transition: all 0.3s;
}
.popup-overlay.active { opacity: 1; visibility: visible; }
 
.popup-modal {
    position: fixed; z-index: 3001;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    opacity: 0; visibility: hidden;
    transition: all 0.3s;
}
.popup-modal.active { opacity: 1; visibility: visible; }

#popup-detail {
    max-width: 90vw;
}
 
.popup-close {
    position: absolute; top: -45px; right: 0;
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.popup-close:hover { background: #b5600b; border-color: #b5600b; transform: rotate(90deg); }
 
.popup-flip {
    position: absolute; top: -45px; left: 0;
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.popup-flip:hover { background: #b5600b; border-color: #b5600b; }
.popup-flip.flipped { background: #b5600b; border-color: #b5600b; }
.popup-flip svg { transition: transform 0.3s; }
.popup-flip.flipped svg { transform: rotate(180deg); }
 
.popup-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 44px; height: 44px;
    background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%; color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.popup-nav:hover { background: #b5600b; border-color: #b5600b; }
.popup-prev { left: -60px; }
.popup-next { right: -60px; }
 
.popup-image-container {
    position: relative;
    max-width: 80vw; max-height: 70vh;
    display: flex; align-items: center; justify-content: center;
}
#popup-image {
    max-width: 100%; max-height: 70vh;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

/* Actions on image - bottom left */
.popup-image-actions {
    position: absolute;
    bottom: 15px;
    left: 15px;
    display: flex;
    gap: 10px;
    z-index: 10;
}

.popup-img-action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 14px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
    text-decoration: none;
}

.popup-img-action-btn:hover {
    background: rgba(181, 96, 11, 0.8);
    border-color: #b5600b;
    transform: translateY(-2px);
}

.popup-img-action-btn.liked {
    background: rgba(255, 100, 100, 0.5);
    border-color: #ff6b6b;
}

.popup-img-action-btn.liked svg {
    fill: #ff6b6b;
}

.popup-send-img-btn:hover svg {
    transform: translateX(2px) translateY(-2px);
}

.popup-send-img-btn svg {
    transition: transform 0.3s;
}

.popup-video-img-btn {
    background: rgba(181, 96, 11, 0.6);
    border-color: rgba(255, 193, 104, 0.5);
}

.popup-video-img-btn:hover {
    background: #b5600b;
}
 
.popup-info {
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.9), rgba(209, 135, 44, 0.9));
    padding: 15px 20px;
    border-radius: 0 0 8px 8px;
    display: flex; align-items: center; gap: 15px;
}

#popup-title { color: white; font-size: 1rem; margin: 0; flex: 1; }
#popup-number { color: rgba(255,255,255,0.8); font-size: 0.85rem; }
 
/* ========================================
   ENHANCED ZOOM MODAL
   ======================================== */
.zoom-modal {
    position: fixed;
    inset: 0;
    z-index: 6000;
    display: none;
    align-items: center;
    justify-content: center;
}

.zoom-modal.active {
    display: flex;
}

.zoom-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
}

.zoom-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.zoom-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 10;
}

.zoom-close-btn:hover {
    background: #b5600b;
    border-color: #b5600b;
    transform: rotate(90deg);
}

.zoom-image-wrapper {
    position: relative;
    width: 100%;
    height: calc(100% - 100px);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    cursor: zoom-in;
}

#zoom-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    transform-origin: center center;
    transition: none;
    user-select: none;
    -webkit-user-drag: none;
}

/* Zoom Toolbar */
.zoom-toolbar {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px 20px;
    border-radius: 30px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.zoom-tool-btn {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.zoom-tool-btn:hover {
    background: #b5600b;
    border-color: #b5600b;
    transform: scale(1.1);
}

.zoom-tool-btn svg {
    stroke: white;
}

.zoom-level {
    color: white;
    font-size: 0.9rem;
    min-width: 50px;
    text-align: center;
    font-weight: 600;
}

.zoom-separator {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.2);
    margin: 0 5px;
}

.zoom-instructions {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
    text-align: center;
    white-space: nowrap;
}
 
/* ========================================
   RESPONSIVE
   ======================================== */
@media (max-width: 768px) {
    .cinema-launcher { margin: 20px 15px; }
    .cinema-big-btn { padding: 15px 20px; gap: 15px; }
    .cinema-btn-icon { width: 50px; height: 50px; }
    .cinema-btn-icon svg { width: 36px; height: 36px; }
    .cinema-btn-title { font-size: 1.2rem; }
   
    .river-keywords-container { height: 150px; }
    .keyword-large { padding: 12px 22px; font-size: 1rem; }
    .keyword-medium { padding: 10px 18px; font-size: 0.9rem; }
    .keyword-small { padding: 8px 14px; font-size: 0.8rem; }
   
    .postcards-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
   
    .popup-nav { display: none; }
    .popup-flip { top: 10px; left: 10px; }
    .popup-close { top: 10px; right: 10px; }
    
    .popup-image-actions {
        bottom: 10px;
        left: 10px;
        gap: 8px;
    }
    
    .popup-img-action-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
    }
    
    .popup-img-action-btn span {
        display: none;
    }
   
    .cinema-mode-selector { flex-wrap: wrap; justify-content: center; }
    .mode-btn { padding: 6px 10px; font-size: 0.75rem; }
    
    .zoom-toolbar {
        padding: 8px 15px;
        gap: 8px;
        bottom: 70px;
    }
    
    .zoom-tool-btn {
        width: 36px;
        height: 36px;
    }
    
    .zoom-instructions {
        display: none;
    }
    
    .popup-info {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .pagination {
        gap: 5px;
    }
    
    .page-btn {
        min-width: 36px;
        height: 36px;
        font-size: 0.85rem;
    }
}
 
@media (max-width: 480px) {
    .postcards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .card-actions { gap: 5px; }
    .action-btn { width: 32px; height: 32px; }
   
    .cinema-big-btn { flex-direction: column; text-align: center; }
    .cinema-btn-arrow { display: none; }
   
    .river-keywords-container { height: 120px; }
    .keyword-small { display: none; }
    
    .animated-badge-static {
        width: 24px;
        height: 24px;
    }
    
    .animated-badge-static svg {
        width: 12px;
        height: 12px;
    }
    
    .zoom-toolbar {
        width: calc(100% - 40px);
        justify-content: center;
    }
    
    .popup-image-actions {
        flex-direction: column;
        gap: 6px;
    }
    
    .popup-img-action-btn {
        padding: 8px 10px;
    }
}
</style>
{% endblock %}