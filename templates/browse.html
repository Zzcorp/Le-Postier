<!-- templates/browse.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}Rechercher{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <p class="loading-text">Chargement de la collection...</p>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
    </div>
</div>

<!-- Cinema Diaporama Modal -->
<div class="cinema-modal" id="cinemaModal">
    <div class="cinema-backdrop" onclick="closeCinema()"></div>
    <div class="cinema-container">
        <button class="cinema-close" onclick="closeCinema()">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
        
        <div class="cinema-screen">
            <img id="cinemaImage" src="" alt="Diaporama" class="cinema-media">
            <video id="cinemaVideo" src="" muted loop class="cinema-media" style="display:none;"></video>
        </div>
        
        <div class="cinema-info">
            <h3 id="cinemaTitle"></h3>
            <span id="cinemaNumber"></span>
            <span id="cinemaCounter"></span>
        </div>
        
        <div class="cinema-controls">
            <button class="cinema-nav" id="cinemaPrev" onclick="cinemaPrev()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </button>
            
            <button class="cinema-play" id="cinemaPlayBtn" onclick="toggleCinemaPlay()">
                <svg id="playIcon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg id="pauseIcon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                    <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                </svg>
            </button>
            
            <button class="cinema-nav" id="cinemaNext" onclick="cinemaNext()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                </svg>
            </button>
        </div>
        
        <div class="cinema-mode-toggle">
            <button class="mode-btn active" data-mode="images" onclick="setCinemaMode('images')">
                üñºÔ∏è Images
            </button>
            <button class="mode-btn" data-mode="animated" onclick="setCinemaMode('animated')">
                üé¨ Anim√©es
            </button>
            <button class="mode-btn" data-mode="both" onclick="setCinemaMode('both')">
                ‚ú® Les deux
            </button>
        </div>
        
        <div class="cinema-progress">
            <div class="progress-bar" id="cinemaProgressBar"></div>
        </div>
    </div>
</div>

<!-- River Background Animation -->
<div class="river-background" id="river-background">
    <div class="river-gradient"></div>
    <div class="river-waves">
        <svg class="wave" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path d="M0,160L48,176C96,192,192,224,288,213.3C384,203,480,149,576,138.7C672,128,768,160,864,181.3C960,203,1056,213,1152,197.3C1248,181,1344,139,1392,117.3L1440,96L1440,320L0,320Z"></path>
        </svg>
        <svg class="wave wave-2" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path d="M0,64L48,96C96,128,192,192,288,202.7C384,213,480,171,576,149.3C672,128,768,128,864,149.3C960,171,1056,213,1152,218.7C1248,224,1344,192,1392,176L1440,160L1440,320L0,320Z"></path>
        </svg>
    </div>
    <div class="river-particles" id="river-particles"></div>
    <div class="river-lights" id="river-lights"></div>
</div>

<div class="browse-page">
    <!-- Search Section -->
    <div class="search-section">
        <form id="searchForm" class="search-form" method="get" action="{% url 'browse' %}">
            <div class="search-box">
                <input type="text" 
                       name="keywords_input" 
                       id="searchInput" 
                       value="{{ query|default:'' }}" 
                       placeholder="Rechercher dans la collection..."
                       autocomplete="off">
                <button type="submit" aria-label="Rechercher">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
            <div class="search-suggestions" id="searchSuggestions"></div>
        </form>
        
        <div class="search-info" id="searchInfo">
            {% if query %}
            <p class="search-results-text">
                <span class="result-count">{{ total_count }}</span> r√©sultat{{ total_count|pluralize }} pour "<span class="result-query">{{ query }}</span>"
                <button class="clear-search" onclick="clearSearch()">‚úï Effacer</button>
            </p>
            {% endif %}
        </div>
        
        <!-- Cinema Button -->
        <button class="cinema-trigger" id="cinemaTrigger" onclick="openCinema()" title="Lancer le diaporama">
            <img src="{% static 'images/cinema.png' %}" alt="Diaporama">
            <span>Diaporama</span>
        </button>
    </div>

    <!-- Floating Words Section -->
    <div class="floating-words-section" id="floating-words-section">
        <div class="words-container" id="words-container"></div>
        <div class="section-hint">
            <p>‚ú® Cliquez sur un mot pour l'ajouter √† votre recherche ‚ú®</p>
        </div>
    </div>

    <!-- Results Grid -->
    <div class="results-section" id="results-section">
        <div class="postcards-grid" id="postcards-grid">
            {% for postcard in postcards %}
            <div class="postcard-card" 
                 data-id="{{ postcard.id }}"
                 data-number="{{ postcard.number }}"
                 data-title="{{ postcard.title|lower }}"
                 data-keywords="{{ postcard.keywords|lower }}"
                 data-vignette="{{ postcard.vignette_url }}"
                 data-grande="{{ postcard.grande_url }}"
                 data-animated="{{ postcard.animated_url|default:'' }}">
                <div class="card-image-wrapper">
                    {% if postcard.vignette_url %}
                    <img class="card-image" 
                         data-src="{{ postcard.vignette_url }}" 
                         alt="{{ postcard.title }}"
                         loading="lazy">
                    <video class="card-video" 
                           data-src="{{ postcard.animated_url|default:'' }}"
                           muted 
                           loop 
                           playsinline></video>
                    <div class="card-placeholder">
                        <div class="placeholder-spinner"></div>
                    </div>
                    {% else %}
                    <div class="card-no-image">
                        <span>üì∑</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-overlay">
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetail({{ postcard.id }})" title="Voir d√©tails">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        <button class="action-btn" onclick="showZoom({{ postcard.id }})" title="Zoom">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                                <path d="M11 8v6M8 11h6"></path>
                            </svg>
                        </button>
                        {% if postcard.animated_url %}
                        <button class="action-btn action-play" onclick="playAnimated({{ postcard.id }})" title="Animation">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    <p class="card-title">{{ postcard.title|truncatechars:50 }}</p>
                    <span class="card-number">N¬∞ {{ postcard.number }}</span>
                </div>
                {% if postcard.animated_url %}
                <div class="animated-badge">üé¨</div>
                {% endif %}
            </div>
            {% empty %}
            <div class="no-results-placeholder"></div>
            {% endfor %}
        </div>
        
        <div class="no-results" id="noResults" style="display:none;">
            <div class="no-results-icon">üîç</div>
            <h3>Aucun r√©sultat</h3>
            <p>Essayez d'autres mots-cl√©s</p>
        </div>
    </div>
    
    <div class="browse-footer">
        <p><span id="visible-count">{{ postcards|length }}</span> cartes postales affich√©es sur {{ total_count }}</p>
    </div>
</div>

<!-- Detail Popup -->
<div class="popup-overlay" id="popup-overlay" onclick="closeAllPopups()"></div>

<div class="popup-modal" id="popup-detail">
    <button class="popup-close" onclick="closeAllPopups()">√ó</button>
    <button class="popup-flip" onclick="togglePostcardSide()" title="Voir le verso">üîÑ</button>
    <button class="popup-nav popup-prev" id="popup-prev" onclick="previousImage()">‚ùÆ</button>
    <div class="popup-image-container">
        <img id="popup-image" src="" alt="">
    </div>
    <button class="popup-nav popup-next" id="popup-next" onclick="nextImage()">‚ùØ</button>
    <div class="popup-info">
        <h3 id="popup-title"></h3>
        <span id="popup-number"></span>
    </div>
</div>

<div class="popup-modal popup-zoom-modal" id="popup-zoom">
    <button class="popup-close" onclick="closeAllPopups()">√ó</button>
    <img id="popup-zoom-image" src="" alt="">
</div>

<!-- Animated Postcard Modal -->
<div class="popup-modal popup-animated-modal" id="popup-animated">
    <button class="popup-close" onclick="closeAllPopups()">√ó</button>
    <video id="popup-animated-video" controls autoplay loop>
        <source src="" type="video/mp4">
    </video>
    <div class="popup-info">
        <h3 id="popup-animated-title"></h3>
        <span id="popup-animated-number"></span>
    </div>
</div>

<script>
// =============================================
// ALL POSTCARDS DATA
// =============================================
const allPostcardsData = [
    {% for postcard in postcards %}
    {
        id: {{ postcard.id }},
        number: "{{ postcard.number|escapejs }}",
        title: "{{ postcard.title|escapejs }}",
        keywords: "{{ postcard.keywords|escapejs|lower }}",
        grande_url: "{{ postcard.grande_url|default:postcard.vignette_url }}",
        dos_url: "{{ postcard.dos_url|default:'' }}",
        zoom_url: "{{ postcard.zoom_url|default:postcard.grande_url }}",
        vignette_url: "{{ postcard.vignette_url|default:'' }}",
        animated_url: "{{ postcard.animated_url|default:'' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let filteredPostcards = [...allPostcardsData];
let currentIndex = 0;
let currentView = 'front';

// =============================================
// SEARCH WORDS
// =============================================
const searchWords = [
    'Seine', 'Marne', 'Bateau', 'Pont', '√âcluse', 'P√©niche',
    'Navigation', 'Fleuve', 'Rivi√®re', 'Port', 'Quai', 'Berge',
    'Vapeur', 'Marinier', 'Halage', 'Remorqueur', 'Toueur',
    'Crue', 'Inondation', 'Paris', 'Bords', 'Eau', 'Canaux',
    'Passeur', 'Lavoir', 'Moulin', 'Barrage', 'Croisi√®re',
    {% for theme in themes %}'{{ theme.display_name|escapejs }}',{% endfor %}
];

// =============================================
// CINEMA DIAPORAMA
// =============================================
let cinemaPlaying = false;
let cinemaInterval = null;
let cinemaIndex = 0;
let cinemaMode = 'images'; // 'images', 'animated', 'both'
let cinemaPostcards = [];

function openCinema() {
    // Get visible postcards
    cinemaPostcards = filteredPostcards.filter(p => {
        if (cinemaMode === 'animated') return p.animated_url;
        if (cinemaMode === 'images') return p.vignette_url;
        return p.vignette_url || p.animated_url;
    });
    
    if (cinemaPostcards.length === 0) {
        alert('Aucune carte postale √† afficher');
        return;
    }
    
    cinemaIndex = 0;
    document.getElementById('cinemaModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    updateCinemaDisplay();
}

function closeCinema() {
    document.getElementById('cinemaModal').classList.remove('active');
    document.body.style.overflow = '';
    stopCinemaPlay();
    
    // Stop video
    const video = document.getElementById('cinemaVideo');
    video.pause();
    video.src = '';
}

function setCinemaMode(mode) {
    cinemaMode = mode;
    
    // Update buttons
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // Refresh postcards list
    cinemaPostcards = filteredPostcards.filter(p => {
        if (mode === 'animated') return p.animated_url;
        if (mode === 'images') return p.vignette_url;
        return p.vignette_url || p.animated_url;
    });
    
    cinemaIndex = 0;
    updateCinemaDisplay();
}

function updateCinemaDisplay() {
    if (cinemaPostcards.length === 0) return;
    
    const postcard = cinemaPostcards[cinemaIndex];
    const img = document.getElementById('cinemaImage');
    const video = document.getElementById('cinemaVideo');
    
    document.getElementById('cinemaTitle').textContent = postcard.title;
    document.getElementById('cinemaNumber').textContent = 'N¬∞ ' + postcard.number;
    document.getElementById('cinemaCounter').textContent = `${cinemaIndex + 1} / ${cinemaPostcards.length}`;
    
    // Update progress bar
    const progress = ((cinemaIndex + 1) / cinemaPostcards.length) * 100;
    document.getElementById('cinemaProgressBar').style.width = progress + '%';
    
    // Decide what to show
    const showAnimated = (cinemaMode === 'animated' || cinemaMode === 'both') && postcard.animated_url;
    
    if (showAnimated) {
        img.style.display = 'none';
        video.style.display = 'block';
        video.src = postcard.animated_url;
        video.play().catch(() => {});
    } else {
        video.style.display = 'none';
        video.pause();
        img.style.display = 'block';
        img.src = postcard.grande_url || postcard.vignette_url;
    }
}

function cinemaPrev() {
    if (cinemaIndex > 0) {
        cinemaIndex--;
        updateCinemaDisplay();
    }
}

function cinemaNext() {
    if (cinemaIndex < cinemaPostcards.length - 1) {
        cinemaIndex++;
        updateCinemaDisplay();
    } else if (cinemaPlaying) {
        cinemaIndex = 0; // Loop back
        updateCinemaDisplay();
    }
}

function toggleCinemaPlay() {
    if (cinemaPlaying) {
        stopCinemaPlay();
    } else {
        startCinemaPlay();
    }
}

function startCinemaPlay() {
    cinemaPlaying = true;
    document.getElementById('playIcon').style.display = 'none';
    document.getElementById('pauseIcon').style.display = 'block';
    
    cinemaInterval = setInterval(() => {
        cinemaNext();
    }, 4000); // 4 seconds per slide
}

function stopCinemaPlay() {
    cinemaPlaying = false;
    document.getElementById('playIcon').style.display = 'block';
    document.getElementById('pauseIcon').style.display = 'none';
    
    if (cinemaInterval) {
        clearInterval(cinemaInterval);
        cinemaInterval = null;
    }
}

// =============================================
// LIVE SEARCH - FIXED
// =============================================
class LiveSearch {
    constructor() {
        this.input = document.getElementById('searchInput');
        this.suggestionsContainer = document.getElementById('searchSuggestions');
        this.searchInfo = document.getElementById('searchInfo');
        this.visibleCount = document.getElementById('visible-count');
        this.debounceTimer = null;
        
        this.init();
    }
    
    init() {
        this.input.addEventListener('input', (e) => this.onInput(e));
        this.input.addEventListener('focus', () => this.showSuggestions());
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-form')) {
                this.hideSuggestions();
            }
        });
        
        if (this.input.value) {
            this.filterCards(this.input.value);
        }
    }
    
    onInput(e) {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.filterCards(e.target.value.trim());
            this.updateSuggestions(e.target.value.trim());
        }, 150);
    }
    
    filterCards(query) {
        const lowerQuery = query.toLowerCase();
        const cards = document.querySelectorAll('.postcard-card');
        let visibleCount = 0;
        
        cards.forEach((card, idx) => {
            const title = card.dataset.title || '';
            const keywords = card.dataset.keywords || '';
            const number = card.dataset.number || '';
            const searchText = `${title} ${keywords} ${number}`;
            const matches = !query || searchText.includes(lowerQuery);
            
            if (matches) {
                card.style.display = '';
                card.style.animationDelay = (idx * 30) + 'ms';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        this.visibleCount.textContent = visibleCount;
        
        filteredPostcards = allPostcardsData.filter(p => {
            const searchText = `${p.title} ${p.keywords} ${p.number}`.toLowerCase();
            return !query || searchText.includes(lowerQuery);
        });
        
        this.updateSearchInfo(query, visibleCount);
        document.getElementById('noResults').style.display = visibleCount === 0 && query ? 'block' : 'none';
    }
    
    updateSearchInfo(query, count) {
        if (query) {
            this.searchInfo.innerHTML = `
                <p class="search-results-text">
                    <span class="result-count">${count}</span> r√©sultat${count !== 1 ? 's' : ''} pour "<span class="result-query">${this.escapeHtml(query)}</span>"
                    <button class="clear-search" onclick="clearSearch()">‚úï Effacer</button>
                </p>
            `;
        } else {
            this.searchInfo.innerHTML = '';
        }
    }
    
    updateSuggestions(query) {
        if (!query) {
            this.showAllSuggestions();
            return;
        }
        
        const matches = searchWords.filter(w => 
            w.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 8);
        
        if (matches.length > 0) {
            this.renderSuggestions(matches, query);
        } else {
            this.hideSuggestions();
        }
    }
    
    showAllSuggestions() {
        this.renderSuggestions(searchWords.slice(0, 10));
    }
    
    renderSuggestions(suggestions, highlight = '') {
        this.suggestionsContainer.innerHTML = suggestions.map(word => {
            let displayWord = word;
            if (highlight) {
                const regex = new RegExp(`(${this.escapeRegex(highlight)})`, 'gi');
                displayWord = word.replace(regex, '<strong>$1</strong>');
            }
            return `<div class="suggestion-item" data-word="${this.escapeHtml(word)}">${displayWord}</div>`;
        }).join('');
        
        // Add click handlers
        this.suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                this.selectSuggestion(item.dataset.word);
            });
        });
        
        this.suggestionsContainer.classList.add('active');
    }
    
    showSuggestions() {
        if (this.input.value) {
            this.updateSuggestions(this.input.value);
        } else {
            this.showAllSuggestions();
        }
    }
    
    hideSuggestions() {
        this.suggestionsContainer.classList.remove('active');
    }
    
    selectSuggestion(word) {
        this.input.value = word;
        this.filterCards(word);
        this.hideSuggestions();
        this.input.focus();
    }
    
    // THIS IS THE FIXED METHOD - Called by floating words
    addWord(word) {
        const currentValue = this.input.value.trim();
        
        if (currentValue) {
            if (!currentValue.toLowerCase().includes(word.toLowerCase())) {
                this.input.value = currentValue + ' ' + word;
            }
        } else {
            this.input.value = word;
        }
        
        // Apply the filter
        this.filterCards(this.input.value);
        
        // Visual feedback
        this.input.classList.add('highlight');
        setTimeout(() => this.input.classList.remove('highlight'), 600);
        
        // Scroll to results after a brief delay
        setTimeout(() => {
            document.getElementById('results-section').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }, 400);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
}

let liveSearch;

function clearSearch() {
    document.getElementById('searchInput').value = '';
    liveSearch.filterCards('');
    document.getElementById('searchInput').focus();
}

// =============================================
// FLOATING WORDS - FIXED CLICK HANDLER
// =============================================
class FloatingWords {
    constructor() {
        this.container = document.getElementById('words-container');
        if (!this.container) return;
        
        this.maxWords = 12;
        this.activeWords = 0;
        
        this.init();
    }
    
    init() {
        for (let i = 0; i < 5; i++) {
            setTimeout(() => this.spawnWord(), i * 350);
        }
        
        setInterval(() => {
            if (this.activeWords < this.maxWords) {
                this.spawnWord();
            }
        }, 2000);
    }
    
    spawnWord() {
        const wordEl = document.createElement('button');
        wordEl.className = 'floating-word';
        wordEl.type = 'button';
        
        const wordText = searchWords[Math.floor(Math.random() * searchWords.length)];
        wordEl.textContent = wordText;
        
        const yPos = 8 + Math.random() * 75;
        const duration = 18 + Math.random() * 12;
        const scale = 0.8 + Math.random() * 0.5;
        
        wordEl.style.cssText = `
            top: ${yPos}%;
            --duration: ${duration}s;
            --scale: ${scale};
        `;
        
        // FIXED: Proper click handler that adds word to search
        wordEl.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Add click animation
            wordEl.classList.add('clicked');
            
            // Add word to search input and filter
            if (liveSearch) {
                liveSearch.addWord(wordText);
            }
        });
        
        this.container.appendChild(wordEl);
        this.activeWords++;
        
        setTimeout(() => {
            if (wordEl.parentNode) {
                wordEl.remove();
                this.activeWords--;
            }
        }, duration * 1000);
    }
}

// =============================================
// CARD HOVER ANIMATION HANDLER
// =============================================
class CardAnimationHandler {
    constructor() {
        this.init();
    }
    
    init() {
        document.querySelectorAll('.postcard-card').forEach(card => {
            const video = card.querySelector('.card-video');
            const animatedUrl = card.dataset.animated;
            
            if (video && animatedUrl) {
                card.addEventListener('mouseenter', () => {
                    video.src = animatedUrl;
                    video.play().catch(() => {});
                    video.style.opacity = '1';
                });
                
                card.addEventListener('mouseleave', () => {
                    video.pause();
                    video.style.opacity = '0';
                });
            }
        });
    }
}

// =============================================
// POPUP FUNCTIONS
// =============================================
function showDetail(id) {
    const postcard = filteredPostcards.find(p => p.id === id) || allPostcardsData.find(p => p.id === id);
    if (!postcard) return;
    
    currentIndex = filteredPostcards.findIndex(p => p.id === id);
    if (currentIndex === -1) currentIndex = 0;
    currentView = 'front';
    
    document.getElementById('popup-image').src = postcard.grande_url || postcard.vignette_url;
    document.getElementById('popup-title').textContent = postcard.title;
    document.getElementById('popup-number').textContent = 'N¬∞ ' + postcard.number;
    
    document.getElementById('popup-overlay').classList.add('active');
    document.getElementById('popup-detail').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    updateNavButtons();
}

function showZoom(id) {
    const postcard = allPostcardsData.find(p => p.id === id);
    if (!postcard) return;
    
    document.getElementById('popup-zoom-image').src = postcard.zoom_url || postcard.grande_url;
    document.getElementById('popup-overlay').classList.add('active');
    document.getElementById('popup-zoom').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function playAnimated(id) {
    const postcard = allPostcardsData.find(p => p.id === id);
    if (!postcard || !postcard.animated_url) return;
    
    const video = document.getElementById('popup-animated-video');
    video.querySelector('source').src = postcard.animated_url;
    video.load();
    
    document.getElementById('popup-animated-title').textContent = postcard.title;
    document.getElementById('popup-animated-number').textContent = 'N¬∞ ' + postcard.number;
    
    document.getElementById('popup-overlay').classList.add('active');
    document.getElementById('popup-animated').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function togglePostcardSide() {
    const postcard = filteredPostcards[currentIndex];
    if (!postcard) return;
    
    const img = document.getElementById('popup-image');
    
    if (currentView === 'front' && postcard.dos_url) {
        img.src = postcard.dos_url;
        currentView = 'back';
    } else {
        img.src = postcard.grande_url || postcard.vignette_url;
        currentView = 'front';
    }
}

function previousImage() {
    if (currentIndex > 0) {
        currentIndex--;
        updatePopup();
    }
}

function nextImage() {
    if (currentIndex < filteredPostcards.length - 1) {
        currentIndex++;
        updatePopup();
    }
}

function updatePopup() {
    const postcard = filteredPostcards[currentIndex];
    if (!postcard) return;
    
    currentView = 'front';
    document.getElementById('popup-image').src = postcard.grande_url || postcard.vignette_url;
    document.getElementById('popup-title').textContent = postcard.title;
    document.getElementById('popup-number').textContent = 'N¬∞ ' + postcard.number;
    updateNavButtons();
}

function updateNavButtons() {
    document.getElementById('popup-prev').style.display = currentIndex > 0 ? 'flex' : 'none';
    document.getElementById('popup-next').style.display = currentIndex < filteredPostcards.length - 1 ? 'flex' : 'none';
}

function closeAllPopups() {
    document.getElementById('popup-overlay').classList.remove('active');
    document.getElementById('popup-detail').classList.remove('active');
    document.getElementById('popup-zoom').classList.remove('active');
    document.getElementById('popup-animated').classList.remove('active');
    document.body.style.overflow = '';
    
    // Stop animated video
    const video = document.getElementById('popup-animated-video');
    if (video) {
        video.pause();
    }
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    // Cinema modal
    if (document.getElementById('cinemaModal').classList.contains('active')) {
        if (e.key === 'ArrowLeft') cinemaPrev();
        else if (e.key === 'ArrowRight') cinemaNext();
        else if (e.key === ' ') { e.preventDefault(); toggleCinemaPlay(); }
        else if (e.key === 'Escape') closeCinema();
        return;
    }
    
    // Detail popup
    if (document.getElementById('popup-detail').classList.contains('active')) {
        if (e.key === 'ArrowLeft') previousImage();
        else if (e.key === 'ArrowRight') nextImage();
        else if (e.key === 'Escape') closeAllPopups();
    } else if (document.getElementById('popup-zoom').classList.contains('active') ||
               document.getElementById('popup-animated').classList.contains('active')) {
        if (e.key === 'Escape') closeAllPopups();
    }
});

// =============================================
// RIVER BACKGROUND & LOADING
// =============================================
class RiverBackground {
    constructor() {
        this.background = document.getElementById('river-background');
        this.particlesContainer = document.getElementById('river-particles');
        this.brightness = 1;
        this.direction = -1;
        this.init();
    }
    
    init() {
        for (let i = 0; i < 45; i++) {
            const p = document.createElement('div');
            p.className = 'river-particle';
            const size = 3 + Math.random() * 6;
            const duration = 12 + Math.random() * 20;
            p.style.cssText = `
                width: ${size}px;
                height: ${size}px;
                top: ${Math.random() * 100}%;
                animation-duration: ${duration}s;
                animation-delay: -${Math.random() * duration}s;
            `;
            this.particlesContainer.appendChild(p);
        }
        
        this.startCycle();
    }
    
    startCycle() {
        const tick = () => {
            this.brightness += this.direction * 0.0004;
            if (this.brightness <= 0.35) this.direction = 1;
            else if (this.brightness >= 1) this.direction = -1;
            this.background.style.filter = `brightness(${this.brightness})`;
            requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
    }
}

class LoadingManager {
    constructor() {
        this.overlay = document.getElementById('loading-overlay');
        this.bar = document.getElementById('loading-bar');
        this.startTime = Date.now();
    }
    
    start() {
        let progress = 0;
        const tick = () => {
            progress += (100 - progress) * 0.08;
            this.bar.style.width = progress + '%';
            if (progress < 95) requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
    }
    
    hide() {
        const elapsed = Date.now() - this.startTime;
        const remaining = Math.max(0, 1200 - elapsed);
        
        setTimeout(() => {
            this.bar.style.width = '100%';
            setTimeout(() => {
                this.overlay.classList.add('hidden');
            }, 200);
        }, remaining);
    }
}

class ImageLoader {
    constructor() {
        this.loadImages();
    }
    
    loadImages() {
        const images = document.querySelectorAll('.card-image[data-src]');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    
                    if (src) {
                        const newImg = new Image();
                        newImg.onload = () => {
                            img.src = src;
                            img.classList.add('loaded');
                            const placeholder = img.closest('.card-image-wrapper').querySelector('.card-placeholder');
                            if (placeholder) placeholder.classList.add('hidden');
                        };
                        newImg.onerror = () => {
                            const placeholder = img.closest('.card-image-wrapper').querySelector('.card-placeholder');
                            if (placeholder) placeholder.classList.add('hidden');
                        };
                        newImg.src = src;
                    }
                    
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '200px' });
        
        images.forEach(img => observer.observe(img));
    }
}

// =============================================
// INITIALIZATION
// =============================================
document.addEventListener('DOMContentLoaded', () => {
    const loadingManager = new LoadingManager();
    loadingManager.start();
    
    liveSearch = new LiveSearch();
    new FloatingWords();
    new RiverBackground();
    new ImageLoader();
    new CardAnimationHandler();
    
    window.addEventListener('load', () => loadingManager.hide());
    setTimeout(() => loadingManager.hide(), 2500);
});
</script>

<style>
/* ========================================
   LOADING OVERLAY
   ======================================== */
.loading-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: linear-gradient(135deg, #1a1208, #0d0906);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-content { text-align: center; }
.loading-spinner { position: relative; width: 80px; height: 80px; margin: 0 auto 30px; }
.spinner-ring {
    position: absolute; inset: 0;
    border: 3px solid transparent; border-radius: 50%;
}
.spinner-ring:nth-child(1) { border-top-color: #b5600b; animation: spin 1s linear infinite; }
.spinner-ring:nth-child(2) { inset: 8px; border-right-color: #d1872c; animation: spin 1.5s linear infinite reverse; }
.spinner-ring:nth-child(3) { inset: 16px; border-bottom-color: #ffc168; animation: spin 2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 20px; }
.loading-progress { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 0 auto; }
.loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #b5600b, #ffc168); transition: width 0.1s; }

/* ========================================
   CINEMA DIAPORAMA
   ======================================== */
.cinema-trigger {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 25px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 50px;
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 10px 40px rgba(181, 96, 11, 0.5);
    transition: all 0.3s ease;
    z-index: 100;
}
.cinema-trigger img { height: 30px; filter: brightness(0) invert(1); }
.cinema-trigger:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 50px rgba(181, 96, 11, 0.6); }

.cinema-modal {
    position: fixed; inset: 0; z-index: 5000;
    display: none; align-items: center; justify-content: center;
}
.cinema-modal.active { display: flex; }
.cinema-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.98); }
.cinema-container {
    position: relative; width: 90%; max-width: 1200px;
    display: flex; flex-direction: column; align-items: center;
}
.cinema-close {
    position: absolute; top: -60px; right: 0;
    width: 50px; height: 50px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 50%;
    color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s;
}
.cinema-close:hover { transform: rotate(90deg) scale(1.1); }

.cinema-screen {
    width: 100%; max-height: 70vh;
    display: flex; align-items: center; justify-content: center;
    background: #000; border-radius: 12px; overflow: hidden;
}
.cinema-media { max-width: 100%; max-height: 70vh; border-radius: 12px; }

.cinema-info {
    text-align: center; padding: 20px;
    display: flex; align-items: center; gap: 20px; flex-wrap: wrap; justify-content: center;
}
.cinema-info h3 { color: white; font-size: 1.3rem; margin: 0; }
.cinema-info span { color: rgba(255,255,255,0.6); }
#cinemaCounter { background: rgba(181, 96, 11, 0.3); padding: 5px 15px; border-radius: 20px; }

.cinema-controls { display: flex; align-items: center; gap: 20px; margin: 15px 0; }
.cinema-nav {
    width: 50px; height: 50px;
    background: rgba(255,255,255,0.1); border: none; border-radius: 50%;
    color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.cinema-nav:hover { background: rgba(181, 96, 11, 0.6); }
.cinema-play {
    width: 70px; height: 70px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 50%;
    color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.cinema-play:hover { transform: scale(1.1); }

.cinema-mode-toggle { display: flex; gap: 10px; margin: 15px 0; }
.mode-btn {
    padding: 10px 20px;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 25px; color: white; cursor: pointer;
    transition: all 0.3s;
}
.mode-btn:hover { background: rgba(181, 96, 11, 0.3); }
.mode-btn.active { background: #b5600b; border-color: #b5600b; }

.cinema-progress { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 15px; }
.progress-bar { height: 100%; background: linear-gradient(90deg, #b5600b, #ffc168); border-radius: 2px; transition: width 0.3s; }

/* ========================================
   RIVER BACKGROUND
   ======================================== */
.river-background {
    position: fixed; inset: 0; z-index: 0;
    background: linear-gradient(180deg, #1a1208 0%, #2d1f0d 20%, #3d2a12 40%, #2d1f0d 60%, #1a1208 80%, #0d0906 100%);
    transition: filter 0.5s ease;
}
.river-gradient {
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at 20% 30%, rgba(255, 180, 50, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(181, 96, 11, 0.1) 0%, transparent 50%);
}
.river-waves { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; }
.river-waves .wave { position: absolute; bottom: 0; left: 0; width: 200%; height: 100%; }
.river-waves .wave path { fill: rgba(181, 96, 11, 0.08); }
.river-waves .wave:nth-child(1) { animation: wave-move 20s linear infinite; }
.river-waves .wave-2 path { fill: rgba(209, 135, 44, 0.05); }
.river-waves .wave-2 { animation: wave-move 25s linear infinite reverse; bottom: 30%; }
@keyframes wave-move { from { transform: translateX(0); } to { transform: translateX(-50%); } }
.river-particles { position: absolute; inset: 0; }
.river-particle {
    position: absolute; right: -20px; border-radius: 50%;
    background: radial-gradient(circle, rgba(255, 200, 100, 0.9) 0%, rgba(181, 96, 11, 0.3) 60%, transparent 100%);
    box-shadow: 0 0 15px rgba(255, 180, 50, 0.5);
    animation: particle-flow linear infinite;
}
@keyframes particle-flow {
    0% { transform: translateX(0) scale(0); opacity: 0; }
    5% { transform: translateX(-50px) scale(1); opacity: 0.8; }
    95% { transform: translateX(calc(-100vw - 50px)) scale(0.8); opacity: 0.6; }
    100% { transform: translateX(calc(-100vw - 100px)) scale(0); opacity: 0; }
}

/* ========================================
   BROWSE PAGE
   ======================================== */
.browse-page { position: relative; z-index: 1; min-height: 100vh; padding-top: 70px; }

/* Search Section */
.search-section { padding: 30px 20px 15px; text-align: center; position: relative; }
.search-form { max-width: 600px; margin: 0 auto; position: relative; }
.search-box {
    display: flex; background: rgba(255,255,255,0.95);
    border-radius: 50px; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}
.search-box:focus-within { box-shadow: 0 15px 50px rgba(181, 96, 11, 0.4); transform: translateY(-2px); }
.search-box input {
    flex: 1; padding: 18px 25px; border: none;
    font-size: 1.1rem; background: transparent; color: #333;
}
.search-box input:focus { outline: none; }
.search-box input.highlight { animation: input-highlight 0.6s ease; }
@keyframes input-highlight { 0%, 100% { background: transparent; } 50% { background: rgba(181, 96, 11, 0.2); } }
.search-box button {
    padding: 15px 25px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; cursor: pointer; color: white;
}

.search-suggestions {
    position: absolute; top: 100%; left: 0; right: 0;
    margin-top: 8px; background: rgba(30, 25, 20, 0.98);
    border-radius: 16px; box-shadow: 0 15px 50px rgba(0,0,0,0.5);
    border: 1px solid rgba(181, 96, 11, 0.3);
    overflow: hidden; opacity: 0; visibility: hidden;
    transform: translateY(-10px); transition: all 0.2s ease; z-index: 100;
}
.search-suggestions.active { opacity: 1; visibility: visible; transform: translateY(0); }
.suggestion-item {
    padding: 14px 20px; color: rgba(255,255,255,0.9);
    cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.suggestion-item:last-child { border-bottom: none; }
.suggestion-item:hover { background: rgba(181, 96, 11, 0.3); padding-left: 28px; }
.suggestion-item strong { color: #ffc168; }

.search-info { margin-top: 15px; }
.search-results-text {
    color: rgba(255,255,255,0.9); font-size: 1.05rem;
    display: inline-flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;
}
.result-count { color: #ffc168; font-weight: bold; font-size: 1.3rem; }
.result-query { color: #ffc168; }
.clear-search {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.8); padding: 6px 14px; border-radius: 20px;
    cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
}
.clear-search:hover { background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5); color: #ff6b6b; }

/* ========================================
   FLOATING WORDS - FIXED
   ======================================== */
.floating-words-section {
    position: relative; height: 320px; margin: 15px 20px;
    border-radius: 20px; overflow: hidden;
    background: rgba(0,0,0,0.25); backdrop-filter: blur(5px);
}
.words-container { position: absolute; inset: 0; overflow: hidden; }
.floating-word {
    position: absolute; right: -250px;
    padding: 12px 24px;
    font-family: 'Georgia', serif; font-style: italic;
    font-size: calc(1rem * var(--scale, 1));
    color: rgba(255, 240, 220, 0.95);
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.4), rgba(139, 69, 19, 0.3));
    border: 1px solid rgba(255, 180, 100, 0.4);
    border-radius: 30px; cursor: pointer; white-space: nowrap;
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: word-drift var(--duration, 20s) linear forwards;
    transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
    z-index: 10;
}
.floating-word:hover {
    background: linear-gradient(135deg, rgba(255, 160, 50, 0.95), rgba(181, 96, 11, 0.9)) !important;
    color: white !important;
    transform: scale(1.35) translateY(-8px) !important;
    box-shadow: 0 15px 50px rgba(255, 160, 50, 0.6) !important;
    animation-play-state: paused !important;
    z-index: 100 !important;
}
.floating-word.clicked {
    animation: word-click 0.5s ease forwards !important;
    background: #ffc168 !important;
}
@keyframes word-click {
    0% { transform: scale(1.35); }
    50% { transform: scale(1.6); opacity: 1; }
    100% { transform: scale(0.5); opacity: 0; }
}
@keyframes word-drift {
    0% { transform: translateX(0); opacity: 0; }
    2% { opacity: 1; }
    95% { opacity: 1; }
    100% { transform: translateX(calc(-100vw - 300px)); opacity: 0; }
}
.section-hint { position: absolute; bottom: 20px; width: 100%; text-align: center; }
.section-hint p { color: rgba(255, 200, 150, 0.6); font-style: italic; }

/* ========================================
   RESULTS GRID
   ======================================== */
.results-section { padding: 25px 20px; }
.postcards-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 22px; max-width: 1400px; margin: 0 auto;
}
.postcard-card {
    position: relative; aspect-ratio: 3/2;
    border-radius: 14px; overflow: hidden;
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    cursor: pointer;
    animation: card-appear 0.5s ease backwards;
    transition: transform 0.4s ease, box-shadow 0.4s ease;
}
@keyframes card-appear { from { opacity: 0; transform: translateY(25px) scale(0.95); } }
.postcard-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 50px rgba(181, 96, 11, 0.35);
}

.card-image-wrapper { position: relative; width: 100%; height: 100%; }
.card-image {
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0; transition: opacity 0.5s ease;
}
.card-image.loaded { opacity: 1; }
.card-video {
    position: absolute; inset: 0;
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0; transition: opacity 0.3s ease;
    pointer-events: none;
}
.card-placeholder {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
}
.card-placeholder.hidden { display: none; }
.placeholder-spinner {
    width: 36px; height: 36px;
    border: 3px solid rgba(181, 96, 11, 0.2);
    border-top-color: #b5600b; border-radius: 50%;
    animation: spin 1s linear infinite;
}
.card-no-image {
    display: flex; align-items: center; justify-content: center;
    height: 100%; color: rgba(255,255,255,0.25); font-size: 2.5rem;
}

.card-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, transparent 55%);
    display: flex; flex-direction: column; justify-content: flex-end;
    padding: 18px; opacity: 0; transition: opacity 0.3s ease;
}
.postcard-card:hover .card-overlay { opacity: 1; }

.card-actions { display: flex; justify-content: center; gap: 10px; margin-bottom: 12px; }
.action-btn {
    width: 44px; height: 44px; border: none; border-radius: 50%;
    background: rgba(255,255,255,0.95); color: #333;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.3s ease;
}
.action-btn:hover { background: #b5600b; color: white; transform: scale(1.1); }
.action-play { background: rgba(181, 96, 11, 0.9); color: white; }
.action-play:hover { background: #ffc168; }

.card-title { color: white; font-size: 0.9rem; line-height: 1.35; margin: 0 0 6px; text-align: center; }
.card-number { display: block; text-align: center; color: rgba(255,255,255,0.55); font-size: 0.8rem; }

.animated-badge {
    position: absolute; top: 10px; right: 10px;
    background: rgba(181, 96, 11, 0.9); padding: 5px 10px;
    border-radius: 15px; font-size: 0.8rem;
}

.no-results {
    grid-column: 1 / -1; text-align: center;
    padding: 60px 20px; color: rgba(255,255,255,0.8);
}
.no-results-icon { font-size: 3.5rem; margin-bottom: 15px; }
.no-results h3 { font-size: 1.4rem; margin-bottom: 10px; color: white; }

.browse-footer { text-align: center; padding: 35px; color: rgba(255,255,255,0.4); }

/* ========================================
   POPUPS
   ======================================== */
.popup-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    backdrop-filter: blur(8px); z-index: 2000;
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
}
.popup-overlay.active { opacity: 1; visibility: visible; }
.popup-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    z-index: 2001; opacity: 0; visibility: hidden;
    transition: all 0.3s ease;
}
.popup-modal.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
.popup-close {
    position: absolute; top: -45px; right: 0;
    width: 40px; height: 40px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none; border-radius: 50%; color: white;
    font-size: 1.5rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s;
}
.popup-close:hover { transform: rotate(90deg) scale(1.1); }
.popup-flip {
    position: absolute; top: 12px; left: 12px;
    width: 40px; height: 40px;
    background: rgba(0,0,0,0.7); border: none; border-radius: 50%;
    color: white; font-size: 1.2rem; cursor: pointer; z-index: 10;
}
.popup-flip:hover { background: #b5600b; }
.popup-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 45px; height: 45px;
    background: rgba(255,255,255,0.15); border: none; border-radius: 50%;
    color: white; font-size: 1.3rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
}
.popup-nav:hover { background: rgba(181, 96, 11, 0.8); }
.popup-prev { left: -60px; }
.popup-next { right: -60px; }
#popup-image, #popup-zoom-image {
    max-width: 85vw; max-height: 70vh;
    border-radius: 10px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.popup-zoom-modal #popup-zoom-image { max-width: 95vw; max-height: 95vh; }
.popup-info {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    padding: 18px; border-radius: 0 0 10px 10px;
}
.popup-info h3 { color: white; margin: 0 0 5px; font-size: 1rem; }
.popup-info span { color: rgba(255,255,255,0.8); font-size: 0.85rem; }

/* Animated Popup */
.popup-animated-modal video {
    max-width: 85vw; max-height: 70vh;
    border-radius: 10px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

/* ========================================
   RESPONSIVE
   ======================================== */
@media (max-width: 768px) {
    .floating-words-section { height: 250px; }
    .postcards-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .popup-prev { left: 8px; }
    .popup-next { right: 8px; }
    .cinema-trigger { bottom: 20px; right: 20px; padding: 12px 20px; }
    .cinema-trigger span { display: none; }
}
@media (max-width: 500px) {
    .floating-words-section { height: 200px; margin: 10px; }
    .floating-word { padding: 8px 16px; font-size: calc(0.8rem * var(--scale, 1)); }
    .postcards-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .cinema-mode-toggle { flex-direction: column; }
}
</style>
{% endblock %}