<!-- templates/home.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Collection Samathey{% endblock %}
{% block page_title %}Collection Samathey{% endblock %}

{% block content %}
<div class="home-page">
    <!-- Video Background Hero with Diaporama -->
    <header class="hero-section">
        <div class="video-container">
            <!-- Poster image for instant display -->
            <div class="video-poster" id="video-poster">
                <div class="poster-gradient"></div>
            </div>
            <!-- Video element for diaporama -->
            <video autoplay muted loop playsinline id="hero-video" class="hero-video" preload="auto">
                <source id="video-source" src="" type="video/mp4">
            </video>
            <div class="video-overlay"></div>
            
            <!-- Video transition overlay for fade effect -->
            <div class="video-transition" id="video-transition"></div>
        </div>
        
        <!-- Video indicator dots -->
        <div class="video-indicators" id="video-indicators"></div>
        
        <div class="hero-content">
            <h1 class="hero-title animate-fade-in-down">
                « Embarquez pour la belle époque ! »
            </h1>
            <p class="hero-subtitle animate-fade-in-up delay-2">
                La navigation fluviale en cartes postales anciennes
            </p>
            <a href="{% url 'browse' %}" class="hero-cta animate-scale-in delay-4">
                <span>Explorer la collection</span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
        
        <div class="scroll-indicator animate-fade-in delay-5">
            <span>Découvrir</span>
            <div class="scroll-arrow">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12l7 7 7-7"/>
                </svg>
            </div>
        </div>
    </header>

    <!-- Welcome Section -->
    <section class="welcome-section">
        <div class="welcome-container">
            <div class="welcome-decoration animate-fade-in">
                <div class="deco-line"></div>
                <span class="deco-year">1873 - 1914</span>
                <div class="deco-line"></div>
            </div>
            
            <h2 class="welcome-title animate-fade-in-up delay-1">Bienvenue dans notre collection</h2>
            
            <p class="welcome-text animate-fade-in-up delay-2">
                Cette collection de cartes postales anciennes a été mise en ligne pour vous permettre 
                de naviguer et de vous promener le long des berges à la « Belle Époque », cette période 
                (1873-1914) pleine d'insouciance et d'optimisme.
            </p>
            
            <p class="welcome-text animate-fade-in-up delay-3">
                Vous pourrez découvrir des métiers et des bateaux aujourd'hui disparus, reconnaître 
                certains détours ou boucles de la Seine et d'autres cours d'eau.
            </p>
            
            <p class="welcome-signature animate-fade-in-up delay-4">Bonne visite à tous !</p>
            
            <div class="welcome-actions animate-fade-in-up delay-5">
                <a href="{% url 'browse' %}" class="btn btn-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Parcourir
                </a>
                <a href="{% url 'animated_gallery' %}" class="btn btn-secondary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    CP Animées
                </a>
                <a href="{% url 'presentation' %}" class="btn btn-tertiary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    Présentation
                </a>
            </div>
        </div>
    </section>
</div>

<script>
// All animated videos passed from the view
const animatedVideos = [
    {% for url in animated_videos %}
    "{{ url }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Fallback static video if no animated ones
const fallbackVideo = "{% static 'video/Annimate_CPA_optimized_0.mp4' %}";

class VideoCarousel {
    constructor() {
        this.videoElement = document.getElementById('hero-video');
        this.videoSource = document.getElementById('video-source');
        this.transition = document.getElementById('video-transition');
        this.indicatorsContainer = document.getElementById('video-indicators');
        this.videoPoster = document.getElementById('video-poster');
        
        // Use all available videos from animated_cp folder
        this.videos = animatedVideos.length > 0 ? animatedVideos : [fallbackVideo];
        this.currentIndex = 0;
        this.isTransitioning = false;
        this.autoPlayInterval = null;
        this.videoLoaded = false;
        this.transitionDuration = 800; // ms for fade transition
        this.displayDuration = 8000; // ms to show each video
        
        this.init();
    }
    
    init() {
        // Shuffle videos for variety
        this.shuffleVideos();
        
        // Limit to reasonable number for performance
        this.videos = this.videos.slice(0, 50);
        
        console.log(`VideoCarousel: ${this.videos.length} videos available`);
        
        // Create indicators
        this.createIndicators();
        
        // Set up video event listeners
        this.videoElement.addEventListener('loadeddata', () => this.onVideoLoaded());
        this.videoElement.addEventListener('canplay', () => this.onVideoReady());
        this.videoElement.addEventListener('ended', () => this.onVideoEnded());
        this.videoElement.addEventListener('error', (e) => this.handleError(e));
        
        // Load first video
        this.loadVideo(0);
        
        // Start auto-advance timer
        this.startAutoAdvance();
    }
    
    shuffleVideos() {
        for (let i = this.videos.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.videos[i], this.videos[j]] = [this.videos[j], this.videos[i]];
        }
    }
    
    createIndicators() {
        if (this.videos.length <= 1) return;
        
        // Show max 10 indicators
        const maxIndicators = Math.min(this.videos.length, 10);
        
        for (let i = 0; i < maxIndicators; i++) {
            const dot = document.createElement('button');
            dot.className = 'video-dot';
            dot.setAttribute('aria-label', `Video ${i + 1}`);
            dot.addEventListener('click', () => this.goToVideo(i));
            this.indicatorsContainer.appendChild(dot);
        }
        
        this.updateIndicators();
    }
    
    updateIndicators() {
        const dots = this.indicatorsContainer.querySelectorAll('.video-dot');
        if (dots.length === 0) return;
        
        const activeIndex = this.currentIndex % dots.length;
        
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === activeIndex);
        });
    }
    
    onVideoLoaded() {
        console.log('Video loaded:', this.videos[this.currentIndex]);
        
        // Hide poster, show video with fade
        if (this.videoPoster && this.videoPoster.style.display !== 'none') {
            this.videoPoster.style.opacity = '0';
            setTimeout(() => {
                this.videoPoster.style.display = 'none';
            }, 500);
        }
        
        this.videoLoaded = true;
    }
    
    onVideoReady() {
        // Fade out transition overlay
        this.transition.classList.remove('active');
        this.isTransitioning = false;
        
        // Try to play
        this.videoElement.play().catch((err) => {
            console.log('Autoplay prevented:', err);
        });
    }
    
    onVideoEnded() {
        // Video naturally ended, go to next
        this.nextVideo();
    }
    
    loadVideo(index) {
        if (this.isTransitioning) return;
        
        this.currentIndex = index;
        const videoUrl = this.videos[index];
        
        console.log(`Loading video ${index + 1}/${this.videos.length}: ${videoUrl}`);
        
        // Start fade to black transition
        this.isTransitioning = true;
        this.transition.classList.add('active');
        
        // After fade to black, switch video
        setTimeout(() => {
            this.videoSource.src = videoUrl;
            this.videoElement.load();
            
            // Fallback: if video doesn't load in 3 seconds, skip to next
            setTimeout(() => {
                if (this.isTransitioning) {
                    console.log('Video load timeout, skipping...');
                    this.transition.classList.remove('active');
                    this.isTransitioning = false;
                    this.nextVideo();
                }
            }, 3000);
            
            this.updateIndicators();
        }, this.transitionDuration / 2);
    }
    
    nextVideo() {
        const nextIndex = (this.currentIndex + 1) % this.videos.length;
        this.loadVideo(nextIndex);
        this.resetAutoAdvance();
    }
    
    previousVideo() {
        const prevIndex = (this.currentIndex - 1 + this.videos.length) % this.videos.length;
        this.loadVideo(prevIndex);
        this.resetAutoAdvance();
    }
    
    goToVideo(index) {
        if (index !== this.currentIndex) {
            this.loadVideo(index);
            this.resetAutoAdvance();
        }
    }
    
    handleError(e) {
        console.error('Video error:', e);
        console.log('Skipping problematic video:', this.videos[this.currentIndex]);
        
        // Remove problematic video from list
        this.videos.splice(this.currentIndex, 1);
        
        if (this.videos.length === 0) {
            this.videos = [fallbackVideo];
            this.currentIndex = 0;
        } else {
            // Adjust index if needed
            if (this.currentIndex >= this.videos.length) {
                this.currentIndex = 0;
            }
        }
        
        // Reset transition state
        this.transition.classList.remove('active');
        this.isTransitioning = false;
        
        // Load next video
        setTimeout(() => this.loadVideo(this.currentIndex), 500);
    }
    
    startAutoAdvance() {
        this.stopAutoAdvance();
        
        // Auto-advance every displayDuration ms
        this.autoPlayInterval = setInterval(() => {
            this.nextVideo();
        }, this.displayDuration);
    }
    
    stopAutoAdvance() {
        if (this.autoPlayInterval) {
            clearInterval(this.autoPlayInterval);
            this.autoPlayInterval = null;
        }
    }
    
    resetAutoAdvance() {
        this.stopAutoAdvance();
        this.startAutoAdvance();
    }
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    // Small delay to ensure everything is loaded
    setTimeout(() => {
        new VideoCarousel();
    }, 100);
});
</script>

<style>
.home-page { overflow-x: hidden; }

/* Hero Section */
.hero-section {
    position: relative; 
    height: 100vh;
    display: flex; 
    align-items: center; 
    justify-content: center;
}

.video-container { 
    position: absolute; 
    inset: 0; 
    z-index: 0; 
}

/* Video Poster - Shows immediately while video loads */
.video-poster {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #1a1208 0%, #2d1f0d 50%, #1a1208 100%);
    z-index: 2;
    transition: opacity 0.5s ease;
}

.poster-gradient {
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(ellipse at 30% 40%, rgba(181, 96, 11, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 60%, rgba(209, 135, 44, 0.1) 0%, transparent 50%);
    animation: gradientPulse 4s ease-in-out infinite;
}

@keyframes gradientPulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
}

.hero-video { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    filter: brightness(0.55) saturate(1.1);
    z-index: 1;
}

.video-overlay {
    position: absolute; 
    inset: 0;
    background: linear-gradient(
        180deg, 
        rgba(26,18,8,0.4) 0%, 
        rgba(26,18,8,0.1) 30%,
        rgba(26,18,8,0.1) 70%,
        rgba(26,18,8,0.8) 100%
    );
    z-index: 3;
}

/* Video Transition - Fade to black effect */
.video-transition {
    position: absolute;
    inset: 0;
    background: #1a1208;
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: 4;
}

.video-transition.active {
    opacity: 1;
}

/* Video Indicators */
.video-indicators {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 10;
}

.video-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
}

.video-dot:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: scale(1.2);
}

.video-dot.active {
    background: #b5600b;
    border-color: #b5600b;
    transform: scale(1.3);
}

/* Hero Content */
.hero-content { 
    position: relative; 
    z-index: 10; 
    text-align: center; 
    padding: 20px; 
    max-width: 900px; 
}

.hero-title {
    font-size: clamp(2rem, 5vw, 3.5rem); 
    color: white;
    text-shadow: 2px 2px 30px rgba(0,0,0,0.7); 
    margin-bottom: 20px;
    font-weight: 600;
}

.hero-subtitle {
    font-size: clamp(1.1rem, 2.5vw, 1.5rem); 
    color: rgba(255,255,255,0.9);
    text-shadow: 1px 1px 15px rgba(0,0,0,0.6); 
    margin-bottom: 40px; 
    font-style: italic;
}

.hero-cta {
    display: inline-flex; 
    align-items: center; 
    gap: 12px;
    padding: 18px 40px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    color: white; 
    text-decoration: none; 
    border-radius: 50px;
    font-size: 1.2rem; 
    font-weight: 600;
    transition: all 0.4s ease;
    box-shadow: 0 10px 40px rgba(181, 96, 11, 0.5);
}

.hero-cta:hover { 
    transform: translateY(-5px) scale(1.05); 
    box-shadow: 0 15px 50px rgba(181, 96, 11, 0.6);
}

.hero-cta svg {
    transition: transform 0.3s ease;
}

.hero-cta:hover svg {
    transform: translateX(5px);
}

/* Scroll Indicator */
.scroll-indicator {
    position: absolute; 
    bottom: 40px; 
    left: 50%;
    transform: translateX(-50%); 
    text-align: center;
    color: rgba(255,255,255,0.7); 
    z-index: 10;
}

.scroll-indicator span { 
    display: block; 
    font-size: 0.85rem; 
    margin-bottom: 10px; 
    letter-spacing: 2px; 
    text-transform: uppercase; 
}

.scroll-arrow { 
    animation: bounce 2s infinite; 
}

.scroll-arrow svg {
    stroke: rgba(255, 255, 255, 0.7);
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(10px); }
}

/* Welcome Section */
.welcome-section {
    background: linear-gradient(180deg, #f5f0e8, #fff, #f5f0e8);
    padding: 100px 20px;
}

.welcome-container { 
    max-width: 900px; 
    margin: 0 auto; 
    text-align: center; 
}

.welcome-decoration { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 20px; 
    margin-bottom: 40px; 
}

.deco-line { 
    width: 80px; 
    height: 2px; 
    background: linear-gradient(90deg, transparent, #b5600b, transparent); 
}

.deco-year { 
    color: #b5600b; 
    font-size: 1.1rem; 
    font-weight: 600; 
    letter-spacing: 3px; 
}

.welcome-title { 
    font-size: 2.5rem; 
    color: #2d1f0d; 
    margin-bottom: 40px; 
}

.welcome-text { 
    color: #5a4a3a; 
    font-size: 1.15rem; 
    line-height: 1.9; 
    margin-bottom: 25px; 
    text-align: justify; 
}

.welcome-signature { 
    color: #b5600b; 
    font-size: 1.3rem; 
    font-style: italic; 
    margin: 40px 0; 
}

.welcome-actions { 
    display: flex; 
    justify-content: center; 
    gap: 15px; 
    flex-wrap: wrap; 
}

.btn {
    display: inline-flex; 
    align-items: center; 
    gap: 10px;
    padding: 14px 28px; 
    border-radius: 30px;
    font-size: 1rem; 
    font-weight: 600; 
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn svg {
    flex-shrink: 0;
}

.btn-primary {
    background: linear-gradient(135deg, #b5600b, #d1872c); 
    color: white;
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

.btn-primary:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 35px rgba(181, 96, 11, 0.5);
}

.btn-secondary { 
    background: transparent; 
    color: #b5600b; 
    border: 2px solid #b5600b; 
}

.btn-secondary:hover { 
    background: #b5600b; 
    color: white; 
}

.btn-tertiary {
    background: rgba(181, 96, 11, 0.1);
    color: #b5600b;
    border: 1px solid rgba(181, 96, 11, 0.3);
}

.btn-tertiary:hover {
    background: rgba(181, 96, 11, 0.2);
    border-color: #b5600b;
}

/* Animations */
.animate-fade-in-down { animation: fadeInDown 0.8s ease forwards; }
.animate-fade-in-up { animation: fadeInUp 0.8s ease forwards; }
.animate-scale-in { animation: scaleIn 0.6s ease forwards; }
.animate-fade-in { animation: fadeIn 0.8s ease forwards; }
[class*="animate-"] { opacity: 0; }
.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }
.delay-5 { animation-delay: 0.5s; }

@keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

@media (max-width: 768px) {
    .hero-title { font-size: 1.8rem; }
    .hero-cta { padding: 15px 30px; font-size: 1rem; }
    .welcome-section { padding: 60px 20px; }
    .welcome-title { font-size: 1.8rem; }
    
    .video-indicators { bottom: 80px; }
    .video-dot { width: 8px; height: 8px; }
    
    .welcome-actions { flex-direction: column; align-items: center; }
    .btn { width: 100%; max-width: 280px; justify-content: center; }
}
</style>
{% endblock %}