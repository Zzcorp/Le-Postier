<!-- templates/la_poste.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}La Poste{% endblock %}

{% block content %}
<div class="la-poste-page">
    <!-- Elegant Background -->
    <div class="poste-background">
        <div class="bg-gradient"></div>
        <div class="floating-elements" id="floating-elements"></div>
        <div class="dust-particles" id="dust-particles"></div>
    </div>

    <div class="poste-container">
        <!-- Header -->
        <header class="poste-header animate-fade-in-down">
            <div class="header-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>
            <h1>La Poste</h1>
            <p>Envoyez des cartes postales et partagez vos d√©couvertes</p>
            
            {% if unread_count > 0 %}
            <div class="unread-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                {{ unread_count }} nouvelle{{ unread_count|pluralize }} carte{{ unread_count|pluralize }}
            </div>
            {% endif %}
        </header>

        <!-- Signature Warning -->
        {% if not user_has_signature %}
        <div class="signature-warning animate-fade-in">
            <div class="warning-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div class="warning-content">
                <h3>Signature requise</h3>
                <p>Pour envoyer des cartes postales, vous devez d'abord cr√©er votre signature personnelle.</p>
                <a href="{% url 'profile' %}" class="btn-create-signature">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    </svg>
                    Cr√©er ma signature
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Main Actions -->
        <div class="poste-actions animate-fade-in-up delay-1">
            <button class="action-btn primary {% if not user_has_signature %}disabled{% endif %}" 
                    onclick="{% if user_has_signature %}openComposeModal(){% else %}showSignatureRequired(){% endif %}">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
                <span>√âcrire une carte</span>
            </button>
        </div>

        <!-- Tabs -->
        <div class="poste-tabs animate-fade-in delay-2">
            <button class="tab-btn active" data-tab="received" onclick="switchTab('received')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                    <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                </svg>
                Re√ßues
                {% if unread_count > 0 %}
                <span class="tab-badge">{{ unread_count }}</span>
                {% endif %}
            </button>
            <button class="tab-btn" data-tab="sent" onclick="switchTab('sent')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Envoy√©es
            </button>
            <button class="tab-btn" data-tab="wall" onclick="switchTab('wall')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Mur Public
            </button>
        </div>

        <!-- Content Sections -->
        <div class="poste-content">
            <!-- Received Tab -->
            <div class="tab-content active" id="received-tab">
                <div class="postcards-grid" id="received-grid">
                    {% for postcard in received_postcards %}
                    <div class="postcard-item {% if not postcard.is_read %}unread{% endif %}" 
                         data-id="{{ postcard.id }}"
                         data-is-animated="{{ postcard.is_animated|yesno:'true,false' }}">
                        <div class="postcard-image" onclick="viewPostcardImage({{ postcard.id }}, 'received')">
                            {% if postcard.is_animated and postcard.get_video_url %}
                            <video class="postcard-video" muted loop playsinline preload="none"
                                   data-src="{{ postcard.get_video_url }}">
                            </video>
                            <div class="video-play-indicator">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            {% endif %}
                            <img src="{{ postcard.get_vignette_url }}" alt="Carte postale" 
                                 class="{% if postcard.is_animated %}has-video{% endif %}">
                            {% if not postcard.is_read %}
                            <div class="new-badge">Nouveau</div>
                            {% endif %}
                            {% if postcard.is_animated %}
                            <div class="animated-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            {% endif %}
                        </div>
                        <div class="postcard-info">
                            <div class="postcard-sender">
                                <div class="sender-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <span>{{ postcard.sender.username }}</span>
                            </div>
                            <div class="postcard-actions-row">
                                <button class="view-message-btn" onclick="viewPostcardMessage({{ postcard.id }})" title="Voir le message">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    <span>Lire</span>
                                </button>
                                <span class="postcard-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                            <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                        </svg>
                        <h3>Pas de cartes re√ßues</h3>
                        <p>Invitez vos amis √† vous envoyer des cartes postales!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sent Tab -->
            <div class="tab-content" id="sent-tab">
                <div class="postcards-grid" id="sent-grid">
                    {% for postcard in sent_postcards %}
                    <div class="postcard-item" 
                         data-id="{{ postcard.id }}"
                         data-is-animated="{{ postcard.is_animated|yesno:'true,false' }}">
                        <div class="postcard-image" onclick="viewPostcardImage({{ postcard.id }}, 'sent')">
                            {% if postcard.is_animated and postcard.get_video_url %}
                            <video class="postcard-video" muted loop playsinline preload="none"
                                   data-src="{{ postcard.get_video_url }}">
                            </video>
                            <div class="video-play-indicator">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            {% endif %}
                            <img src="{{ postcard.get_vignette_url }}" alt="Carte postale"
                                 class="{% if postcard.is_animated %}has-video{% endif %}">
                            {% if postcard.visibility == 'public' %}
                            <div class="public-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            {% endif %}
                            {% if postcard.is_animated %}
                            <div class="animated-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            {% endif %}
                        </div>
                        <div class="postcard-info">
                            <div class="postcard-recipient">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13"/>
                                    <path d="M22 2L15 22 11 13 2 9 22 2z"/>
                                </svg>
                                {% if postcard.recipient %}
                                <span>√Ä {{ postcard.recipient.username }}</span>
                                {% else %}
                                <span>Publication publique</span>
                                {% endif %}
                            </div>
                            <div class="postcard-actions-row">
                                <button class="view-message-btn" onclick="viewPostcardMessage({{ postcard.id }})" title="Voir le message">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    <span>Voir</span>
                                </button>
                                <span class="postcard-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        <h3>Aucune carte envoy√©e</h3>
                        <p>Envoyez votre premi√®re carte postale!</p>
                        {% if user_has_signature %}
                        <button class="btn-primary" onclick="openComposeModal()">√âcrire une carte</button>
                        {% else %}
                        <a href="{% url 'profile' %}" class="btn-primary">Cr√©er ma signature d'abord</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Wall Tab -->
            <div class="tab-content" id="wall-tab">
                <div class="wall-feed" id="wall-feed">
                    {% for postcard in public_postcards %}
                    <div class="wall-post" data-id="{{ postcard.id }}">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <div class="author-info">
                                    <span class="author-name">{{ postcard.sender.username }}</span>
                                    <span class="post-date">{{ postcard.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="post-image" onclick="viewPostcardImage({{ postcard.id }}, 'wall')">
                            {% if postcard.is_animated and postcard.get_video_url %}
                            <video class="wall-video" muted loop playsinline preload="none"
                                   data-src="{{ postcard.get_video_url }}"
                                   onmouseenter="this.play()" onmouseleave="this.pause()">
                            </video>
                            <img src="{{ postcard.get_vignette_url }}" alt="Carte postale" class="has-video">
                            <div class="video-play-indicator">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </div>
                            {% else %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale">
                            {% endif %}
                        </div>
                        
                        <div class="post-actions">
                            <button class="post-action-btn" onclick="viewPostcardMessage({{ postcard.id }})">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                                <span>Lire le message</span>
                            </button>
                            <button class="post-action-btn" onclick="toggleComments({{ postcard.id }})">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <span>{{ postcard.comments.count }} commentaire{{ postcard.comments.count|pluralize }}</span>
                            </button>
                        </div>
                        
                        <div class="post-comments" id="comments-{{ postcard.id }}" style="display: none;">
                            <div class="comments-list">
                                {% for comment in postcard.comments.all %}
                                <div class="comment">
                                    <span class="comment-author">{{ comment.user.username }}</span>
                                    <p>{{ comment.message }}</p>
                                    <span class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <form class="comment-form" onsubmit="addComment(event, {{ postcard.id }})">
                                <input type="text" placeholder="√âcrire un commentaire..." maxlength="500" required>
                                <button type="submit">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"/>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <h3>Le mur est vide</h3>
                        <p>Soyez le premier √† publier une carte!</p>
                        {% if user_has_signature %}
                        <button class="btn-primary" onclick="openComposeModal()">Publier une carte</button>
                        {% else %}
                        <a href="{% url 'profile' %}" class="btn-primary">Cr√©er ma signature d'abord</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compose Modal -->
<div class="compose-modal" id="composeModal">
    <div class="modal-backdrop" onclick="closeComposeModal()"></div>
    <div class="modal-content compose-content">
        <button class="modal-close" onclick="closeComposeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <h2>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
            </svg>
            √âcrire une carte postale
        </h2>
        
        <!-- Step Indicator -->
        <div class="compose-steps">
            <div class="step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Carte</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">Message</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Envoi</span>
            </div>
        </div>
        
        <form id="composeForm" onsubmit="sendPostcard(event)">
            <!-- Step 1: Card Selection -->
            <div class="compose-step-content" id="step1Content">
                <!-- Card Type Toggle -->
                <div class="card-type-toggle">
                    <button type="button" class="type-btn active" data-type="static" onclick="setCardType('static')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        Carte classique
                    </button>
                    <button type="button" class="type-btn" data-type="animated" onclick="setCardType('animated')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        Carte anim√©e
                    </button>
                </div>
                
                <!-- Postcard Selection -->
                <div class="form-group">
                    <label>Choisir une carte</label>
                    <div class="postcard-selector" id="postcardSelector">
                        <div class="selector-preview" onclick="openPostcardPicker()">
                            <div class="preview-placeholder" id="previewPlaceholder">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <span>Cliquez pour choisir une carte</span>
                            </div>
                            <img id="selectedPostcardPreview" style="display: none;">
                            <video id="selectedPostcardVideo" style="display: none;" muted loop playsinline></video>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn-next" onclick="goToStep(2)" id="btnToStep2" disabled>
                    Suivant
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
            </div>
            
            <!-- Step 2: Message (Postcard Style) -->
            <div class="compose-step-content" id="step2Content" style="display: none;">
                <div class="postcard-compose-wrapper">
                    <div class="postcard-compose">
                        <!-- Postcard Background -->
                        <img src="{% static 'images/Cpa_Vierge.jpg' %}" alt="Carte Postale" class="postcard-bg-compose">
                        
                        <!-- Message Area (left side) -->
                        <textarea 
                            name="message" 
                            id="composeMessageInput"
                            class="compose-message-input"
                            placeholder="√âcrivez votre message..."
                            maxlength="55"
                            required
                        ></textarea>
                        
                        <!-- Stamp Area (top right) -->
                        <div class="compose-stamp-area">
                            <div class="stamp-placeholder-compose" id="stampPlaceholderCompose">
                                <span>Timbre</span>
                            </div>
                            <img src="" alt="Timbre" class="applied-stamp-compose" id="appliedStampCompose">
                        </div>
                        
                        <!-- Signature Area (right side) -->
                        <div class="compose-signature-area">
                            {% if user.signature_image %}
                            <img src="{{ user.signature_image.url }}" alt="Signature" class="compose-signature-img">
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Stamp Selection -->
                <div class="stamp-selection">
                    <p class="stamp-instruction">Choisissez votre affranchissement :</p>
                    <div class="stamps-row">
                        <div class="stamp-option" data-stamp="5c" onclick="selectStamp('5c')">
                            <img src="{% static 'images/Timbre_5c.png' %}" alt="5 centimes">
                            <span class="stamp-info">5c - 44 caract√®res</span>
                        </div>
                        <div class="stamp-option selected" data-stamp="10c" onclick="selectStamp('10c')">
                            <img src="{% static 'images/Timbre_10c.png' %}" alt="10 centimes">
                            <span class="stamp-info">10c - 55 caract√®res</span>
                        </div>
                    </div>
                </div>
                
                <div class="char-counter">
                    <span id="composeCharCount">0</span>/<span id="maxChars">55</span> caract√®res
                </div>
                
                <div class="step-buttons">
                    <button type="button" class="btn-back" onclick="goToStep(1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Retour
                    </button>
                    <button type="button" class="btn-next" onclick="goToStep(3)" id="btnToStep3" disabled>
                        Suivant
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Send Options -->
            <div class="compose-step-content" id="step3Content" style="display: none;">
                <!-- Visibility Toggle -->
                <div class="visibility-toggle">
                    <button type="button" class="visibility-btn active" data-visibility="private" onclick="setVisibility('private')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        Priv√©
                    </button>
                    <button type="button" class="visibility-btn" data-visibility="public" onclick="setVisibility('public')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        Public
                    </button>
                </div>
                
                <!-- Recipient (for private) -->
                <div class="form-group" id="recipientGroup">
                    <label>Destinataire</label>
                    <div class="recipient-input-wrapper">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <input type="text" id="recipientInput" placeholder="Nom d'utilisateur..." autocomplete="off">
                        <div class="user-suggestions" id="userSuggestions"></div>
                    </div>
                </div>
                
                <!-- Summary -->
                <div class="compose-summary">
                    <h4>R√©sum√© de votre envoi</h4>
                    <div class="summary-item">
                        <span class="summary-label">Carte :</span>
                        <span class="summary-value" id="summaryCard">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Type :</span>
                        <span class="summary-value" id="summaryType">Classique</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Timbre :</span>
                        <span class="summary-value" id="summaryStamp">10 centimes</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Message :</span>
                        <span class="summary-value" id="summaryMessage">-</span>
                    </div>
                </div>
                
                <div class="step-buttons">
                    <button type="button" class="btn-back" onclick="goToStep(2)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Retour
                    </button>
                    <button type="submit" class="btn-send">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Envoyer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Postcard Picker Modal -->
<div class="picker-modal" id="pickerModal">
    <div class="modal-backdrop" onclick="closePostcardPicker()"></div>
    <div class="modal-content picker-content">
        <button class="modal-close" onclick="closePostcardPicker()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <h2 id="pickerTitle">Choisir une carte postale</h2>
        
        <div class="picker-search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="pickerSearch" placeholder="Rechercher..." oninput="filterPostcards(this.value)">
        </div>
        
        <!-- Static Postcards Grid -->
        <div class="picker-grid" id="staticPickerGrid">
            {% for postcard in available_postcards %}
            <div class="picker-item" 
                 data-id="{{ postcard.id }}"
                 data-title="{{ postcard.title|lower }}"
                 data-number="{{ postcard.number }}"
                 onclick="selectPostcard({{ postcard.id }}, '{{ postcard.get_vignette_url }}', '{{ postcard.title|escapejs }}', '{{ postcard.number }}', false)">
                <img src="{{ postcard.get_vignette_url }}" alt="{{ postcard.title }}" loading="lazy">
                <span>N¬∞ {{ postcard.number }}</span>
            </div>
            {% endfor %}
        </div>
        
        <!-- Animated Postcards Grid -->
        <div class="picker-grid" id="animatedPickerGrid" style="display: none;">
            {% for postcard in animated_postcards %}
            <div class="picker-item animated-picker-item" 
                 data-id="{{ postcard.id }}"
                 data-title="{{ postcard.title|lower }}"
                 data-number="{{ postcard.number }}"
                 data-video="{{ postcard.get_first_video_url }}"
                 onclick="selectPostcard({{ postcard.id }}, '{{ postcard.get_vignette_url }}', '{{ postcard.title|escapejs }}', '{{ postcard.number }}', true, '{{ postcard.get_first_video_url }}')">
                <img src="{{ postcard.get_vignette_url }}" alt="{{ postcard.title }}" loading="lazy">
                <div class="animated-indicator">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                </div>
                <span>N¬∞ {{ postcard.number }}</span>
            </div>
            {% empty %}
            <div class="no-animated">
                <p>Aucune carte anim√©e disponible</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- View Image Modal -->
<div class="view-image-modal" id="viewImageModal">
    <div class="modal-backdrop" onclick="closeViewImageModal()"></div>
    <div class="modal-content view-image-content">
        <button class="modal-close" onclick="closeViewImageModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <div class="view-image-container">
            <img id="viewImageImg" src="" alt="Carte postale">
            <video id="viewImageVideo" style="display: none;" controls autoplay loop playsinline></video>
        </div>
    </div>
</div>

<!-- View Message Modal (Postcard Style) -->
<div class="view-message-modal" id="viewMessageModal">
    <div class="modal-backdrop" onclick="closeViewMessageModal()"></div>
    <div class="modal-content view-message-content">
        <button class="modal-close" onclick="closeViewMessageModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <div class="message-postcard-wrapper">
            <div class="message-postcard">
                <img src="{% static 'images/Cpa_Vierge.jpg' %}" alt="Carte Postale" class="message-postcard-bg">
                
                <!-- Message Area -->
                <div class="message-text-area" id="messageTextArea">
                    <p id="viewMessageText"></p>
                </div>
                
                <!-- Stamp Area -->
                <div class="message-stamp-area">
                    <img id="viewMessageStamp" src="" alt="Timbre">
                </div>
                
                <!-- Signature Area -->
                <div class="message-signature-area">
                    <img id="viewMessageSignature" src="" alt="Signature">
                    <p class="signature-name" id="viewMessageSender"></p>
                </div>
            </div>
        </div>
        
        <div class="message-meta">
            <span id="viewMessageDate"></span>
        </div>
    </div>
</div>

<!-- Signature Required Modal -->
<div class="signature-required-modal" id="signatureRequiredModal">
    <div class="modal-backdrop" onclick="closeSignatureRequiredModal()"></div>
    <div class="modal-content signature-required-content">
        <div class="signature-required-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                <path d="M2 2l7.586 7.586"/>
                <circle cx="11" cy="11" r="2"/>
            </svg>
        </div>
        <h3>Signature requise</h3>
        <p>Pour envoyer des cartes postales, vous devez d'abord cr√©er votre signature personnelle dans votre profil.</p>
        <div class="signature-required-actions">
            <button class="btn-cancel" onclick="closeSignatureRequiredModal()">Plus tard</button>
            <a href="{% url 'profile' %}" class="btn-create">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                </svg>
                Cr√©er ma signature
            </a>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let currentVisibility = 'private';
let selectedPostcardId = null;
let selectedPostcardNumber = '';
let selectedPostcardTitle = '';
let selectedVideoUrl = null;
let isAnimatedCard = false;
let currentStamp = '10c';
let currentStep = 1;
const userHasSignature = {{ user_has_signature|yesno:"true,false" }};

// ============================================
// BACKGROUND ANIMATIONS
// ============================================
function createFloatingElements() {
    const container = document.getElementById('floating-elements');
    if (!container) return;
    
    // Elegant, somber icons (postal/writing themed)
    const icons = [
        '‚úâÔ∏è', 'üìú', 'üñãÔ∏è', 'üìÆ', 'üèõÔ∏è', '‚öúÔ∏è', 'üïäÔ∏è', 'üìù', 'üé≠', 'üè∫',
        'üìØ', 'üóùÔ∏è', '‚åõ', 'üï∞Ô∏è', 'üìñ', 'üé™', 'üè∞', '‚õ™', 'üåô', '‚ú®'
    ];
    
    for (let i = 0; i < 25; i++) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        element.textContent = icons[Math.floor(Math.random() * icons.length)];
        element.style.left = Math.random() * 100 + '%';
        element.style.animationDuration = (20 + Math.random() * 20) + 's';
        element.style.animationDelay = (Math.random() * 20) + 's';
        element.style.fontSize = (16 + Math.random() * 16) + 'px';
        element.style.opacity = 0.03 + Math.random() * 0.05;
        container.appendChild(element);
    }
}

function createDustParticles() {
    const container = document.getElementById('dust-particles');
    if (!container) return;
    
    for (let i = 0; i < 60; i++) {
        const particle = document.createElement('div');
        particle.className = 'dust-particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.width = (2 + Math.random() * 3) + 'px';
        particle.style.height = particle.style.width;
        particle.style.animationDuration = (10 + Math.random() * 20) + 's';
        particle.style.animationDelay = (Math.random() * 10) + 's';
        container.appendChild(particle);
    }
}

// ============================================
// TAB SWITCHING
// ============================================
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tab + '-tab').classList.add('active');
}

// ============================================
// COMPOSE MODAL
// ============================================
function openComposeModal() {
    if (!userHasSignature) {
        showSignatureRequired();
        return;
    }
    document.getElementById('composeModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    resetComposeForm();
}

function closeComposeModal() {
    document.getElementById('composeModal').classList.remove('active');
    document.body.style.overflow = '';
}

function resetComposeForm() {
    document.getElementById('composeForm').reset();
    selectedPostcardId = null;
    selectedPostcardNumber = '';
    selectedPostcardTitle = '';
    selectedVideoUrl = null;
    isAnimatedCard = false;
    currentStamp = '10c';
    currentStep = 1;
    
    // Reset UI
    document.getElementById('selectedPostcardPreview').style.display = 'none';
    document.getElementById('selectedPostcardVideo').style.display = 'none';
    document.getElementById('previewPlaceholder').style.display = 'flex';
    document.getElementById('btnToStep2').disabled = true;
    document.getElementById('btnToStep3').disabled = true;
    document.getElementById('composeCharCount').textContent = '0';
    document.getElementById('maxChars').textContent = '55';
    document.getElementById('composeMessageInput').maxLength = 55;
    
    // Reset stamps
    document.querySelectorAll('.stamp-option').forEach(s => s.classList.remove('selected'));
    document.querySelector('.stamp-option[data-stamp="10c"]').classList.add('selected');
    document.getElementById('appliedStampCompose').src = '';
    document.getElementById('appliedStampCompose').style.display = 'none';
    document.getElementById('stampPlaceholderCompose').style.display = 'flex';
    
    // Reset card type
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.type-btn[data-type="static"]').classList.add('active');
    document.getElementById('staticPickerGrid').style.display = 'grid';
    document.getElementById('animatedPickerGrid').style.display = 'none';
    
    // Reset visibility
    setVisibility('private');
    
    // Go to step 1
    goToStep(1);
}

function goToStep(step) {
    currentStep = step;
    
    // Update step indicators
    document.querySelectorAll('.compose-steps .step').forEach((s, i) => {
        s.classList.toggle('active', i + 1 <= step);
        s.classList.toggle('completed', i + 1 < step);
    });
    
    // Show/hide content
    document.getElementById('step1Content').style.display = step === 1 ? 'block' : 'none';
    document.getElementById('step2Content').style.display = step === 2 ? 'block' : 'none';
    document.getElementById('step3Content').style.display = step === 3 ? 'block' : 'none';
    
    // Update summary on step 3
    if (step === 3) {
        updateSummary();
    }
}

function updateSummary() {
    document.getElementById('summaryCard').textContent = selectedPostcardNumber ? 
        `N¬∞ ${selectedPostcardNumber}` : '-';
    document.getElementById('summaryType').textContent = isAnimatedCard ? 'Anim√©e' : 'Classique';
    document.getElementById('summaryStamp').textContent = currentStamp === '5c' ? '5 centimes' : '10 centimes';
    
    const message = document.getElementById('composeMessageInput').value;
    document.getElementById('summaryMessage').textContent = message ? 
        (message.length > 30 ? message.substring(0, 30) + '...' : message) : '-';
}

// ============================================
// CARD TYPE & SELECTION
// ============================================
function setCardType(type) {
    isAnimatedCard = type === 'animated';
    
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
    
    document.getElementById('staticPickerGrid').style.display = type === 'static' ? 'grid' : 'none';
    document.getElementById('animatedPickerGrid').style.display = type === 'animated' ? 'grid' : 'none';
    document.getElementById('pickerTitle').textContent = type === 'animated' ? 
        'Choisir une carte anim√©e' : 'Choisir une carte postale';
    
    // Reset selection when changing type
    selectedPostcardId = null;
    selectedVideoUrl = null;
    document.getElementById('selectedPostcardPreview').style.display = 'none';
    document.getElementById('selectedPostcardVideo').style.display = 'none';
    document.getElementById('previewPlaceholder').style.display = 'flex';
    document.getElementById('btnToStep2').disabled = true;
}

function openPostcardPicker() {
    document.getElementById('pickerModal').classList.add('active');
}

function closePostcardPicker() {
    document.getElementById('pickerModal').classList.remove('active');
}

function filterPostcards(query) {
    const gridId = isAnimatedCard ? 'animatedPickerGrid' : 'staticPickerGrid';
    const items = document.querySelectorAll(`#${gridId} .picker-item`);
    query = query.toLowerCase();
    
    items.forEach(item => {
        const title = item.dataset.title || '';
        const number = item.dataset.number || '';
        item.style.display = (title.includes(query) || number.includes(query)) ? '' : 'none';
    });
}

function selectPostcard(id, url, title, number, animated = false, videoUrl = null) {
    selectedPostcardId = id;
    selectedPostcardTitle = title;
    selectedPostcardNumber = number;
    selectedVideoUrl = videoUrl;
    isAnimatedCard = animated;
    
    const preview = document.getElementById('selectedPostcardPreview');
    const video = document.getElementById('selectedPostcardVideo');
    const placeholder = document.getElementById('previewPlaceholder');
    
    if (animated && videoUrl) {
        preview.style.display = 'none';
        video.src = videoUrl;
        video.style.display = 'block';
        video.play();
    } else {
        video.style.display = 'none';
        video.pause();
        preview.src = url;
        preview.style.display = 'block';
    }
    
    placeholder.style.display = 'none';
    document.getElementById('btnToStep2').disabled = false;
    
    closePostcardPicker();
}

// ============================================
// STAMP SELECTION
// ============================================
function selectStamp(stamp) {
    currentStamp = stamp;
    const maxChars = stamp === '5c' ? 44 : 55;
    
    document.querySelectorAll('.stamp-option').forEach(s => {
        s.classList.toggle('selected', s.dataset.stamp === stamp);
    });
    
    document.getElementById('maxChars').textContent = maxChars;
    document.getElementById('composeMessageInput').maxLength = maxChars;
    
    // Update applied stamp
    const stampImg = document.getElementById('appliedStampCompose');
    const stampPlaceholder = document.getElementById('stampPlaceholderCompose');
    
    if (stamp === '5c') {
        stampImg.src = '{% static "images/Timbre_5c.png" %}';
    } else {
        stampImg.src = '{% static "images/Timbre_10c.png" %}';
    }
    stampImg.style.display = 'block';
    stampPlaceholder.style.display = 'none';
    
    // Check if message exceeds new limit
    const message = document.getElementById('composeMessageInput');
    if (message.value.length > maxChars) {
        message.value = message.value.substring(0, maxChars);
        document.getElementById('composeCharCount').textContent = maxChars;
    }
    
    validateStep2();
}

// Message character counter
document.getElementById('composeMessageInput').addEventListener('input', function() {
    document.getElementById('composeCharCount').textContent = this.value.length;
    validateStep2();
});

function validateStep2() {
    const message = document.getElementById('composeMessageInput').value.trim();
    document.getElementById('btnToStep3').disabled = message.length === 0;
}

// ============================================
// VISIBILITY & RECIPIENT
// ============================================
function setVisibility(vis) {
    currentVisibility = vis;
    document.querySelectorAll('.visibility-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.visibility === vis);
    });
    document.getElementById('recipientGroup').style.display = vis === 'private' ? 'block' : 'none';
}

// User search
let searchTimeout;
document.getElementById('recipientInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        document.getElementById('userSuggestions').innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/users/search/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            const suggestions = document.getElementById('userSuggestions');
            suggestions.innerHTML = data.users.map(u => `
                <div class="suggestion-item" onclick="selectRecipient('${u.username}')">
                    <span class="suggestion-name">${u.username}</span>
                    <span class="suggestion-category">${u.category}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
});

function selectRecipient(username) {
    document.getElementById('recipientInput').value = username;
    document.getElementById('userSuggestions').innerHTML = '';
}

// ============================================
// SEND POSTCARD
// ============================================
async function sendPostcard(event) {
    event.preventDefault();
    
    const message = document.getElementById('composeMessageInput').value.trim();
    const recipient = document.getElementById('recipientInput').value.trim();
    
    if (currentVisibility === 'private' && !recipient) {
        showNotification('Veuillez entrer un destinataire', 'error');
        return;
    }
    
    if (!selectedPostcardId) {
        showNotification('Veuillez s√©lectionner une carte postale', 'error');
        return;
    }
    
    if (!message) {
        showNotification('Veuillez √©crire un message', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/la-poste/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                message,
                recipient: currentVisibility === 'private' ? recipient : null,
                visibility: currentVisibility,
                postcard_id: selectedPostcardId,
                stamp_type: currentStamp,
                is_animated: isAnimatedCard
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            closeComposeModal();
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Erreur lors de l\'envoi', 'error');
    }
}

// ============================================
// VIEW POSTCARD IMAGE
// ============================================
function viewPostcardImage(id, tab) {
    const item = document.querySelector(`.postcard-item[data-id="${id}"], .wall-post[data-id="${id}"]`);
    if (!item) return;
    
    const img = item.querySelector('.postcard-image img, .post-image img');
    const video = item.querySelector('.postcard-video, .wall-video');
    const isAnimated = item.dataset.isAnimated === 'true';
    
    const modalImg = document.getElementById('viewImageImg');
    const modalVideo = document.getElementById('viewImageVideo');
    
    if (isAnimated && video && video.dataset.src) {
        modalImg.style.display = 'none';
        modalVideo.src = video.dataset.src;
        modalVideo.style.display = 'block';
        modalVideo.play();
    } else if (img) {
        modalVideo.style.display = 'none';
        modalVideo.pause();
        modalImg.src = img.src;
        modalImg.style.display = 'block';
    }
    
    document.getElementById('viewImageModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeViewImageModal() {
    const video = document.getElementById('viewImageVideo');
    video.pause();
    document.getElementById('viewImageModal').classList.remove('active');
    document.body.style.overflow = '';
}

// ============================================
// VIEW MESSAGE
// ============================================
async function viewPostcardMessage(id) {
    try {
        const response = await fetch(`/api/la-poste/${id}/message/`);
        const data = await response.json();
        
        if (!response.ok) {
            showNotification(data.error, 'error');
            return;
        }
        
        // Set message text
        document.getElementById('viewMessageText').textContent = data.message;
        
        // Set stamp
        const stampImg = document.getElementById('viewMessageStamp');
        if (data.stamp_type === '5c') {
            stampImg.src = '{% static "images/Timbre_5c.png" %}';
        } else {
            stampImg.src = '{% static "images/Timbre_10c.png" %}';
        }
        
        // Set signature
        const sigImg = document.getElementById('viewMessageSignature');
        if (data.sender_signature_url) {
            sigImg.src = data.sender_signature_url;
            sigImg.style.display = 'block';
        } else {
            sigImg.style.display = 'none';
        }
        
        // Set sender name and date
        document.getElementById('viewMessageSender').textContent = data.sender_username;
        document.getElementById('viewMessageDate').textContent = data.created_at;
        
        // Mark as read in UI
        const item = document.querySelector(`.postcard-item[data-id="${id}"]`);
        if (item) {
            item.classList.remove('unread');
            const badge = item.querySelector('.new-badge');
            if (badge) badge.remove();
        }
        
        document.getElementById('viewMessageModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
    } catch (error) {
        showNotification('Erreur lors du chargement du message', 'error');
    }
}

function closeViewMessageModal() {
    document.getElementById('viewMessageModal').classList.remove('active');
    document.body.style.overflow = '';
}

// ============================================
// SIGNATURE REQUIRED
// ============================================
function showSignatureRequired() {
    document.getElementById('signatureRequiredModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeSignatureRequiredModal() {
    document.getElementById('signatureRequiredModal').classList.remove('active');
    document.body.style.overflow = '';
}

// ============================================
// COMMENTS
// ============================================
function toggleComments(id) {
    const comments = document.getElementById(`comments-${id}`);
    comments.style.display = comments.style.display === 'none' ? 'block' : 'none';
}

async function addComment(event, postcardId) {
    event.preventDefault();
    const input = event.target.querySelector('input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        const response = await fetch(`/api/la-poste/${postcardId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const list = document.querySelector(`#comments-${postcardId} .comments-list`);
            list.innerHTML += `
                <div class="comment">
                    <span class="comment-author">${data.comment.user}</span>
                    <p>${data.comment.message}</p>
                    <span class="comment-date">${data.comment.created_at}</span>
                </div>
            `;
            input.value = '';
        }
    } catch (error) {
        console.error('Comment error:', error);
    }
}

// ============================================
// VIDEO HOVER EFFECTS
// ============================================
function initVideoHovers() {
    document.querySelectorAll('.postcard-item, .wall-post').forEach(item => {
        const video = item.querySelector('.postcard-video, .wall-video');
        if (!video) return;
        
        item.addEventListener('mouseenter', () => {
            if (video.dataset.src && !video.src) {
                video.src = video.dataset.src;
            }
            video.play().catch(() => {});
        });
        
        item.addEventListener('mouseleave', () => {
            video.pause();
            video.currentTime = 0;
        });
    });
}

// ============================================
// NOTIFICATIONS
// ============================================
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'}
        </svg>
        ${message}
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 4000);
}

// ============================================
// KEYBOARD NAVIGATION
// ============================================
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeComposeModal();
        closePostcardPicker();
        closeViewImageModal();
        closeViewMessageModal();
        closeSignatureRequiredModal();
    }
});

// ============================================
// INITIALIZE
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    createFloatingElements();
    createDustParticles();
    initVideoHovers();
    
    // Auto-select stamp on load
    selectStamp('10c');
});
</script>

<style>
/* ========================================
   LA POSTE PAGE STYLES
   ======================================== */
.la-poste-page {
    min-height: 100vh;
    position: relative;
    padding: 80px 20px 60px;
}

/* Background */
.poste-background {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, #0d0906 0%, #1a1208 30%, #2d1f0d 60%, #1a1208 100%);
    z-index: 0;
    overflow: hidden;
}

.bg-gradient {
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(181, 96, 11, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(181, 96, 11, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(139, 69, 19, 0.03) 0%, transparent 70%);
}

/* Floating Elements */
.floating-element {
    position: absolute;
    animation: float-element linear infinite;
    pointer-events: none;
    filter: grayscale(50%);
}

@keyframes float-element {
    0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
    }
    5% { opacity: 0.05; }
    95% { opacity: 0.05; }
    100% {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
    }
}

/* Dust Particles */
.dust-particle {
    position: absolute;
    background: radial-gradient(circle, rgba(255, 248, 220, 0.4) 0%, transparent 70%);
    border-radius: 50%;
    animation: dust-float ease-in-out infinite;
    pointer-events: none;
}

@keyframes dust-float {
    0%, 100% {
        transform: translate(0, 0) scale(1);
        opacity: 0.2;
    }
    25% {
        transform: translate(30px, -20px) scale(1.2);
        opacity: 0.4;
    }
    50% {
        transform: translate(-20px, -40px) scale(0.8);
        opacity: 0.3;
    }
    75% {
        transform: translate(10px, -30px) scale(1.1);
        opacity: 0.4;
    }
}

.poste-container {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
}

/* Header */
.poste-header {
    text-align: center;
    margin-bottom: 40px;
}

.header-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 90px;
    height: 90px;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.15), rgba(181, 96, 11, 0.05));
    border-radius: 24px;
    margin-bottom: 25px;
    border: 1px solid rgba(181, 96, 11, 0.25);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.header-icon svg {
    stroke: #d1872c;
}

.poste-header h1 {
    font-size: 2.8rem;
    color: white;
    margin-bottom: 12px;
    text-shadow: 2px 2px 20px rgba(0, 0, 0, 0.5);
    letter-spacing: 2px;
}

.poste-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.15rem;
    font-style: italic;
}

.unread-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    padding: 12px 24px;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(74, 222, 128, 0.05));
    border: 1px solid rgba(74, 222, 128, 0.35);
    border-radius: 30px;
    color: #4ade80;
    font-size: 0.95rem;
}

/* Signature Warning */
.signature-warning {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 25px 30px;
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
    border: 1px solid rgba(251, 191, 36, 0.3);
    border-radius: 16px;
    margin-bottom: 30px;
}

.warning-icon {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    background: rgba(251, 191, 36, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.warning-icon svg {
    stroke: #fbbf24;
}

.warning-content h3 {
    color: #fbbf24;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.warning-content p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-bottom: 12px;
}

.btn-create-signature {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    color: white;
    text-decoration: none;
    border-radius: 20px;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.btn-create-signature:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

/* Actions */
.poste-actions {
    display: flex;
    justify-content: center;
    margin-bottom: 35px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 38px;
    border: none;
    border-radius: 35px;
    cursor: pointer;
    font-size: 1.15rem;
    transition: all 0.3s;
}

.action-btn.primary {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    color: white;
    box-shadow: 0 10px 35px rgba(181, 96, 11, 0.4);
}

.action-btn.primary:hover:not(.disabled) {
    transform: translateY(-4px);
    box-shadow: 0 15px 45px rgba(181, 96, 11, 0.5);
}

.action-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Tabs */
.poste-tabs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 35px;
    flex-wrap: wrap;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 30px;
    color: rgba(255, 255, 255, 0.65);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    font-size: 0.95rem;
}

.tab-btn svg {
    stroke: rgba(255, 255, 255, 0.45);
}

.tab-btn:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.3);
}

.tab-btn.active {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-color: #b5600b;
    color: white;
}

.tab-btn.active svg {
    stroke: white;
}

.tab-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 22px;
    height: 22px;
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border-radius: 11px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0d0906;
    font-weight: 700;
}

/* Tab Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Postcards Grid */
.postcards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
}

.postcard-item {
    background: linear-gradient(165deg, rgba(45, 35, 25, 0.95), rgba(30, 22, 15, 0.98));
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.4s ease;
}

.postcard-item:hover {
    transform: translateY(-6px);
    border-color: rgba(181, 96, 11, 0.35);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
}

.postcard-item.unread {
    border-color: rgba(74, 222, 128, 0.35);
    box-shadow: 0 0 30px rgba(74, 222, 128, 0.1);
}

.postcard-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    background: #0d0906;
    cursor: pointer;
}

.postcard-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.postcard-item:hover .postcard-image img {
    transform: scale(1.05);
}

.postcard-image img.has-video {
    position: relative;
    z-index: 1;
}

.postcard-video, .wall-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.postcard-item:hover .postcard-video,
.wall-post:hover .wall-video {
    opacity: 1;
}

.postcard-item:hover .postcard-image img.has-video {
    opacity: 0;
}

.video-play-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background: rgba(181, 96, 11, 0.85);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.postcard-item:hover .video-play-indicator,
.wall-post:hover .video-play-indicator {
    opacity: 1;
}

.new-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 6px 14px;
    background: linear-gradient(135deg, #4ade80, #22c55e);
    color: #0d0906;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    z-index: 5;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.animated-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    width: 30px;
    height: 30px;
    background: rgba(181, 96, 11, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
}

.public-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 6px 12px;
    background: rgba(181, 96, 11, 0.9);
    color: white;
    border-radius: 15px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 5;
}

.postcard-info {
    padding: 18px;
}

.postcard-sender, .postcard-recipient {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.sender-avatar {
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: white;
    overflow: hidden;
    flex-shrink: 0;
}

.sender-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.postcard-sender span, .postcard-recipient span {
    color: white;
    font-weight: 500;
    font-size: 0.95rem;
}

.postcard-recipient svg {
    stroke: #b5600b;
    flex-shrink: 0;
}

.postcard-actions-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.view-message-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(181, 96, 11, 0.15);
    border: 1px solid rgba(181, 96, 11, 0.3);
    border-radius: 20px;
    color: #ffc168;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
}

.view-message-btn:hover {
    background: rgba(181, 96, 11, 0.3);
    transform: translateY(-2px);
}

.postcard-date {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.8rem;
}

/* Wall Feed */
.wall-feed {
    max-width: 650px;
    margin: 0 auto;
}

.wall-post {
    background: linear-gradient(165deg, rgba(45, 35, 25, 0.95), rgba(30, 22, 15, 0.98));
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.06);
}

.post-header {
    padding: 18px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.post-author {
    display: flex;
    align-items: center;
    gap: 14px;
}

.author-avatar {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
    overflow: hidden;
}

.author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.author-info {
    display: flex;
    flex-direction: column;
}

.author-name {
    color: white;
    font-weight: 600;
    font-size: 1rem;
}

.post-date {
    color: rgba(255, 255, 255, 0.45);
    font-size: 0.8rem;
    margin-top: 3px;
}

.post-image {
    aspect-ratio: 4/3;
    overflow: hidden;
    cursor: pointer;
    position: relative;
}

.post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.wall-post:hover .post-image img:not(.has-video) {
    transform: scale(1.03);
}

.post-actions {
    padding: 12px 18px;
    display: flex;
    gap: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.post-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.post-action-btn:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.35);
    color: white;
}

.post-comments {
    padding: 18px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.comments-list {
    margin-bottom: 18px;
    max-height: 250px;
    overflow-y: auto;
}

.comment {
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.comment:last-child {
    border-bottom: none;
}

.comment-author {
    color: #d1872c;
    font-weight: 600;
    font-size: 0.9rem;
}

.comment p {
    color: rgba(255, 255, 255, 0.85);
    margin: 6px 0;
    font-size: 0.9rem;
    line-height: 1.5;
}

.comment-date {
    color: rgba(255, 255, 255, 0.35);
    font-size: 0.75rem;
}

.comment-form {
    display: flex;
    gap: 12px;
}

.comment-form input {
    flex: 1;
    padding: 12px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    color: white;
    font-size: 0.9rem;
}

.comment-form input:focus {
    outline: none;
    border-color: #b5600b;
}

.comment-form button {
    width: 44px;
    height: 44px;
    padding: 0;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s;
}

.comment-form button:hover {
    transform: scale(1.1);
}

/* Empty State */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 70px 25px;
}

.empty-state svg {
    stroke: rgba(255, 255, 255, 0.15);
    margin-bottom: 25px;
}

.empty-state h3 {
    color: white;
    margin-bottom: 12px;
    font-size: 1.3rem;
}

.empty-state p {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 25px;
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 30px;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    text-decoration: none;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(181, 96, 11, 0.4);
}

/* ========================================
   MODALS
   ======================================== */
.compose-modal, .picker-modal, .view-image-modal, .view-message-modal, .signature-required-modal {
    position: fixed;
    inset: 0;
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.compose-modal.active, .picker-modal.active, .view-image-modal.active, 
.view-message-modal.active, .signature-required-modal.active {
    display: flex;
}

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.92);
    backdrop-filter: blur(8px);
}

.modal-content {
    position: relative;
    background: linear-gradient(165deg, #1f1a15 0%, #0d0906 100%);
    border-radius: 24px;
    max-width: 550px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(181, 96, 11, 0.25);
    box-shadow: 0 30px 100px rgba(0, 0, 0, 0.6);
}

.modal-close {
    position: absolute;
    top: 18px;
    right: 18px;
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s;
}

.modal-close:hover {
    background: #b5600b;
    border-color: #b5600b;
    transform: rotate(90deg);
}

/* Compose Modal Specifics */
.compose-content {
    padding: 35px;
    max-width: 600px;
}

.compose-content h2 {
    display: flex;
    align-items: center;
    gap: 14px;
    color: white;
    margin-bottom: 30px;
    font-size: 1.4rem;
}

.compose-content h2 svg {
    stroke: #d1872c;
}

/* Steps Indicator */
.compose-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 35px;
    padding: 0 20px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.step-number {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.5);
    transition: all 0.3s;
}

.step.active .step-number,
.step.completed .step-number {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-color: #b5600b;
    color: white;
}

.step-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
}

.step.active .step-label {
    color: #ffc168;
}

.step-line {
    flex: 1;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    margin: 0 15px;
    margin-bottom: 25px;
}

/* Card Type Toggle */
.card-type-toggle {
    display: flex;
    gap: 12px;
    margin-bottom: 25px;
}

.type-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.95rem;
}

.type-btn.active {
    background: rgba(181, 96, 11, 0.25);
    border-color: #b5600b;
    color: white;
}

.type-btn.active svg {
    stroke: #ffc168;
}

/* Form Groups */
.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    color: rgba(255, 255, 255, 0.85);
    margin-bottom: 10px;
    font-size: 0.95rem;
}

/* Postcard Selector */
.postcard-selector {
    margin-bottom: 15px;
}

.selector-preview {
    width: 100%;
    aspect-ratio: 4/3;
    max-height: 220px;
    background: rgba(0, 0, 0, 0.35);
    border: 2px dashed rgba(181, 96, 11, 0.35);
    border-radius: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    overflow: hidden;
}

.selector-preview:hover {
    border-color: #b5600b;
    background: rgba(181, 96, 11, 0.1);
}

.preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: rgba(255, 255, 255, 0.45);
}

.preview-placeholder svg {
    stroke: rgba(255, 255, 255, 0.25);
}

#selectedPostcardPreview, #selectedPostcardVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Postcard Compose Style */
.postcard-compose-wrapper {
    perspective: 1200px;
    margin-bottom: 25px;
}

.postcard-compose {
    position: relative;
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
}

.postcard-bg-compose {
    width: 100%;
    height: auto;
    display: block;
}

.compose-message-input {
    position: absolute;
    left: 4%;
    top: 42%;
    width: 48%;
    height: 45%;
    padding: 12px;
    background: transparent;
    border: none;
    resize: none;
    font-family: 'Dancing Script', cursive, Georgia, serif;
    font-size: 14px;
    color: #4a3728;
    line-height: 1.5;
}

.compose-message-input:focus {
    outline: none;
}

.compose-message-input::placeholder {
    color: rgba(74, 55, 40, 0.45);
    font-style: italic;
}

.compose-stamp-area {
    position: absolute;
    right: 10%;
    top: 5%;
    width: 60px;
    height: 75px;
}

.stamp-placeholder-compose {
    width: 100%;
    height: 100%;
    border: 2px dashed rgba(74, 55, 40, 0.25);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stamp-placeholder-compose span {
    font-size: 10px;
    color: rgba(74, 55, 40, 0.4);
}

.applied-stamp-compose {
    width: 100%;
    height: auto;
    display: none;
    filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.25));
}

.compose-signature-area {
    position: absolute;
    right: 8%;
    top: 55%;
    width: 35%;
    display: flex;
    justify-content: center;
}

.compose-signature-img {
    max-width: 100%;
    max-height: 60px;
}

/* Stamp Selection */
.stamp-selection {
    margin-bottom: 20px;
}

.stamp-instruction {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-bottom: 15px;
    text-align: center;
}

.stamps-row {
    display: flex;
    justify-content: center;
    gap: 25px;
}

.stamp-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.stamp-option:hover {
    background: rgba(181, 96, 11, 0.1);
    border-color: rgba(181, 96, 11, 0.3);
}

.stamp-option.selected {
    background: rgba(181, 96, 11, 0.2);
    border-color: #b5600b;
}

.stamp-option img {
    height: 70px;
    width: auto;
    filter: drop-shadow(2px 2px 5px rgba(0, 0, 0, 0.3));
    transition: transform 0.3s;
}

.stamp-option:hover img {
    transform: scale(1.05);
}

.stamp-info {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.stamp-option.selected .stamp-info {
    color: #ffc168;
}

.char-counter {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
    margin-bottom: 20px;
}

/* Step Buttons */
.step-buttons {
    display: flex;
    gap: 15px;
    justify-content: space-between;
}

.btn-back, .btn-next, .btn-send {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    border-radius: 12px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-back {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: white;
}

.btn-back:hover {
    background: rgba(255, 255, 255, 0.12);
}

.btn-next {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    color: white;
    margin-left: auto;
}

.btn-next:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.btn-next:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

.btn-send {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    color: white;
}

.btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
}

/* Visibility Toggle */
.visibility-toggle {
    display: flex;
    gap: 12px;
    margin-bottom: 25px;
}

.visibility-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
}

.visibility-btn.active {
    background: rgba(181, 96, 11, 0.25);
    border-color: #b5600b;
    color: white;
}

.visibility-btn.active svg {
    stroke: #ffc168;
}

/* Recipient Input */
.recipient-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.recipient-input-wrapper svg {
    position: absolute;
    left: 14px;
    stroke: rgba(255, 255, 255, 0.4);
}

.recipient-input-wrapper input {
    width: 100%;
    padding: 14px 14px 14px 45px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 1rem;
}

.recipient-input-wrapper input:focus {
    outline: none;
    border-color: #b5600b;
}

.user-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #1f1a15;
    border: 1px solid rgba(181, 96, 11, 0.3);
    border-radius: 12px;
    margin-top: 6px;
    max-height: 220px;
    overflow-y: auto;
    z-index: 10;
}

.suggestion-item {
    display: flex;
    justify-content: space-between;
    padding: 14px 18px;
    cursor: pointer;
    transition: background 0.2s;
}

.suggestion-item:hover {
    background: rgba(181, 96, 11, 0.2);
}

.suggestion-name {
    color: white;
}

.suggestion-category {
    color: rgba(255, 255, 255, 0.45);
    font-size: 0.8rem;
}

/* Summary */
.compose-summary {
    background: rgba(0, 0, 0, 0.25);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
}

.compose-summary h4 {
    color: #ffc168;
    margin-bottom: 15px;
    font-size: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.summary-value {
    color: white;
    font-size: 0.9rem;
}

/* Picker Modal */
.picker-content {
    max-width: 750px;
    padding: 35px;
}

.picker-content h2 {
    color: white;
    margin-bottom: 25px;
    text-align: center;
}

.picker-search {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    margin-bottom: 25px;
}

.picker-search svg {
    stroke: rgba(255, 255, 255, 0.4);
    flex-shrink: 0;
}

.picker-search input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 1rem;
}

.picker-search input:focus {
    outline: none;
}

.picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 18px;
    max-height: 450px;
    overflow-y: auto;
}

.picker-item {
    position: relative;
    aspect-ratio: 4/3;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.picker-item:hover {
    border-color: #b5600b;
    transform: scale(1.03);
}

.picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.picker-item span {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 6px;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    font-size: 0.75rem;
    text-align: center;
}

.animated-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(181, 96, 11, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.no-animated {
    grid-column: 1 / -1;
    text-align: center;
    padding: 50px;
    color: rgba(255, 255, 255, 0.5);
}

/* View Image Modal */
.view-image-content {
    max-width: 90vw;
    max-height: 90vh;
    padding: 0;
    background: transparent;
    border: none;
    box-shadow: none;
}

.view-image-container {
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-image-container img,
.view-image-container video {
    max-width: 100%;
    max-height: 85vh;
    border-radius: 12px;
    box-shadow: 0 20px 80px rgba(0, 0, 0, 0.5);
}

/* View Message Modal */
.view-message-content {
    max-width: 600px;
    padding: 35px;
}

.message-postcard-wrapper {
    perspective: 1200px;
    margin-bottom: 20px;
}

.message-postcard {
    position: relative;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
}

.message-postcard-bg {
    width: 100%;
    height: auto;
    display: block;
}

.message-text-area {
    position: absolute;
    left: 4%;
    top: 42%;
    width: 48%;
    height: 45%;
    padding: 12px;
    overflow: hidden;
}

.message-text-area p {
    font-family: 'Dancing Script', cursive, Georgia, serif;
    font-size: 14px;
    color: #4a3728;
    line-height: 1.5;
    margin: 0;
}

.message-stamp-area {
    position: absolute;
    right: 10%;
    top: 5%;
    width: 60px;
}

.message-stamp-area img {
    width: 100%;
    height: auto;
    filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.25));
}

.message-signature-area {
    position: absolute;
    right: 8%;
    top: 50%;
    width: 35%;
    text-align: center;
}

.message-signature-area img {
    max-width: 100%;
    max-height: 60px;
    margin-bottom: 8px;
}

.signature-name {
    font-family: 'Dancing Script', cursive, Georgia, serif;
    font-size: 14px;
    color: #4a3728;
    margin: 0;
}

.message-meta {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
}

/* Signature Required Modal */
.signature-required-content {
    max-width: 420px;
    padding: 45px;
    text-align: center;
}

.signature-required-icon {
    width: 100px;
    height: 100px;
    margin: 0 auto 25px;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.15), rgba(181, 96, 11, 0.05));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(181, 96, 11, 0.3);
}

.signature-required-icon svg {
    stroke: #d1872c;
}

.signature-required-content h3 {
    color: white;
    font-size: 1.4rem;
    margin-bottom: 15px;
}

.signature-required-content p {
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.6;
    margin-bottom: 30px;
}

.signature-required-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.btn-cancel {
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    color: white;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.btn-cancel:hover {
    background: rgba(255, 255, 255, 0.15);
}

.btn-create {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 25px;
    color: white;
    text-decoration: none;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

/* Notifications */
.notification {
    position: fixed;
    top: 85px;
    right: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 28px;
    border-radius: 12px;
    color: white;
    z-index: 6000;
    animation: slideIn 0.4s ease;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.notification-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.notification-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

@keyframes slideIn {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Animations */
.animate-fade-in-down { animation: fadeInDown 0.7s ease forwards; }
.animate-fade-in-up { animation: fadeInUp 0.7s ease forwards; }
.animate-fade-in { animation: fadeIn 0.7s ease forwards; }
[class*="animate-"] { opacity: 0; }
.delay-1 { animation-delay: 0.15s; }
.delay-2 { animation-delay: 0.3s; }

@keyframes fadeInDown { from { opacity: 0; transform: translateY(-25px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 768px) {
    .poste-header h1 {
        font-size: 2rem;
    }
    
    .poste-tabs {
        flex-direction: column;
        align-items: stretch;
    }
    
    .postcards-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10px;
        padding: 25px 20px;
    }
    
    .compose-content {
        padding: 25px 20px;
    }
    
    .picker-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .stamp-selection .stamps-row {
        flex-direction: column;
        gap: 15px;
    }
    
    .step-buttons {
        flex-direction: column;
    }
    
    .btn-next {
        margin-left: 0;
    }
    
    .signature-warning {
        flex-direction: column;
        text-align: center;
    }
}

/* Scrollbar for modals */
.modal-content::-webkit-scrollbar {
    width: 8px;
}

.modal-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
    background: rgba(181, 96, 11, 0.5);
    border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: rgba(181, 96, 11, 0.7);
}
</style>
{% endblock %}