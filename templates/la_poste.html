<!-- templates/la_poste.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}La Poste{% endblock %}

{% block content %}
<div class="la-poste-page">
    <!-- Elegant Background -->
    <div class="poste-background">
        <div class="bg-gradient"></div>
        <div class="dust-particles" id="dust-particles"></div>
        <div class="floating-icons" id="floating-icons"></div>
    </div>

    <div class="poste-container">
        <!-- Header -->
        <header class="poste-header animate-fade-in-down">
            <div class="header-icon">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/>
                    <line x1="16" y1="8" x2="2" y2="22"/>
                    <line x1="17.5" y1="15" x2="9" y2="15"/>
                </svg>
            </div>
            <h1>La Poste</h1>
            <p class="header-subtitle">L'art de la correspondance à la Belle Époque</p>
            
            {% if unread_count > 0 %}
            <div class="unread-badge animate-pulse">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                {{ unread_count }} nouvelle{{ unread_count|pluralize }} carte{{ unread_count|pluralize }}
            </div>
            {% endif %}
        </header>

        <!-- Main Action Button -->
        <div class="poste-actions animate-fade-in-up delay-1">
            <button class="action-btn primary" onclick="openComposeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/>
                    <line x1="16" y1="8" x2="2" y2="22"/>
                </svg>
                <span>Écrire une carte postale</span>
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="poste-tabs animate-fade-in delay-2">
            <button class="tab-btn active" data-tab="received" onclick="switchTab('received')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                    <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                </svg>
                Reçues
                {% if unread_count > 0 %}
                <span class="tab-badge">{{ unread_count }}</span>
                {% endif %}
            </button>
            <button class="tab-btn" data-tab="sent" onclick="switchTab('sent')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Envoyées
            </button>
            <button class="tab-btn" data-tab="wall" onclick="switchTab('wall')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                Mur Public
            </button>
        </div>

        <!-- Content Sections -->
        <div class="poste-content">
            <!-- Received Tab -->
            <div class="tab-content active" id="received-tab">
                <div class="postcards-grid" id="received-grid">
                    {% for postcard in received_postcards %}
                    <div class="postcard-envelope {% if not postcard.is_read %}unread{% endif %}" 
                         data-id="{{ postcard.id }}"
                         data-sender="{{ postcard.sender.username }}"
                         data-message="{{ postcard.message|escapejs }}"
                         data-date="{{ postcard.created_at|date:'d/m/Y H:i' }}"
                         data-signature="{{ postcard.sender.signature_image.url|default:'' }}"
                         data-image="{{ postcard.get_image_url|default:'' }}">
                        
                        <div class="envelope-front">
                            {% if postcard.get_image_url %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale" class="envelope-image">
                            {% else %}
                            <div class="envelope-placeholder">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </div>
                            {% endif %}
                            
                            {% if not postcard.is_read %}
                            <div class="new-seal">
                                <span>Nouveau</span>
                            </div>
                            {% endif %}
                            
                            <!-- View Message Button -->
                            <button class="view-message-btn" onclick="openPostcardView(this.parentElement.parentElement)" title="Lire le message">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="envelope-info">
                            <div class="sender-badge">
                                <div class="sender-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <span>{{ postcard.sender.username }}</span>
                            </div>
                            <span class="envelope-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                            </svg>
                        </div>
                        <h3>Votre boîte aux lettres est vide</h3>
                        <p>Invitez vos amis à vous envoyer des cartes postales!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sent Tab -->
            <div class="tab-content" id="sent-tab">
                <div class="postcards-grid" id="sent-grid">
                    {% for postcard in sent_postcards %}
                    <div class="postcard-envelope sent-card" 
                         data-id="{{ postcard.id }}"
                         data-recipient="{{ postcard.recipient.username|default:'Public' }}"
                         data-message="{{ postcard.message|escapejs }}"
                         data-date="{{ postcard.created_at|date:'d/m/Y H:i' }}"
                         data-signature="{{ user.signature_image.url|default:'' }}"
                         data-image="{{ postcard.get_image_url|default:'' }}"
                         data-visibility="{{ postcard.visibility }}">
                        
                        <div class="envelope-front">
                            {% if postcard.get_image_url %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale" class="envelope-image">
                            {% else %}
                            <div class="envelope-placeholder">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </div>
                            {% endif %}
                            
                            {% if postcard.visibility == 'public' %}
                            <div class="public-seal">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            {% endif %}
                            
                            <button class="view-message-btn" onclick="openPostcardView(this.parentElement.parentElement)" title="Voir le message">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="envelope-info">
                            <div class="recipient-badge">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                                <span>{% if postcard.recipient %}À {{ postcard.recipient.username }}{% else %}Publication publique{% endif %}</span>
                            </div>
                            <span class="envelope-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </div>
                        <h3>Aucune carte envoyée</h3>
                        <p>Partagez vos découvertes avec vos amis!</p>
                        <button class="btn-primary-small" onclick="openComposeModal()">Écrire ma première carte</button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Public Wall Tab -->
            <div class="tab-content" id="wall-tab">
                <div class="wall-feed" id="wall-feed">
                    {% for postcard in public_postcards %}
                    <div class="wall-card" 
                         data-id="{{ postcard.id }}"
                         data-sender="{{ postcard.sender.username }}"
                         data-message="{{ postcard.message|escapejs }}"
                         data-date="{{ postcard.created_at|date:'d/m/Y H:i' }}"
                         data-signature="{{ postcard.sender.signature_image.url|default:'' }}"
                         data-image="{{ postcard.get_image_url|default:'' }}">
                        
                        <div class="wall-card-header">
                            <div class="wall-author">
                                <div class="author-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <div class="author-info">
                                    <span class="author-name">{{ postcard.sender.username }}</span>
                                    <span class="post-time">{{ postcard.created_at|date:"d/m/Y à H:i" }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="wall-card-image" onclick="openPostcardView(this.parentElement)">
                            {% if postcard.get_image_url %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale">
                            {% endif %}
                            <div class="image-overlay">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                                <span>Lire le message</span>
                            </div>
                        </div>
                        
                        <div class="wall-card-actions">
                            <button class="wall-action-btn" onclick="toggleComments({{ postcard.id }})">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <span>{{ postcard.comments.count }} commentaire{{ postcard.comments.count|pluralize }}</span>
                            </button>
                        </div>
                        
                        <div class="wall-comments" id="comments-{{ postcard.id }}" style="display: none;">
                            <div class="comments-list">
                                {% for comment in postcard.comments.all %}
                                <div class="comment-item">
                                    <span class="comment-author">{{ comment.user.username }}</span>
                                    <p class="comment-text">{{ comment.message }}</p>
                                    <span class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                {% empty %}
                                <p class="no-comments">Aucun commentaire pour le moment.</p>
                                {% endfor %}
                            </div>
                            <form class="comment-form" onsubmit="addComment(event, {{ postcard.id }})">
                                <input type="text" placeholder="Écrire un commentaire..." maxlength="500" required>
                                <button type="submit">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"/>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                        </div>
                        <h3>Le mur est vide</h3>
                        <p>Soyez le premier à partager une carte!</p>
                        <button class="btn-primary-small" onclick="openComposeModal()">Publier une carte</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- POSTCARD VIEW MODAL (Like Contact Page)     -->
<!-- ============================================ -->
<div class="postcard-view-modal" id="postcardViewModal">
    <div class="modal-backdrop" onclick="closePostcardView()"></div>
    <div class="postcard-view-container">
        <button class="modal-close-btn" onclick="closePostcardView()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <!-- The Postcard -->
        <div class="vintage-postcard" id="viewPostcard">
            <img src="{% static 'images/Cpa_Vierge.jpg' %}" alt="Carte Postale" class="postcard-template">
            
            <!-- Left Side: Message -->
            <div class="postcard-message-area">
                <p class="postcard-message-text" id="viewMessageText"></p>
            </div>
            
            <!-- Right Side: Stamp & Recipient -->
            <div class="postcard-stamp-area">
                <img src="" alt="Timbre" class="postcard-stamp" id="viewStamp">
            </div>
            
            <div class="postcard-recipient-area">
                <img src="" alt="Signature" class="postcard-signature" id="viewSignature">
                <div class="postcard-sender-info">
                    <span class="sender-label">De:</span>
                    <span class="sender-name" id="viewSenderName"></span>
                </div>
            </div>
            
            <!-- Date -->
            <div class="postcard-date-area">
                <span id="viewDate"></span>
            </div>
        </div>
        
        <!-- Postcard Image Preview (if any) -->
        <div class="postcard-image-preview" id="postcardImagePreview">
            <img src="" alt="Image de la carte" id="viewPostcardImage">
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- COMPOSE MODAL                                -->
<!-- ============================================ -->
<div class="compose-modal" id="composeModal">
    <div class="modal-backdrop" onclick="closeComposeModal()"></div>
    <div class="compose-container">
        <button class="modal-close-btn" onclick="closeComposeModal()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <div class="compose-header">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/>
                <line x1="16" y1="8" x2="2" y2="22"/>
            </svg>
            <h2>Écrire une carte postale</h2>
        </div>
        
        <!-- Step 1: Choose visibility and recipient -->
        <div class="compose-step" id="composeStep1">
            <div class="visibility-selector">
                <button type="button" class="visibility-option active" data-visibility="private" onclick="setVisibility('private')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Message Privé</span>
                    <small>Envoyer à un ami</small>
                </button>
                <button type="button" class="visibility-option" data-visibility="public" onclick="setVisibility('public')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span>Publication Publique</span>
                    <small>Visible par tous</small>
                </button>
            </div>
            
            <div class="recipient-section" id="recipientSection">
                <label>Destinataire</label>
                <div class="recipient-input-container">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <input type="text" id="recipientInput" placeholder="Nom d'utilisateur..." autocomplete="off">
                    <div class="recipient-suggestions" id="recipientSuggestions"></div>
                </div>
            </div>
            
            <button class="step-next-btn" onclick="goToStep(2)">
                Continuer
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12 5 19 12 12 19"/>
                </svg>
            </button>
        </div>
        
        <!-- Step 2: Choose postcard image -->
        <div class="compose-step" id="composeStep2" style="display: none;">
            <div class="step-header">
                <button class="step-back-btn" onclick="goToStep(1)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Retour
                </button>
                <span>Choisir une carte</span>
            </div>
            
            <div class="card-type-tabs">
                <button class="card-type-tab active" onclick="switchCardType('static')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Cartes Postales
                </button>
                <button class="card-type-tab" onclick="switchCardType('animated')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    CP Animées
                </button>
            </div>
            
            <div class="card-search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" id="cardSearchInput" placeholder="Rechercher par numéro ou titre..." oninput="filterCards(this.value)">
            </div>
            
            <div class="cards-grid" id="cardsGrid">
                {% for postcard in available_postcards %}
                <div class="card-option" 
                     data-id="{{ postcard.id }}"
                     data-type="static"
                     data-title="{{ postcard.title|lower }}"
                     data-number="{{ postcard.number }}"
                     onclick="selectCard({{ postcard.id }}, '{{ postcard.get_vignette_url }}', '{{ postcard.title|escapejs }}', false)">
                    {% if postcard.get_vignette_url %}
                    <img src="{{ postcard.get_vignette_url }}" alt="{{ postcard.title }}">
                    {% else %}
                    <div class="card-placeholder">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        </svg>
                    </div>
                    {% endif %}
                    <span class="card-number">N° {{ postcard.number }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div class="selected-card-preview" id="selectedCardPreview" style="display: none;">
                <img src="" id="selectedCardImage" alt="Carte sélectionnée">
                <div class="preview-info">
                    <span id="selectedCardTitle"></span>
                    <button class="change-card-btn" onclick="clearCardSelection()">Changer</button>
                </div>
            </div>
            
            <button class="step-next-btn" onclick="goToStep(3)" id="step2NextBtn" disabled>
                Continuer
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12 5 19 12 12 19"/>
                </svg>
            </button>
        </div>
        
        <!-- Step 3: Write message (Like Contact Page) -->
        <div class="compose-step" id="composeStep3" style="display: none;">
            <div class="step-header">
                <button class="step-back-btn" onclick="goToStep(2)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Retour
                </button>
                <span>Écrire votre message</span>
            </div>
            
            <!-- Vintage Postcard Style Message Area -->
            <div class="compose-postcard-wrapper">
                <div class="compose-postcard">
                    <img src="{% static 'images/Cpa_Vierge.jpg' %}" alt="Carte Postale" class="compose-postcard-bg">
                    
                    <!-- Message Area (Left) -->
                    <textarea 
                        id="composeMessageInput"
                        class="compose-message-input"
                        placeholder="Écrivez votre message ici..."
                        maxlength="55"
                        oninput="updateCharCount()"></textarea>
                    
                    <!-- Stamp Area (Top Right) -->
                    <div class="compose-stamp-area">
                        <div class="stamp-placeholder" id="composeStampPlaceholder">
                            <span>Timbre</span>
                        </div>
                        <img src="" alt="Timbre" class="compose-stamp" id="composeStampImage">
                    </div>
                    
                    <!-- Signature Area (Right) -->
                    <div class="compose-signature-area">
                        <img src="" alt="Signature" class="compose-signature" id="composeSignatureImage">
                        <div class="signature-placeholder" id="composeSignaturePlaceholder">
                            <span>Signez ici</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Character count -->
            <div class="compose-char-info">
                <span id="charCountDisplay">0</span> / <span id="charLimitDisplay">55</span> caractères
            </div>
            
            <!-- Instructions -->
            <p class="compose-instructions">
                Affranchissez au tarif en vigueur et signez votre carte
            </p>
            
            <!-- Stamps and Signature Selection -->
            <div class="compose-elements">
                <div class="stamps-selection">
                    <span class="selection-label">Timbres:</span>
                    <div class="stamps-row">
                        <div class="stamp-choice" data-value="5c" data-limit="44" onclick="selectStamp(this, '{% static 'images/Timbre_5c.png' %}', 44)">
                            <img src="{% static 'images/Timbre_5c.png' %}" alt="5 centimes">
                            <span>5c (44 car.)</span>
                        </div>
                        <div class="stamp-choice" data-value="10c" data-limit="55" onclick="selectStamp(this, '{% static 'images/Timbre_10c.png' %}', 55)">
                            <img src="{% static 'images/Timbre_10c.png' %}" alt="10 centimes">
                            <span>10c (55 car.)</span>
                        </div>
                    </div>
                </div>
                
                <div class="signature-selection">
                    <span class="selection-label">Signature:</span>
                    {% if user.signature_image %}
                    <div class="user-signature-preview" onclick="applyUserSignature('{{ user.signature_image.url }}')">
                        <img src="{{ user.signature_image.url }}" alt="Ma signature">
                        <span>Ma signature</span>
                    </div>
                    {% else %}
                    <div class="no-signature-msg">
                        <a href="{% url 'profile' %}">Ajouter une signature</a>
                    </div>
                    {% endif %}
                    
                    <!-- Default signature option -->
                    <div class="default-signature-option" onclick="applyUserSignature('{% static 'images/Samathey.png' %}')">
                        <img src="{% static 'images/Samathey_blanc.png' %}" alt="Signature par défaut">
                        <span>Signature classique</span>
                    </div>
                </div>
            </div>
            
            <!-- Send Button -->
            <button class="send-postcard-btn" id="sendPostcardBtn" onclick="sendPostcard()" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Poster la carte
            </button>
        </div>
    </div>
</div>

<!-- Success Notification -->
<div class="success-notification" id="successNotification">
    <div class="success-content">
        <div class="success-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <h3>Carte envoyée!</h3>
        <p id="successMessage">Votre carte postale a été envoyée avec succès.</p>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let currentVisibility = 'private';
let selectedPostcardId = null;
let selectedPostcardUrl = '';
let selectedStampUrl = '';
let selectedSignatureUrl = '';
let currentCharLimit = 55;
let stampApplied = false;
let signatureApplied = false;

// ============================================
// BACKGROUND ANIMATIONS
// ============================================

function createDustParticles() {
    const container = document.getElementById('dust-particles');
    if (!container) return;
    
    for (let i = 0; i < 60; i++) {
        const dust = document.createElement('div');
        dust.className = 'dust-particle';
        dust.style.left = Math.random() * 100 + '%';
        dust.style.top = Math.random() * 100 + '%';
        dust.style.animationDelay = Math.random() * 15 + 's';
        dust.style.animationDuration = (15 + Math.random() * 20) + 's';
        dust.style.opacity = 0.2 + Math.random() * 0.4;
        dust.style.width = (2 + Math.random() * 3) + 'px';
        dust.style.height = dust.style.width;
        container.appendChild(dust);
    }
}

function createFloatingIcons() {
    const container = document.getElementById('floating-icons');
    if (!container) return;
    
    const icons = [
        // Quill/Feather
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/></svg>',
        // Envelope
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
        // Stamp
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/><rect x="6" y="6" width="12" height="12" rx="1"/></svg>',
        // Ink bottle
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M8 2h8v4H8zM6 6h12v4l-2 2v8a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-8l-2-2V6z"/></svg>',
        // Postcard
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="14" y1="8" x2="20" y2="8"/><line x1="14" y1="12" x2="20" y2="12"/></svg>',
        // Seal/Wax
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="12" cy="12" r="8"/><path d="M12 4v2M12 18v2M4 12h2M18 12h2"/></svg>',
    ];
    
    for (let i = 0; i < 12; i++) {
        const iconWrapper = document.createElement('div');
        iconWrapper.className = 'floating-icon';
        iconWrapper.innerHTML = icons[Math.floor(Math.random() * icons.length)];
        iconWrapper.style.left = Math.random() * 100 + '%';
        iconWrapper.style.top = Math.random() * 100 + '%';
        iconWrapper.style.animationDelay = Math.random() * 20 + 's';
        iconWrapper.style.animationDuration = (20 + Math.random() * 15) + 's';
        container.appendChild(iconWrapper);
    }
}

// ============================================
// TAB NAVIGATION
// ============================================

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tab + '-tab').classList.add('active');
}

// ============================================
// POSTCARD VIEW MODAL
// ============================================

function openPostcardView(element) {
    const data = element.dataset;
    
    // Mark as read if received
    if (element.classList.contains('unread')) {
        markAsRead(data.id);
        element.classList.remove('unread');
    }
    
    const modal = document.getElementById('postcardViewModal');
    
    // Set message
    document.getElementById('viewMessageText').textContent = data.message || '';
    
    // Set sender info
    document.getElementById('viewSenderName').textContent = data.sender || data.recipient || '';
    
    // Set date
    document.getElementById('viewDate').textContent = data.date || '';
    
    // Set signature if available
    const signatureImg = document.getElementById('viewSignature');
    if (data.signature) {
        signatureImg.src = data.signature;
        signatureImg.style.display = 'block';
    } else {
        signatureImg.style.display = 'none';
    }
    
    // Set stamp (default to 10c)
    document.getElementById('viewStamp').src = '{% static "images/Timbre_10c.png" %}';
    
    // Set postcard image if available
    const imagePreview = document.getElementById('postcardImagePreview');
    const postcardImage = document.getElementById('viewPostcardImage');
    if (data.image) {
        postcardImage.src = data.image;
        imagePreview.style.display = 'block';
    } else {
        imagePreview.style.display = 'none';
    }
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closePostcardView() {
    document.getElementById('postcardViewModal').classList.remove('active');
    document.body.style.overflow = '';
}

async function markAsRead(postcardId) {
    try {
        await fetch(`/api/la-poste/${postcardId}/read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
    } catch (error) {
        console.error('Error marking as read:', error);
    }
}

// ============================================
// COMPOSE MODAL
// ============================================

function openComposeModal() {
    document.getElementById('composeModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    resetComposeForm();
}

function closeComposeModal() {
    document.getElementById('composeModal').classList.remove('active');
    document.body.style.overflow = '';
}

function resetComposeForm() {
    // Reset to step 1
    goToStep(1);
    
    // Reset visibility
    setVisibility('private');
    
    // Reset recipient
    document.getElementById('recipientInput').value = '';
    document.getElementById('recipientSuggestions').innerHTML = '';
    
    // Reset card selection
    clearCardSelection();
    
    // Reset message
    document.getElementById('composeMessageInput').value = '';
    updateCharCount();
    
    // Reset stamp and signature
    stampApplied = false;
    signatureApplied = false;
    selectedStampUrl = '';
    selectedSignatureUrl = '';
    
    document.getElementById('composeStampImage').style.display = 'none';
    document.getElementById('composeStampPlaceholder').style.display = 'flex';
    document.getElementById('composeSignatureImage').style.display = 'none';
    document.getElementById('composeSignaturePlaceholder').style.display = 'flex';
    
    document.querySelectorAll('.stamp-choice').forEach(s => s.classList.remove('selected'));
    
    currentCharLimit = 55;
    document.getElementById('charLimitDisplay').textContent = '55';
    document.getElementById('composeMessageInput').maxLength = 55;
    
    updateSendButton();
}

function goToStep(step) {
    document.querySelectorAll('.compose-step').forEach(s => s.style.display = 'none');
    document.getElementById('composeStep' + step).style.display = 'block';
}

function setVisibility(vis) {
    currentVisibility = vis;
    document.querySelectorAll('.visibility-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.visibility === vis);
    });
    document.getElementById('recipientSection').style.display = vis === 'private' ? 'block' : 'none';
}

// Recipient search
let searchTimeout;
document.getElementById('recipientInput')?.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        document.getElementById('recipientSuggestions').innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/users/search/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            const suggestions = document.getElementById('recipientSuggestions');
            suggestions.innerHTML = data.users.map(u => `
                <div class="suggestion-item" onclick="selectRecipient('${u.username}')">
                    <span class="suggestion-name">${u.username}</span>
                    <span class="suggestion-category">${u.category}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
});

function selectRecipient(username) {
    document.getElementById('recipientInput').value = username;
    document.getElementById('recipientSuggestions').innerHTML = '';
}

// Card type switching
function switchCardType(type) {
    document.querySelectorAll('.card-type-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.toLowerCase().includes(type === 'animated' ? 'animées' : 'postales'));
    });
    
    document.querySelectorAll('.card-option').forEach(card => {
        const cardType = card.dataset.type || 'static';
        card.style.display = (type === 'all' || cardType === type) ? '' : 'none';
    });
}

function filterCards(query) {
    query = query.toLowerCase();
    document.querySelectorAll('.card-option').forEach(card => {
        const title = card.dataset.title || '';
        const number = card.dataset.number || '';
        const matches = title.includes(query) || number.includes(query);
        card.style.display = matches ? '' : 'none';
    });
}

function selectCard(id, url, title, isAnimated) {
    selectedPostcardId = id;
    selectedPostcardUrl = url;
    
    // Hide grid, show preview
    document.getElementById('cardsGrid').style.display = 'none';
    document.querySelector('.card-search').style.display = 'none';
    document.querySelector('.card-type-tabs').style.display = 'none';
    
    const preview = document.getElementById('selectedCardPreview');
    document.getElementById('selectedCardImage').src = url;
    document.getElementById('selectedCardTitle').textContent = title;
    preview.style.display = 'flex';
    
    document.getElementById('step2NextBtn').disabled = false;
}

function clearCardSelection() {
    selectedPostcardId = null;
    selectedPostcardUrl = '';
    
    document.getElementById('cardsGrid').style.display = 'grid';
    document.querySelector('.card-search').style.display = 'flex';
    document.querySelector('.card-type-tabs').style.display = 'flex';
    document.getElementById('selectedCardPreview').style.display = 'none';
    document.getElementById('step2NextBtn').disabled = true;
}

// Stamp selection
function selectStamp(element, stampUrl, charLimit) {
    document.querySelectorAll('.stamp-choice').forEach(s => s.classList.remove('selected'));
    element.classList.add('selected');
    
    selectedStampUrl = stampUrl;
    currentCharLimit = charLimit;
    stampApplied = true;
    
    // Update UI
    document.getElementById('composeStampImage').src = stampUrl;
    document.getElementById('composeStampImage').style.display = 'block';
    document.getElementById('composeStampPlaceholder').style.display = 'none';
    
    // Update char limit
    document.getElementById('charLimitDisplay').textContent = charLimit;
    document.getElementById('composeMessageInput').maxLength = charLimit;
    
    // Trim message if needed
    const input = document.getElementById('composeMessageInput');
    if (input.value.length > charLimit) {
        input.value = input.value.substring(0, charLimit);
    }
    updateCharCount();
    updateSendButton();
}

function applyUserSignature(signatureUrl) {
    selectedSignatureUrl = signatureUrl;
    signatureApplied = true;
    
    document.getElementById('composeSignatureImage').src = signatureUrl;
    document.getElementById('composeSignatureImage').style.display = 'block';
    document.getElementById('composeSignaturePlaceholder').style.display = 'none';
    
    updateSendButton();
}

function updateCharCount() {
    const input = document.getElementById('composeMessageInput');
    document.getElementById('charCountDisplay').textContent = input.value.length;
    updateSendButton();
}

function updateSendButton() {
    const message = document.getElementById('composeMessageInput').value.trim();
    const canSend = stampApplied && signatureApplied && message.length >= 5;
    document.getElementById('sendPostcardBtn').disabled = !canSend;
}

// Send postcard
async function sendPostcard() {
    const message = document.getElementById('composeMessageInput').value.trim();
    const recipient = document.getElementById('recipientInput').value.trim();
    
    if (currentVisibility === 'private' && !recipient) {
        showNotification('Veuillez entrer un destinataire', 'error');
        return;
    }
    
    if (!stampApplied) {
        showNotification('Veuillez choisir un timbre', 'error');
        return;
    }
    
    if (!signatureApplied) {
        showNotification('Veuillez signer votre carte', 'error');
        return;
    }
    
    if (message.length < 5) {
        showNotification('Le message est trop court', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/la-poste/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                message,
                recipient: currentVisibility === 'private' ? recipient : null,
                visibility: currentVisibility,
                postcard_id: selectedPostcardId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            closeComposeModal();
            showSuccessNotification(data.message || 'Carte envoyée avec succès!');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification(data.error || 'Erreur lors de l\'envoi', 'error');
        }
    } catch (error) {
        showNotification('Erreur lors de l\'envoi', 'error');
    }
}

// Comments
function toggleComments(postcardId) {
    const comments = document.getElementById('comments-' + postcardId);
    comments.style.display = comments.style.display === 'none' ? 'block' : 'none';
}

async function addComment(event, postcardId) {
    event.preventDefault();
    const input = event.target.querySelector('input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        const response = await fetch(`/api/la-poste/${postcardId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const list = document.querySelector(`#comments-${postcardId} .comments-list`);
            const noComments = list.querySelector('.no-comments');
            if (noComments) noComments.remove();
            
            list.innerHTML += `
                <div class="comment-item">
                    <span class="comment-author">${data.comment.user}</span>
                    <p class="comment-text">${data.comment.message}</p>
                    <span class="comment-date">${data.comment.created_at}</span>
                </div>
            `;
            input.value = '';
        }
    } catch (error) {
        console.error('Comment error:', error);
    }
}

// Notifications
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `toast-notification toast-${type}`;
    notification.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'error' 
                ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>' 
                : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'}
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showSuccessNotification(message) {
    const notification = document.getElementById('successNotification');
    document.getElementById('successMessage').textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Keyboard handlers
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeComposeModal();
        closePostcardView();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    createDustParticles();
    createFloatingIcons();
});
</script>

<style>
/* ============================================
   LA POSTE PAGE - ELEGANT REDESIGN
   ============================================ */

.la-poste-page {
    min-height: 100vh;
    position: relative;
    padding: 80px 20px 60px;
}

/* Background */
.poste-background {
    position: fixed;
    inset: 0;
    background: linear-gradient(165deg, #1a1510 0%, #2a201a 40%, #1a1510 100%);
    z-index: 0;
    overflow: hidden;
}

.bg-gradient {
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(ellipse at 20% 20%, rgba(181, 96, 11, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139, 90, 43, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(209, 135, 44, 0.03) 0%, transparent 60%);
}

/* Dust Particles */
.dust-particle {
    position: absolute;
    background: radial-gradient(circle, rgba(255, 240, 220, 0.8) 0%, rgba(209, 135, 44, 0.3) 50%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
    animation: dustFloat linear infinite;
}

@keyframes dustFloat {
    0% {
        transform: translate(0, 0) scale(1);
        opacity: 0;
    }
    10% {
        opacity: 0.4;
    }
    50% {
        transform: translate(30px, -50px) scale(1.2);
    }
    90% {
        opacity: 0.4;
    }
    100% {
        transform: translate(60px, -100px) scale(0.8);
        opacity: 0;
    }
}

/* Floating Icons */
.floating-icon {
    position: absolute;
    width: 40px;
    height: 40px;
    opacity: 0.08;
    pointer-events: none;
    animation: iconFloat ease-in-out infinite;
    color: rgba(181, 96, 11, 0.6);
}

.floating-icon svg {
    width: 100%;
    height: 100%;
}

@keyframes iconFloat {
    0%, 100% {
        transform: translateY(0) rotate(0deg);
        opacity: 0.05;
    }
    25% {
        transform: translateY(-20px) rotate(5deg);
        opacity: 0.1;
    }
    50% {
        transform: translateY(-10px) rotate(-3deg);
        opacity: 0.08;
    }
    75% {
        transform: translateY(-25px) rotate(3deg);
        opacity: 0.1;
    }
}

/* Container */
.poste-container {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
}

/* Header */
.poste-header {
    text-align: center;
    margin-bottom: 45px;
}

.header-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 90px;
    height: 90px;
    background: linear-gradient(145deg, rgba(181, 96, 11, 0.15), rgba(139, 90, 43, 0.1));
    border-radius: 50%;
    margin-bottom: 25px;
    border: 2px solid rgba(181, 96, 11, 0.25);
    box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

.header-icon svg {
    stroke: #d1872c;
}

.poste-header h1 {
    font-size: 2.8rem;
    color: #fff;
    margin-bottom: 12px;
    letter-spacing: 2px;
    text-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5);
}

.header-subtitle {
    color: rgba(209, 135, 44, 0.8);
    font-size: 1.1rem;
    font-style: italic;
    letter-spacing: 1px;
}

.unread-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    padding: 12px 25px;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1));
    border: 1px solid rgba(74, 222, 128, 0.35);
    border-radius: 30px;
    color: #4ade80;
    font-size: 0.95rem;
    font-weight: 500;
}

.animate-pulse {
    animation: badgePulse 2s ease-in-out infinite;
}

@keyframes badgePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.3); }
    50% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
}

/* Actions */
.poste-actions {
    display: flex;
    justify-content: center;
    margin-bottom: 35px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 40px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-size: 1.15rem;
    font-weight: 600;
    transition: all 0.4s ease;
    font-family: inherit;
}

.action-btn.primary {
    background: linear-gradient(135deg, #b5600b 0%, #d1872c 50%, #b5600b 100%);
    background-size: 200% 100%;
    color: white;
    box-shadow: 
        0 8px 30px rgba(181, 96, 11, 0.4),
        0 2px 10px rgba(0, 0, 0, 0.2);
}

.action-btn.primary:hover {
    background-position: 100% 0;
    transform: translateY(-4px);
    box-shadow: 
        0 15px 45px rgba(181, 96, 11, 0.5),
        0 5px 20px rgba(0, 0, 0, 0.3);
}

/* Tabs */
.poste-tabs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 35px;
    flex-wrap: wrap;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 30px;
    color: rgba(255, 255, 255, 0.65);
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    font-size: 0.95rem;
    position: relative;
}

.tab-btn svg {
    stroke: rgba(255, 255, 255, 0.4);
    transition: stroke 0.3s;
}

.tab-btn:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.3);
    color: rgba(255, 255, 255, 0.9);
}

.tab-btn:hover svg {
    stroke: rgba(209, 135, 44, 0.8);
}

.tab-btn.active {
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.25), rgba(139, 90, 43, 0.2));
    border-color: rgba(181, 96, 11, 0.5);
    color: white;
}

.tab-btn.active svg {
    stroke: #ffc168;
}

.tab-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 22px;
    height: 22px;
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border-radius: 11px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1a1510;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);
}

/* Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Postcards Grid */
.postcards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
}

/* Envelope Card Style */
.postcard-envelope {
    position: relative;
    background: linear-gradient(155deg, rgba(50, 40, 35, 0.95), rgba(35, 28, 24, 0.98));
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(181, 96, 11, 0.15);
    transition: all 0.4s ease;
    cursor: default;
}

.postcard-envelope:hover {
    transform: translateY(-6px);
    border-color: rgba(181, 96, 11, 0.4);
    box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(181, 96, 11, 0.2);
}

.postcard-envelope.unread {
    border-color: rgba(74, 222, 128, 0.3);
}

.postcard-envelope.unread::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.05), transparent);
    pointer-events: none;
    z-index: 1;
}

.envelope-front {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    background: linear-gradient(135deg, #2a2420, #1a1510);
}

.envelope-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.postcard-envelope:hover .envelope-image {
    transform: scale(1.05);
}

.envelope-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(145deg, rgba(181, 96, 11, 0.08), rgba(139, 90, 43, 0.05));
}

.envelope-placeholder svg {
    stroke: rgba(181, 96, 11, 0.25);
}

/* New Seal */
.new-seal {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 6px 14px;
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    color: #1a1510;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 3px 12px rgba(74, 222, 128, 0.4);
    z-index: 5;
}

.public-seal {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    background: rgba(181, 96, 11, 0.85);
    border-radius: 15px;
    color: white;
    font-size: 0.7rem;
    z-index: 5;
}

/* View Message Button */
.view-message-btn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.9), rgba(139, 90, 43, 0.9));
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s ease;
    z-index: 5;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
}

.postcard-envelope:hover .view-message-btn {
    opacity: 1;
    transform: scale(1);
}

.view-message-btn:hover {
    background: linear-gradient(135deg, #d1872c, #b5600b);
    transform: scale(1.1) !important;
}

/* Envelope Info */
.envelope-info {
    padding: 16px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
}

.sender-badge, .recipient-badge {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sender-avatar, .author-avatar {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: white;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(181, 96, 11, 0.3);
}

.sender-avatar img, .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.sender-badge span, .recipient-badge span {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    font-size: 0.9rem;
}

.recipient-badge svg {
    stroke: #b5600b;
}

.envelope-date {
    color: rgba(255, 255, 255, 0.45);
    font-size: 0.8rem;
}

/* Wall Feed */
.wall-feed {
    max-width: 650px;
    margin: 0 auto;
}

.wall-card {
    background: linear-gradient(165deg, rgba(50, 40, 35, 0.95), rgba(35, 28, 24, 0.98));
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    transition: all 0.3s ease;
}

.wall-card:hover {
    border-color: rgba(181, 96, 11, 0.25);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
}

.wall-card-header {
    padding: 18px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

.wall-author {
    display: flex;
    align-items: center;
    gap: 14px;
}

.author-info {
    display: flex;
    flex-direction: column;
}

.author-name {
    color: white;
    font-weight: 600;
    font-size: 1rem;
}

.post-time {
    color: rgba(255, 255, 255, 0.45);
    font-size: 0.8rem;
    margin-top: 2px;
}

.wall-card-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    cursor: pointer;
}

.wall-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.wall-card-image:hover img {
    transform: scale(1.03);
}

.image-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.3s;
    color: white;
}

.wall-card-image:hover .image-overlay {
    opacity: 1;
}

.image-overlay span {
    font-size: 0.9rem;
}

.wall-card-actions {
    padding: 12px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.wall-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 25px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
    font-size: 0.9rem;
}

.wall-action-btn:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.3);
    color: white;
}

.wall-comments {
    padding: 18px 20px;
    background: rgba(0, 0, 0, 0.15);
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.comments-list {
    margin-bottom: 18px;
    max-height: 250px;
    overflow-y: auto;
}

.comment-item {
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-author {
    color: #d1872c;
    font-weight: 600;
    font-size: 0.9rem;
}

.comment-text {
    color: rgba(255, 255, 255, 0.85);
    margin: 6px 0;
    font-size: 0.9rem;
    line-height: 1.5;
}

.comment-date {
    color: rgba(255, 255, 255, 0.35);
    font-size: 0.75rem;
}

.no-comments {
    color: rgba(255, 255, 255, 0.4);
    font-style: italic;
    text-align: center;
    padding: 15px 0;
}

.comment-form {
    display: flex;
    gap: 12px;
}

.comment-form input {
    flex: 1;
    padding: 12px 18px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    color: white;
    font-size: 0.9rem;
    font-family: inherit;
}

.comment-form input:focus {
    outline: none;
    border-color: #b5600b;
    background: rgba(255, 255, 255, 0.08);
}

.comment-form button {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.comment-form button:hover {
    transform: scale(1.1);
}

/* Empty State */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 70px 25px;
}

.empty-icon {
    margin-bottom: 25px;
}

.empty-icon svg {
    stroke: rgba(181, 96, 11, 0.25);
}

.empty-state h3 {
    color: white;
    font-size: 1.4rem;
    margin-bottom: 12px;
}

.empty-state p {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 25px;
}

.btn-primary-small {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 30px;
    color: white;
    cursor: pointer;
    font-size: 0.95rem;
    font-family: inherit;
    transition: all 0.3s;
}

.btn-primary-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

/* ============================================
   POSTCARD VIEW MODAL
   ============================================ */

.postcard-view-modal {
    position: fixed;
    inset: 0;
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.postcard-view-modal.active {
    display: flex;
}

.postcard-view-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(10, 8, 6, 0.95);
    backdrop-filter: blur(10px);
}

.postcard-view-container {
    position: relative;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 25px;
    align-items: center;
}

.modal-close-btn {
    position: absolute;
    top: -15px;
    right: -15px;
    width: 55px;
    height: 55px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
}

.modal-close-btn:hover {
    transform: rotate(90deg) scale(1.1);
}

/* Vintage Postcard */
.vintage-postcard {
    position: relative;
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.5),
        0 0 0 4px rgba(181, 96, 11, 0.2);
}

.postcard-template {
    width: 100%;
    height: auto;
    display: block;
}

.postcard-message-area {
    position: absolute;
    left: 3%;
    top: 15%;
    width: 48%;
    height: 55%;
    padding: 15px;
    overflow: hidden;
}

.postcard-message-text {
    font-family: 'Dancing Script', cursive, Georgia, serif;
    font-size: 1.1rem;
    color: #4a3728;
    line-height: 1.6;
    margin: 0;
    word-wrap: break-word;
}

.postcard-stamp-area {
    position: absolute;
    top: 3%;
    right: 5%;
    width: 80px;
    height: 100px;
}

.postcard-stamp {
    width: 100%;
    height: auto;
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
}

.postcard-recipient-area {
    position: absolute;
    right: 5%;
    top: 35%;
    width: 40%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.postcard-signature {
    max-width: 150px;
    max-height: 60px;
    object-fit: contain;
}

.postcard-sender-info {
    text-align: center;
}

.sender-label {
    color: #8a7a6a;
    font-size: 0.8rem;
}

.sender-name {
    color: #4a3728;
    font-weight: 600;
    font-size: 1rem;
}

.postcard-date-area {
    position: absolute;
    bottom: 8%;
    right: 5%;
    color: #8a7a6a;
    font-size: 0.85rem;
}

/* Postcard Image Preview */
.postcard-image-preview {
    max-width: 400px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    display: none;
}

.postcard-image-preview img {
    width: 100%;
    height: auto;
    display: block;
}

/* ============================================
   COMPOSE MODAL
   ============================================ */

.compose-modal {
    position: fixed;
    inset: 0;
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.compose-modal.active {
    display: flex;
}

.compose-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(10, 8, 6, 0.95);
    backdrop-filter: blur(10px);
}

.compose-container {
    position: relative;
    background: linear-gradient(165deg, #2a2520, #1a1510);
    border-radius: 24px;
    padding: 40px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(181, 96, 11, 0.25);
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
}

.compose-header {
    display: flex;
    align-items: center;
    gap: 18px;
    margin-bottom: 35px;
}

.compose-header svg {
    stroke: #d1872c;
}

.compose-header h2 {
    color: white;
    font-size: 1.6rem;
    margin: 0;
}

/* Steps */
.compose-step {
    animation: fadeIn 0.3s ease;
}

.step-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.step-back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
    font-size: 0.9rem;
}

.step-back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.step-header span {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.95rem;
}

/* Visibility Selector */
.visibility-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 30px;
}

.visibility-option {
    padding: 25px 20px;
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 12px;
}

.visibility-option svg {
    stroke: rgba(255, 255, 255, 0.4);
}

.visibility-option span {
    color: white;
    font-weight: 600;
    font-size: 1rem;
}

.visibility-option small {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

.visibility-option:hover {
    background: rgba(181, 96, 11, 0.1);
    border-color: rgba(181, 96, 11, 0.3);
}

.visibility-option.active {
    background: rgba(181, 96, 11, 0.15);
    border-color: #b5600b;
}

.visibility-option.active svg {
    stroke: #ffc168;
}

/* Recipient Section */
.recipient-section {
    margin-bottom: 30px;
}

.recipient-section label {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 12px;
    font-size: 0.95rem;
}

.recipient-input-container {
    position: relative;
    display: flex;
    align-items: center;
}

.recipient-input-container svg {
    position: absolute;
    left: 16px;
    stroke: rgba(255, 255, 255, 0.4);
    pointer-events: none;
}

.recipient-input-container input {
    width: 100%;
    padding: 14px 14px 14px 48px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 1rem;
    font-family: inherit;
}

.recipient-input-container input:focus {
    outline: none;
    border-color: #b5600b;
    background: rgba(0, 0, 0, 0.35);
}

.recipient-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #2a2520;
    border: 1px solid rgba(181, 96, 11, 0.3);
    border-radius: 12px;
    margin-top: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
}

.suggestion-item {
    display: flex;
    justify-content: space-between;
    padding: 14px 18px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover {
    background: rgba(181, 96, 11, 0.15);
}

.suggestion-name {
    color: white;
    font-weight: 500;
}

.suggestion-category {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.8rem;
}

.step-next-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 14px;
    color: white;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
}

.step-next-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(181, 96, 11, 0.4);
}

.step-next-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Card Type Tabs */
.card-type-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
}

.card-type-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
    font-size: 0.9rem;
}

.card-type-tab.active {
    background: rgba(181, 96, 11, 0.2);
    border-color: #b5600b;
    color: white;
}

.card-type-tab.active svg {
    stroke: #ffc168;
}

/* Card Search */
.card-search {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    margin-bottom: 18px;
}

.card-search svg {
    stroke: rgba(255, 255, 255, 0.4);
    flex-shrink: 0;
}

.card-search input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 0.95rem;
    font-family: inherit;
}

.card-search input:focus {
    outline: none;
}

/* Cards Grid */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 12px;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
    padding: 5px;
}

.card-option {
    position: relative;
    aspect-ratio: 4/3;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
    background: rgba(0, 0, 0, 0.3);
}

.card-option:hover {
    border-color: rgba(181, 96, 11, 0.5);
    transform: scale(1.05);
}

.card-option img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(181, 96, 11, 0.1);
}

.card-placeholder svg {
    stroke: rgba(255, 255, 255, 0.2);
}

.card-number {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 5px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    font-size: 0.7rem;
    text-align: center;
}

/* Selected Card Preview */
.selected-card-preview {
    display: flex;
    align-items: center;
    gap: 18px;
    padding: 18px;
    background: rgba(181, 96, 11, 0.1);
    border: 1px solid rgba(181, 96, 11, 0.3);
    border-radius: 14px;
    margin-bottom: 20px;
}

.selected-card-preview img {
    width: 100px;
    height: 75px;
    object-fit: cover;
    border-radius: 8px;
}

.preview-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.preview-info span {
    color: white;
    font-size: 0.95rem;
}

.change-card-btn {
    align-self: flex-start;
    padding: 8px 18px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
    font-family: inherit;
}

.change-card-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

/* ============================================
   STEP 3: MESSAGE COMPOSITION
   ============================================ */

.compose-postcard-wrapper {
    perspective: 1000px;
    margin-bottom: 20px;
}

.compose-postcard {
    position: relative;
    width: 100%;
    max-width: 550px;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.4),
        0 0 0 3px rgba(181, 96, 11, 0.2);
    transition: transform 0.3s;
}

.compose-postcard:hover {
    transform: rotateX(2deg) rotateY(-1deg);
}

.compose-postcard-bg {
    width: 100%;
    height: auto;
    display: block;
}

.compose-message-input {
    position: absolute;
    left: 2%;
    top: 38%;
    width: 48%;
    height: 45%;
    padding: 12px;
    background: transparent;
    border: none;
    resize: none;
    font-family: 'Dancing Script', cursive, Georgia, serif;
    font-size: 1rem;
    color: #4a3728;
    line-height: 1.5;
}

.compose-message-input:focus {
    outline: none;
}

.compose-message-input::placeholder {
    color: rgba(74, 55, 40, 0.4);
    font-style: italic;
}

.compose-stamp-area {
    position: absolute;
    top: 3%;
    right: 8%;
    width: 70px;
    height: 90px;
}

.stamp-placeholder {
    width: 100%;
    height: 100%;
    border: 2px dashed rgba(74, 55, 40, 0.3);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stamp-placeholder span {
    color: rgba(74, 55, 40, 0.4);
    font-size: 0.7rem;
}

.compose-stamp {
    width: 100%;
    height: auto;
    display: none;
    filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.3));
    animation: stampApply 0.4s ease;
}

@keyframes stampApply {
    0% { transform: scale(1.5) rotate(15deg); opacity: 0; }
    50% { transform: scale(1.1) rotate(-5deg); }
    100% { transform: scale(1) rotate(0); opacity: 1; }
}

.compose-signature-area {
    position: absolute;
    right: 5%;
    top: 40%;
    width: 45%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.signature-placeholder {
    padding: 25px;
    border-bottom: 2px dashed rgba(74, 55, 40, 0.3);
    text-align: center;
    width: 80%;
}

.signature-placeholder span {
    color: rgba(74, 55, 40, 0.4);
    font-size: 0.8rem;
}

.compose-signature {
    max-width: 130px;
    max-height: 55px;
    display: none;
    animation: signatureWrite 0.6s ease;
}

@keyframes signatureWrite {
    0% { opacity: 0; transform: translateX(-20px); clip-path: inset(0 100% 0 0); }
    100% { opacity: 1; transform: translateX(0); clip-path: inset(0 0 0 0); }
}

/* Compose Char Info */
.compose-char-info {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.9rem;
    margin-bottom: 12px;
}

.compose-instructions {
    text-align: center;
    color: rgba(255, 200, 150, 0.6);
    font-style: italic;
    font-size: 0.9rem;
    margin-bottom: 25px;
}

/* Compose Elements */
.compose-elements {
    display: flex;
    flex-direction: column;
    gap: 25px;
    padding: 25px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 16px;
    margin-bottom: 25px;
}

.stamps-selection, .signature-selection {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.selection-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.stamps-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
}

.stamp-choice {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.stamp-choice img {
    height: 60px;
    width: auto;
    filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.3));
    transition: transform 0.3s;
}

.stamp-choice span {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.8rem;
}

.stamp-choice:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.4);
}

.stamp-choice:hover img {
    transform: translateY(-5px) scale(1.1);
}

.stamp-choice.selected {
    background: rgba(181, 96, 11, 0.2);
    border-color: #b5600b;
}

.stamp-choice.selected span {
    color: #ffc168;
}

.user-signature-preview, .default-signature-option {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    margin-right: 12px;
    margin-bottom: 10px;
}

.user-signature-preview img, .default-signature-option img {
    height: 35px;
    width: auto;
}

.user-signature-preview span, .default-signature-option span {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
}

.user-signature-preview:hover, .default-signature-option:hover {
    background: rgba(181, 96, 11, 0.15);
    border-color: rgba(181, 96, 11, 0.4);
}

.no-signature-msg {
    display: inline-block;
    margin-right: 15px;
}

.no-signature-msg a {
    color: #d1872c;
    text-decoration: none;
    font-size: 0.9rem;
}

.no-signature-msg a:hover {
    text-decoration: underline;
}

/* Send Button */
.send-postcard-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, #888, #666);
    border: none;
    border-radius: 14px;
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: not-allowed;
    opacity: 0.5;
    transition: all 0.4s;
    font-family: inherit;
}

.send-postcard-btn:not(:disabled) {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    cursor: pointer;
    opacity: 1;
    box-shadow: 0 6px 25px rgba(181, 96, 11, 0.4);
    animation: sendPulse 2s infinite;
}

@keyframes sendPulse {
    0%, 100% { box-shadow: 0 6px 25px rgba(181, 96, 11, 0.4); }
    50% { box-shadow: 0 10px 40px rgba(181, 96, 11, 0.6); }
}

.send-postcard-btn:not(:disabled):hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(181, 96, 11, 0.5);
}

/* Success Notification */
.success-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: linear-gradient(165deg, #2a2520, #1a1510);
    padding: 50px 60px;
    border-radius: 24px;
    text-align: center;
    z-index: 6000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s ease;
    border: 2px solid rgba(74, 222, 128, 0.4);
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
}

.success-notification.show {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

.success-icon {
    width: 90px;
    height: 90px;
    margin: 0 auto 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 197, 94, 0.1));
    border-radius: 50%;
}

.success-icon svg {
    stroke: #4ade80;
}

.success-notification h3 {
    color: #4ade80;
    font-size: 1.6rem;
    margin-bottom: 12px;
}

.success-notification p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    top: 90px;
    right: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 25px;
    border-radius: 12px;
    color: white;
    z-index: 7000;
    transform: translateX(120%);
    transition: transform 0.3s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.toast-notification.show {
    transform: translateX(0);
}

.toast-notification.toast-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.toast-notification.toast-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

/* Animations */
.animate-fade-in-down {
    animation: fadeInDown 0.7s ease forwards;
    opacity: 0;
}

.animate-fade-in-up {
    animation: fadeInUp 0.7s ease forwards;
    opacity: 0;
}

.animate-fade-in {
    animation: fadeIn 0.7s ease forwards;
    opacity: 0;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-25px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 768px) {
    .poste-header h1 {
        font-size: 2rem;
    }
    
    .poste-tabs {
        flex-direction: column;
        align-items: stretch;
    }
    
    .tab-btn {
        justify-content: center;
    }
    
    .postcards-grid {
        grid-template-columns: 1fr;
    }
    
    .compose-container {
        padding: 25px 20px;
    }
    
    .visibility-selector {
        grid-template-columns: 1fr;
    }
    
    .compose-postcard {
        max-width: 100%;
    }
    
    .compose-message-input {
        font-size: 0.9rem;
    }
    
    .stamps-row {
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .action-btn {
        padding: 14px 25px;
        font-size: 1rem;
    }
    
    .modal-close-btn {
        width: 45px;
        height: 45px;
        top: 10px;
        right: 10px;
    }
}
</style>
{% endblock %}