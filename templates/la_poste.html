<!-- templates/la_poste.html -->
{% extends 'base.html' %}
{% load static %}

{% block page_title %}La Poste{% endblock %}

{% block content %}
<div class="la-poste-page">
    <!-- Background -->
    <div class="poste-background">
        <div class="bg-gradient"></div>
        <div class="floating-stamps" id="floating-stamps"></div>
    </div>

    <div class="poste-container">
        <!-- Header -->
        <header class="poste-header animate-fade-in-down">
            <div class="header-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>
            <h1>La Poste</h1>
            <p>Envoyez des cartes postales et partagez vos d√©couvertes</p>
            
            {% if unread_count > 0 %}
            <div class="unread-badge">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
                {{ unread_count }} nouvelle{{ unread_count|pluralize }} carte{{ unread_count|pluralize }}
            </div>
            {% endif %}
        </header>

        <!-- Main Actions -->
        <div class="poste-actions animate-fade-in-up delay-1">
            <button class="action-btn primary" onclick="openComposeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
                <span>√âcrire une carte</span>
            </button>
        </div>

        <!-- Tabs -->
        <div class="poste-tabs animate-fade-in delay-2">
            <button class="tab-btn active" data-tab="received" onclick="switchTab('received')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                    <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                </svg>
                Re√ßues
                {% if unread_count > 0 %}
                <span class="tab-badge">{{ unread_count }}</span>
                {% endif %}
            </button>
            <button class="tab-btn" data-tab="sent" onclick="switchTab('sent')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Envoy√©es
            </button>
            <button class="tab-btn" data-tab="wall" onclick="switchTab('wall')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Mur Public
            </button>
        </div>

        <!-- Content Sections -->
        <div class="poste-content">
            <!-- Received Tab -->
            <div class="tab-content active" id="received-tab">
                <div class="postcards-grid" id="received-grid">
                    {% for postcard in received_postcards %}
                    <div class="postcard-item {% if not postcard.is_read %}unread{% endif %}" 
                         data-id="{{ postcard.id }}"
                         onclick="openPostcardModal({{ postcard.id }}, 'received')">
                        <div class="postcard-image">
                            {% if postcard.get_image_url %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale">
                            {% else %}
                            <div class="no-image">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </div>
                            {% endif %}
                            {% if not postcard.is_read %}
                            <div class="new-badge">Nouveau</div>
                            {% endif %}
                        </div>
                        <div class="postcard-info">
                            <div class="postcard-sender">
                                <div class="sender-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <span>{{ postcard.sender.username }}</span>
                            </div>
                            <p class="postcard-preview">{{ postcard.message|truncatechars:60 }}</p>
                            <span class="postcard-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                            <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
                        </svg>
                        <h3>Pas de cartes re√ßues</h3>
                        <p>Invitez vos amis √† vous envoyer des cartes postales!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Sent Tab -->
            <div class="tab-content" id="sent-tab">
                <div class="postcards-grid" id="sent-grid">
                    {% for postcard in sent_postcards %}
                    <div class="postcard-item" 
                         data-id="{{ postcard.id }}"
                         onclick="openPostcardModal({{ postcard.id }}, 'sent')">
                        <div class="postcard-image">
                            {% if postcard.get_image_url %}
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale">
                            {% else %}
                            <div class="no-image">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </div>
                            {% endif %}
                            {% if postcard.visibility == 'public' %}
                            <div class="public-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            {% endif %}
                        </div>
                        <div class="postcard-info">
                            <div class="postcard-recipient">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13"/>
                                    <path d="M22 2L15 22 11 13 2 9 22 2z"/>
                                </svg>
                                {% if postcard.recipient %}
                                <span>√Ä {{ postcard.recipient.username }}</span>
                                {% else %}
                                <span>Publication publique</span>
                                {% endif %}
                            </div>
                            <p class="postcard-preview">{{ postcard.message|truncatechars:60 }}</p>
                            <span class="postcard-date">{{ postcard.created_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        <h3>Aucune carte envoy√©e</h3>
                        <p>Envoyez votre premi√®re carte postale!</p>
                        <button class="btn-primary" onclick="openComposeModal()">√âcrire une carte</button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Wall Tab -->
            <div class="tab-content" id="wall-tab">
                <div class="wall-feed" id="wall-feed">
                    {% for postcard in public_postcards %}
                    <div class="wall-post" data-id="{{ postcard.id }}">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">
                                    {% if postcard.sender.signature_image %}
                                    <img src="{{ postcard.sender.signature_image.url }}" alt="">
                                    {% else %}
                                    {{ postcard.sender.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <div class="author-info">
                                    <span class="author-name">{{ postcard.sender.username }}</span>
                                    <span class="post-date">{{ postcard.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                            </div>
                        </div>
                        
                        {% if postcard.get_image_url %}
                        <div class="post-image">
                            <img src="{{ postcard.get_image_url }}" alt="Carte postale">
                        </div>
                        {% endif %}
                        
                        <div class="post-content">
                            <p>{{ postcard.message }}</p>
                        </div>
                        
                        <div class="post-actions">
                            <button class="post-action-btn" onclick="toggleComments({{ postcard.id }})">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <span>{{ postcard.comments.count }} commentaire{{ postcard.comments.count|pluralize }}</span>
                            </button>
                        </div>
                        
                        <div class="post-comments" id="comments-{{ postcard.id }}" style="display: none;">
                            <div class="comments-list">
                                {% for comment in postcard.comments.all %}
                                <div class="comment">
                                    <span class="comment-author">{{ comment.user.username }}</span>
                                    <p>{{ comment.message }}</p>
                                    <span class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <form class="comment-form" onsubmit="addComment(event, {{ postcard.id }})">
                                <input type="text" placeholder="√âcrire un commentaire..." maxlength="500" required>
                                <button type="submit">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"/>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <h3>Le mur est vide</h3>
                        <p>Soyez le premier √† publier une carte!</p>
                        <button class="btn-primary" onclick="openComposeModal()">Publier une carte</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compose Modal -->
<div class="compose-modal" id="composeModal">
    <div class="modal-backdrop" onclick="closeComposeModal()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeComposeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <h2>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
            </svg>
            √âcrire une carte postale
        </h2>
        
        <form id="composeForm" onsubmit="sendPostcard(event)">
            <!-- Visibility Toggle -->
            <div class="visibility-toggle">
                <button type="button" class="visibility-btn active" data-visibility="private" onclick="setVisibility('private')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Priv√©
                </button>
                <button type="button" class="visibility-btn" data-visibility="public" onclick="setVisibility('public')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    Public
                </button>
            </div>
            
            <!-- Recipient (for private) -->
            <div class="form-group" id="recipientGroup">
                <label>Destinataire</label>
                <div class="recipient-input-wrapper">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <input type="text" id="recipientInput" placeholder="Nom d'utilisateur..." autocomplete="off">
                    <div class="user-suggestions" id="userSuggestions"></div>
                </div>
            </div>
            
            <!-- Postcard Selection -->
            <div class="form-group">
                <label>Choisir une carte (optionnel)</label>
                <div class="postcard-selector" id="postcardSelector">
                    <div class="selector-preview" onclick="openPostcardPicker()">
                        <div class="preview-placeholder" id="previewPlaceholder">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                            <span>Choisir une carte</span>
                        </div>
                        <img id="selectedPostcardPreview" style="display: none;">
                    </div>
                </div>
            </div>
            
            <!-- Message -->
            <div class="form-group">
                <label>Votre message</label>
                <textarea id="messageInput" placeholder="√âcrivez votre message..." maxlength="1000" required></textarea>
                <span class="char-count"><span id="msgCharCount">0</span>/1000</span>
            </div>
            
            <!-- Signature Preview -->
            {% if user.signature_image %}
            <div class="signature-preview-compose">
                <span>Votre signature :</span>
                <img src="{{ user.signature_image.url }}" alt="Signature">
            </div>
            {% endif %}
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeComposeModal()">Annuler</button>
                <button type="submit" class="btn-send">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Envoyer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Postcard Picker Modal -->
<div class="picker-modal" id="pickerModal">
    <div class="modal-backdrop" onclick="closePostcardPicker()"></div>
    <div class="modal-content picker-content">
        <button class="modal-close" onclick="closePostcardPicker()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <h2>Choisir une carte postale</h2>
        
        <div class="picker-search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="pickerSearch" placeholder="Rechercher..." oninput="filterPostcards(this.value)">
        </div>
        
        <div class="picker-grid" id="pickerGrid">
            {% for postcard in available_postcards %}
            <div class="picker-item" 
                 data-id="{{ postcard.id }}"
                 data-title="{{ postcard.title|lower }}"
                 onclick="selectPostcard({{ postcard.id }}, '{{ postcard.vignette_url }}', '{{ postcard.title|escapejs }}')">
                <img src="{{ postcard.vignette_url }}" alt="{{ postcard.title }}">
                <span>N¬∞ {{ postcard.number }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- View Postcard Modal -->
<div class="view-modal" id="viewModal">
    <div class="modal-backdrop" onclick="closeViewModal()"></div>
    <div class="modal-content view-content">
        <button class="modal-close" onclick="closeViewModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        
        <div class="view-postcard">
            <div class="view-image">
                <img id="viewImage" src="" alt="Carte postale">
            </div>
            <div class="view-message">
                <div class="message-header">
                    <div class="message-from">
                        <span class="from-label">De</span>
                        <span class="from-name" id="viewSender"></span>
                    </div>
                    <span class="message-date" id="viewDate"></span>
                </div>
                <p class="message-text" id="viewMessage"></p>
                <div class="message-signature" id="viewSignature"></div>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let currentVisibility = 'private';
let selectedPostcardId = null;
let currentPostcardData = {};

// Tab switching
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tab + '-tab').classList.add('active');
}

// Compose Modal
function openComposeModal() {
    document.getElementById('composeModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeComposeModal() {
    document.getElementById('composeModal').classList.remove('active');
    document.body.style.overflow = '';
    resetComposeForm();
}

function resetComposeForm() {
    document.getElementById('composeForm').reset();
    document.getElementById('msgCharCount').textContent = '0';
    selectedPostcardId = null;
    document.getElementById('selectedPostcardPreview').style.display = 'none';
    document.getElementById('previewPlaceholder').style.display = 'flex';
    setVisibility('private');
}

function setVisibility(vis) {
    currentVisibility = vis;
    document.querySelectorAll('.visibility-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.visibility === vis);
    });
    document.getElementById('recipientGroup').style.display = vis === 'private' ? 'block' : 'none';
}

// User search
let searchTimeout;
document.getElementById('recipientInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        document.getElementById('userSuggestions').innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/users/search/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            const suggestions = document.getElementById('userSuggestions');
            suggestions.innerHTML = data.users.map(u => `
                <div class="suggestion-item" onclick="selectRecipient('${u.username}')">
                    <span class="suggestion-name">${u.username}</span>
                    <span class="suggestion-category">${u.category}</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
});

function selectRecipient(username) {
    document.getElementById('recipientInput').value = username;
    document.getElementById('userSuggestions').innerHTML = '';
}

// Character count
document.getElementById('messageInput').addEventListener('input', function() {
    document.getElementById('msgCharCount').textContent = this.value.length;
});

// Postcard picker
function openPostcardPicker() {
    document.getElementById('pickerModal').classList.add('active');
}

function closePostcardPicker() {
    document.getElementById('pickerModal').classList.remove('active');
}

function filterPostcards(query) {
    const items = document.querySelectorAll('.picker-item');
    query = query.toLowerCase();
    
    items.forEach(item => {
        const title = item.dataset.title;
        item.style.display = title.includes(query) ? '' : 'none';
    });
}

function selectPostcard(id, url, title) {
    selectedPostcardId = id;
    const preview = document.getElementById('selectedPostcardPreview');
    preview.src = url;
    preview.style.display = 'block';
    document.getElementById('previewPlaceholder').style.display = 'none';
    closePostcardPicker();
}

// Send postcard
async function sendPostcard(event) {
    event.preventDefault();
    
    const message = document.getElementById('messageInput').value.trim();
    const recipient = document.getElementById('recipientInput').value.trim();
    
    if (currentVisibility === 'private' && !recipient) {
        showNotification('Veuillez entrer un destinataire', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/la-poste/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                message,
                recipient: currentVisibility === 'private' ? recipient : null,
                visibility: currentVisibility,
                postcard_id: selectedPostcardId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            closeComposeModal();
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        showNotification('Erreur lors de l\'envoi', 'error');
    }
}

// View postcard
function openPostcardModal(id, type) {
    // Mark as read if received
    if (type === 'received') {
        fetch(`/api/la-poste/${id}/read/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        
        const item = document.querySelector(`.postcard-item[data-id="${id}"]`);
        if (item) item.classList.remove('unread');
    }
    
    // Get postcard data from DOM (simplified - in production, fetch from API)
    const item = document.querySelector(`.postcard-item[data-id="${id}"]`);
    if (!item) return;
    
    const img = item.querySelector('.postcard-image img');
    const sender = item.querySelector('.postcard-sender span, .postcard-recipient span');
    const message = item.querySelector('.postcard-preview');
    const date = item.querySelector('.postcard-date');
    
    document.getElementById('viewImage').src = img ? img.src : '';
    document.getElementById('viewSender').textContent = sender ? sender.textContent : '';
    document.getElementById('viewMessage').textContent = message ? message.textContent : '';
    document.getElementById('viewDate').textContent = date ? date.textContent : '';
    
    document.getElementById('viewModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeViewModal() {
    document.getElementById('viewModal').classList.remove('active');
    document.body.style.overflow = '';
}

// Comments
function toggleComments(id) {
    const comments = document.getElementById(`comments-${id}`);
    comments.style.display = comments.style.display === 'none' ? 'block' : 'none';
}

async function addComment(event, postcardId) {
    event.preventDefault();
    const input = event.target.querySelector('input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        const response = await fetch(`/api/la-poste/${postcardId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const list = document.querySelector(`#comments-${postcardId} .comments-list`);
            list.innerHTML += `
                <div class="comment">
                    <span class="comment-author">${data.comment.user}</span>
                    <p>${data.comment.message}</p>
                    <span class="comment-date">${data.comment.created_at}</span>
                </div>
            `;
            input.value = '';
        }
    } catch (error) {
        console.error('Comment error:', error);
    }
}

// Notifications
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'}
        </svg>
        ${message}
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Floating stamps animation
function createFloatingStamps() {
    const container = document.getElementById('floating-stamps');
    const stamps = ['üìÆ', '‚úâÔ∏è', 'üì¨', 'üíå', 'üìØ'];
    
    for (let i = 0; i < 15; i++) {
        const stamp = document.createElement('div');
        stamp.className = 'floating-stamp';
        stamp.textContent = stamps[Math.floor(Math.random() * stamps.length)];
        stamp.style.left = Math.random() * 100 + '%';
        stamp.style.animationDelay = Math.random() * 20 + 's';
        stamp.style.animationDuration = 15 + Math.random() * 10 + 's';
        container.appendChild(stamp);
    }
}

// Close on escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeComposeModal();
        closePostcardPicker();
        closeViewModal();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', createFloatingStamps);
</script>

<style>
.la-poste-page {
    min-height: 100vh;
    position: relative;
    padding: 80px 20px 60px;
}

.poste-background {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, #1a1208 0%, #2d1f0d 50%, #1a1208 100%);
    z-index: 0;
    overflow: hidden;
}

.bg-gradient {
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(circle at 30% 20%, rgba(181, 96, 11, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(181, 96, 11, 0.08) 0%, transparent 50%);
}

.floating-stamp {
    position: absolute;
    font-size: 2rem;
    opacity: 0.1;
    animation: float-up linear infinite;
    pointer-events: none;
}

@keyframes float-up {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 0.1; }
    90% { opacity: 0.1; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

.poste-container {
    position: relative;
    z-index: 1;
    max-width: 1000px;
    margin: 0 auto;
}

/* Header */
.poste-header {
    text-align: center;
    margin-bottom: 40px;
}

.header-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.2), rgba(181, 96, 11, 0.1));
    border-radius: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(181, 96, 11, 0.3);
}

.header-icon svg {
    stroke: #ffc168;
}

.poste-header h1 {
    font-size: 2.5rem;
    color: white;
    margin-bottom: 10px;
}

.poste-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
}

.unread-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    padding: 10px 20px;
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.1));
    border: 1px solid rgba(74, 222, 128, 0.4);
    border-radius: 25px;
    color: #4ade80;
    font-size: 0.95rem;
}

.unread-badge svg {
    stroke: #4ade80;
}

/* Actions */
.poste-actions {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 32px;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.3s;
}

.action-btn.primary {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    color: white;
    box-shadow: 0 8px 30px rgba(181, 96, 11, 0.4);
}

.action-btn.primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(181, 96, 11, 0.5);
}

/* Tabs */
.poste-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
}

.tab-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.tab-btn svg {
    stroke: rgba(255, 255, 255, 0.5);
}

.tab-btn:hover {
    background: rgba(181, 96, 11, 0.2);
    border-color: rgba(181, 96, 11, 0.4);
}

.tab-btn.active {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-color: #b5600b;
    color: white;
}

.tab-btn.active svg {
    stroke: white;
}

.tab-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    min-width: 20px;
    height: 20px;
    background: #4ade80;
    border-radius: 10px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1a1208;
    font-weight: 600;
}

/* Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Postcards Grid */
.postcards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.postcard-item {
    background: linear-gradient(165deg, rgba(40, 30, 20, 0.95), rgba(30, 20, 15, 0.98));
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.08);
    cursor: pointer;
    transition: all 0.3s;
}

.postcard-item:hover {
    transform: translateY(-5px);
    border-color: rgba(181, 96, 11, 0.4);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
}

.postcard-item.unread {
    border-color: rgba(74, 222, 128, 0.4);
}

.postcard-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    background: #1a1208;
}

.postcard-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.postcard-image .no-image {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(181, 96, 11, 0.1), rgba(181, 96, 11, 0.05));
}

.postcard-image .no-image svg {
    stroke: rgba(255, 255, 255, 0.2);
}

.new-badge, .public-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
}

.new-badge {
    background: #4ade80;
    color: #1a1208;
}

.public-badge {
    background: rgba(181, 96, 11, 0.9);
    color: white;
    display: flex;
    align-items: center;
    gap: 4px;
}

.postcard-info {
    padding: 15px;
}

.postcard-sender, .postcard-recipient {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.sender-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 600;
    color: white;
    overflow: hidden;
}

.sender-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.postcard-sender span, .postcard-recipient span {
    color: white;
    font-weight: 500;
}

.postcard-recipient svg {
    stroke: #b5600b;
}

.postcard-preview {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin: 0 0 10px;
    line-height: 1.4;
}

.postcard-date {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.8rem;
}

/* Wall Feed */
.wall-feed {
    max-width: 600px;
    margin: 0 auto;
}

.wall-post {
    background: linear-gradient(165deg, rgba(40, 30, 20, 0.95), rgba(30, 20, 15, 0.98));
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.post-header {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.post-author {
    display: flex;
    align-items: center;
    gap: 12px;
}

.author-avatar {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
    overflow: hidden;
}

.author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.author-info {
    display: flex;
    flex-direction: column;
}

.author-name {
    color: white;
    font-weight: 600;
}

.post-date {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

.post-image {
    aspect-ratio: 4/3;
    overflow: hidden;
}

.post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.post-content {
    padding: 15px;
}

.post-content p {
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.6;
    margin: 0;
}

.post-actions {
    padding: 10px 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.post-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
}

.post-action-btn:hover {
    background: rgba(181, 96, 11, 0.2);
    border-color: rgba(181, 96, 11, 0.4);
}

.post-comments {
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.comments-list {
    margin-bottom: 15px;
}

.comment {
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.comment:last-child {
    border-bottom: none;
}

.comment-author {
    color: #b5600b;
    font-weight: 600;
    font-size: 0.9rem;
}

.comment p {
    color: rgba(255, 255, 255, 0.8);
    margin: 5px 0;
    font-size: 0.9rem;
}

.comment-date {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.75rem;
}

.comment-form {
    display: flex;
    gap: 10px;
}

.comment-form input {
    flex: 1;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    color: white;
    font-size: 0.9rem;
}

.comment-form input:focus {
    outline: none;
    border-color: #b5600b;
}

.comment-form button {
    padding: 10px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
}

/* Empty State */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
}

.empty-state svg {
    stroke: rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
}

.empty-state h3 {
    color: white;
    margin-bottom: 10px;
}

.empty-state p {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 20px;
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    border-radius: 25px;
    color: white;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s;
}

/* Modals */
.compose-modal, .picker-modal, .view-modal {
    position: fixed;
    inset: 0;
    z-index: 5000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.compose-modal.active, .picker-modal.active, .view-modal.active {
    display: flex;
}

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
}

.modal-content {
    position: relative;
    background: linear-gradient(165deg, #252525, #1a1a1a);
    border-radius: 20px;
    padding: 35px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(181, 96, 11, 0.3);
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    padding: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    background: #b5600b;
}

.modal-content h2 {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    margin-bottom: 25px;
}

.modal-content h2 svg {
    stroke: #b5600b;
}

/* Compose Form */
.visibility-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.visibility-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
}

.visibility-btn.active {
    background: rgba(181, 96, 11, 0.3);
    border-color: #b5600b;
    color: white;
}

.visibility-btn.active svg {
    stroke: #ffc168;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.recipient-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.recipient-input-wrapper svg {
    position: absolute;
    left: 12px;
    stroke: rgba(255, 255, 255, 0.4);
}

.recipient-input-wrapper input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 0.95rem;
}

.recipient-input-wrapper input:focus {
    outline: none;
    border-color: #b5600b;
}

.user-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #252525;
    border: 1px solid rgba(181, 96, 11, 0.3);
    border-radius: 10px;
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
}

.suggestion-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 15px;
    cursor: pointer;
    transition: background 0.2s;
}

.suggestion-item:hover {
    background: rgba(181, 96, 11, 0.2);
}

.suggestion-name {
    color: white;
}

.suggestion-category {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

.postcard-selector {
    margin-bottom: 15px;
}

.selector-preview {
    width: 100%;
    aspect-ratio: 4/3;
    max-height: 200px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px dashed rgba(181, 96, 11, 0.4);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    overflow: hidden;
}

.selector-preview:hover {
    border-color: #b5600b;
    background: rgba(181, 96, 11, 0.1);
}

.preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: rgba(255, 255, 255, 0.5);
}

.preview-placeholder svg {
    stroke: rgba(255, 255, 255, 0.3);
}

#selectedPostcardPreview {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.form-group textarea {
    width: 100%;
    min-height: 120px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 0.95rem;
    resize: vertical;
    font-family: inherit;
}

.form-group textarea:focus {
    outline: none;
    border-color: #b5600b;
}

.char-count {
    display: block;
    text-align: right;
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.8rem;
    margin-top: 5px;
}

.signature-preview-compose {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(181, 96, 11, 0.1);
    border-radius: 10px;
    margin-bottom: 20px;
}

.signature-preview-compose span {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.signature-preview-compose img {
    max-height: 50px;
    border-radius: 5px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.btn-cancel, .btn-send {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cancel {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
}

.btn-send {
    background: linear-gradient(135deg, #b5600b, #d1872c);
    border: none;
    color: white;
}

/* Picker Modal */
.picker-content {
    max-width: 700px;
}

.picker-search {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    margin-bottom: 20px;
}

.picker-search svg {
    stroke: rgba(255, 255, 255, 0.4);
}

.picker-search input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 0.95rem;
}

.picker-search input:focus {
    outline: none;
}

.picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.picker-item {
    position: relative;
    aspect-ratio: 4/3;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.picker-item:hover {
    border-color: #b5600b;
    transform: scale(1.05);
}

.picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.picker-item span {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 5px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 0.75rem;
    text-align: center;
}

/* View Modal */
.view-content {
    max-width: 600px;
    padding: 0;
    overflow: hidden;
}

.view-postcard {
    display: flex;
    flex-direction: column;
}

.view-image {
    aspect-ratio: 4/3;
    overflow: hidden;
}

.view-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.view-message {
    padding: 25px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.message-from {
    display: flex;
    flex-direction: column;
}

.from-label {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

.from-name {
    color: #b5600b;
    font-weight: 600;
    font-size: 1.1rem;
}

.message-date {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.85rem;
}

.message-text {
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.7;
    font-size: 1rem;
    margin: 0;
}

.message-signature {
    margin-top: 20px;
    text-align: right;
}

.message-signature img {
    max-height: 60px;
}

/* Notifications */
.notification {
    position: fixed;
    top: 80px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 25px;
    border-radius: 10px;
    color: white;
    z-index: 6000;
    animation: slideIn 0.3s ease;
}

.notification-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.notification-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Animations */
.animate-fade-in-down { animation: fadeInDown 0.6s ease forwards; }
.animate-fade-in-up { animation: fadeInUp 0.6s ease forwards; }
.animate-fade-in { animation: fadeIn 0.6s ease forwards; }
[class*="animate-"] { opacity: 0; }
.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }

@keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Responsive */
@media (max-width: 768px) {
    .poste-tabs {
        flex-direction: column;
        align-items: stretch;
    }
    
    .postcards-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        padding: 25px 20px;
    }
    
    .picker-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>
{% endblock %}